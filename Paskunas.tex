\documentclass[leqno]{amsart}
\usepackage{amsmath} 
\usepackage{amssymb,mathtools,stmaryrd}
\usepackage{mathrsfs,euscript}
\usepackage[table,dvipsnames]{xcolor}
\usepackage{hyperref,tikz-cd,enumitem}
\usepackage[utf8]{inputenc}
\hypersetup{
 colorlinks=true,
 linkcolor=DarkOrchid,
 filecolor=blue,
 citecolor=olive,
 urlcolor=orange,
 pdftitle={Pask\={u}nas' theory},
}

\newcommand{\fix}[1]{\textcolor{Red}{#1}}

\setlength{\textwidth}{\paperwidth}
\addtolength{\textwidth}{-2in}
\calclayout

\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}
\newtheorem{ack}{Acknowledgement}

%%%%%%%%%% COMMONLY USED COMMAND %%%%%%%%%%%%%%%%

\newcommand{\smat}[1]{\left(\begin{smallmatrix} #1 \end{smallmatrix}\right)}
\newcommand{\id}{\mathbf{1}}
\newcommand{\oo}{\mathcal{O}} 
\newcommand{\eo}{\EuScript{O}}
\newcommand{\fF}{\mathbb{F}} % residue field

\newcommand{\Q}{{\mathbf{Q}}}
\newcommand{\Z}{{\mathbf{Z}}}
\newcommand{\Qp}{\mathbf{Q}_p}
\newcommand{\Zp}{\mathbf{Z}_p}
\newcommand{\Ql}{\mathbf{Q}_\ell}
\newcommand{\Zl}{\mathbf{Z}_\ell}
\newcommand{\R}{\mathbf R}
\newcommand{\C}{\mathbf C}
\newcommand{\A}{\mathbf A}
\newcommand{\dd}{\mathfrak{d}} %different
\newcommand{\DD}{\mathcal{D}}  %discriminant
\newcommand{\Cl}{Cl} %class_group
\newcommand{\arch}{\mathbf{a}}
\newcommand{\finite}{\mathbf{h}}
\DeclareMathOperator{\Nr}{N}
\DeclareMathOperator{\Tr}{Tr}

\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Ext}{Ext}
\DeclareMathOperator{\Tor}{Tor}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\cInd}{c-Ind}
\DeclareMathOperator{\nInd}{n-Ind}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\Cor}{Cor}
\DeclareMathOperator{\Image}{Im}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\corank}{corank}

\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\Ad}{Ad}

\DeclareMathOperator{\Lie}{Lie}
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\SL}{SL}
\DeclareMathOperator{\UU}{U}
\DeclareMathOperator{\gl}{\mathfrak{gl}}
\DeclareMathOperator{\mtr}{tr}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\chr}{char} 

\DeclareMathOperator{\vol}{vol} %volume
\DeclareMathOperator{\val}{val} %valuation
\DeclareMathOperator{\ind}{ind} %index
\DeclareMathOperator{\odr}{ord} %order

\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\Supp}{Supp}
\DeclareMathOperator{\Ass}{Ass}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Der}{Der}
\DeclareMathOperator{\Fitt}{Fitt}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\length}{length}

\DeclareMathOperator{\Gal}{\mathcal{G}}
\DeclareMathOperator{\WD}{WD}
\DeclareMathOperator{\Rec}{Rec}
\DeclareMathOperator{\rec}{rec}
\DeclareMathOperator{\Art}{Art}
\newcommand{\Fr}{\textnormal{Fr}} %geometric Frobenius
\newcommand{\frob}{\textnormal{frob}} %arithmetic Frobenius
\newcommand{\dR}{\textnormal{dR}}
\newcommand{\pst}{\textnormal{pst}}
\newcommand{\st}{\textnormal{st}}
\newcommand{\cris}{\textnormal{cris}}

\newcommand{\cont}{\textnormal{cont}}
\newcommand{\cts}{\textnormal{cts}}

\newcommand{\fa}{\mathfrak{a}}
\newcommand{\fc}{\mathfrak{c}}
\newcommand{\ff}{\mathfrak{f}}
\newcommand{\fg}{\mathfrak{g}}
\newcommand{\fk}{\mathfrak{k}}
\newcommand{\fl}{\mathfrak{l}}
\newcommand{\fm}{\mathfrak{m}}
\newcommand{\fn}{\mathfrak{n}}
\newcommand{\fp}{\mathfrak{p}}
\newcommand{\fq}{\mathfrak{q}}
\newcommand{\fs}{\mathfrak{s}}
\newcommand{\ft}{\mathfrak{t}}

%%%%%%%%%% MORE SPECIFIC COMMAND %%%%%%%%%%%%%%%%

\newcommand{\bs}{\mathcal{S}} %Bruhat-Shwartz

%%% p-adic local Langlands

\DeclareMathOperator{\Mod}{\textnormal{Mod}}
\DeclareMathOperator{\laMod}{\textnormal{Mod}^{\textnormal{l.adm}}}
\DeclareMathOperator{\aMod}{\textnormal{Mod}^{\textnormal{adm}}}
\DeclareMathOperator{\fgMod}{\textnormal{Mod}^{\textnormal{fg.aug}}}
\DeclareMathOperator{\fC}{\mathfrak{C}} %dual category
\DeclareMathOperator{\Ban}{\textnormal{Ban}_{G,\zeta}^{\adm}}
\DeclareMathOperator{\Rep}{Rep}
\DeclareMathOperator{\V}{\check{\mathbf{V}}} %Colmez's functor
\DeclareMathOperator{\Ord}{Ord} %Emerton's functor
\DeclareMathOperator{\Irr}{Irr}
\DeclareMathOperator{\soc}{soc}

\newcommand{\Gp}{\mathcal{G}_{\Qp}} %Galois group over \Qp
\newcommand{\B}{\mathfrak B} %Paskunas' Block

\newcommand{\sm}{\textnormal{sm}}
\newcommand{\adm}{\textnormal{adm}}
\newcommand{\lfin}{\textnormal{lfin}}
\newcommand{\ps}{\textnormal{ps}}
\newcommand{\red}{\textnormal{red}}

\newcommand{\xx}{x_\textnormal{red}}

%%% Number Fields

\newcommand{\F}{{\mathcal{F}}} %global totally real
\newcommand{\K}{{\mathcal{K}}} %global CM
\newcommand{\qch}{\epsilon} % quadratic character of K/F
\newcommand{\bw}{\overline{w}}
\newcommand{\flw}{\bar{\fl}}

\newcommand{\cG}{\mathcal{G}}
\newcommand{\fG}{\mathfrak{G}}
\newcommand{\fX}{\mathfrak{X}}


%%% Modular Forms

\newcommand{\wt}[1]{\underline{ #1 }}
\newcommand{\Iw}{\textnormal{Iw}} %Iwahori subgroup
\newcommand{\TT}{\mathbb{T}} % Hecke algebra
\newcommand{\euF}{\EuScript{F}} %Hida family
\newcommand{\I}{\mathcal{I}} %lCN flat over Lambda
\newcommand{\ord}{\textnormal{ord}} %ordinary


%%% Galois cohomology

\DeclareMathOperator{\loc}{loc} 
\DeclareMathOperator{\Sel}{Sel} 
\DeclareMathOperator{\car}{char} 
\newcommand{\lin}[1]{\mathcal{L}^{(#1)}} 
\newcommand{\Lda}[1]{\Lambda^{(#1)}} 

\begin{document}
\title{Pask\={u}nas' theory}
\author[Y-S.~Lee]{Yu-Sheng Lee}
\address{Department of Mathematics, University  of Michigan, Ann Arbor, MI 48109, USA}
\email{yushglee@umich.edu}
\date{\today}

\maketitle
\setcounter{tocdepth}{1}
\tableofcontents

\section{Notations}

Throughout the article, $\F$ is a totally real field
and $\K$ is a totally imaginary quadratic extension over $\F$.
Denote by $\arch=\Hom(\F, \C)$ 
the set of archimedean places of $\F$,
and by $\finite$ the set of finite places of $\F$.

We fix an odd prime $p$ throughout the article
that satisfies the following ordinary condition.
\begin{equation}\label{cond:ord}\tag{ord}
\text{Every finite place of $\F$ above $p$ is split in $\K$}.
\end{equation}
We fix an embedding $\iota_\infty:\bar{\Q}\to \C$
and an isomorphism $\iota:\C\cong \C_p$,
and write $\iota_p=\iota\circ\iota_\infty:\bar{\Q}\to \C_p$.


Given a place $v$ of $\F$, archimedean or finite,
let $w\mid v$ denote a place $w$ of $\K$ above $v$.
Then $\K_w$ and $\F_v$ are respectively
the completions of the fields $\K$ and $\F$ at $w$ and $v$.
When $v\in \finite$ we denote by $\oo_w$ and $\oo_v$ 
the rings of integers of $\K_w$ and $\F_v$.
Let $|\cdot|_v$ be the norm on $\F_v$,
which is the usual absolute value when $v\in \arch$
and $q_v=|\varpi_v|_v^{-1}$,
for any choice of uniformizer $\varpi_v$ in $\oo_v$,
is the cardinality of the residue field $\oo_v/(\varpi_v)$
when $v\in \finite$.
For $w\mid v$, define $|a|_w=|\Nr_{\K_w/\F_v}(a)|_v$.


Denote by $\A=\A_{\F}$ the ring of adeles over $\F$,
by $\A_{\infty}$ and $\A_{f}$ respectively
the archimedean and the finite components of $\A$.
Let $\qch_{\K/\F}$ denote 
the quadratic character on $\A_\F^\times/\F^\times$
associated to $\K/\F$ by the global class field theory,
$\qch_v$ denote the component on $\F_v^\times$ 
when $v\in \finite$.
Let $c\in \Gal(\K/\F)$ be the unique complex conjugation.
When it should be clear from the context
we write $cz$, $z^c$ and $\bar{z}$ interchangeably 
for the action of $c$ on $z\in \K\otimes_\F R$, where $R$ is an $\F$-algebra,
induced by the action on the first factor.
We then define 
$\A_\K^1=\{z\in \A^\times_\K=\K\otimes_\F \A_\F \mid z\bar{z}=\Nr_{\K/\F}z=1\}$ and
$\K_v^1=\{z\in \K_v\coloneqq \K\otimes_\F\F_v\mid z\bar{z}=1\}$.
If $\eta$ is a character of $\A_\K^1/\K^1$, 
we denote
by $\tilde{\eta}(\alpha)\coloneqq \eta(\alpha/\alpha^c)$
the Hecke character which is the base change of $\eta$ 
to $\A_\K^\times/\K^\times$.

\subsection{CM types}

Denote respectively by $S_p$ and $S_p^\K$ the set of places above $p$
of $\F$ and $\K$.
Identify $I_\K=\Hom(\K,\bar{\Q})$ with
$\Hom(\K,\C)$ and $\Hom(\K,\C_p)$ by compositions with $\iota_\infty$ and $\iota_p$.
Given $\sigma\in I_\K$,
let $w_\sigma\in S_p^\K$ be the place induced by
$\sigma_p\coloneqq \iota_p\circ \sigma\in\Hom(\K,\C_p)$.
For $w\in S_p^\K$, define
\[
    I_w=\{\sigma\in I_\K\mid w=w_\sigma \}=\Hom(\K_w,\C_p)
\]
and decompose $I_\K=\sqcup_{w\mid p}I_w$.
For a subset $\Sigma\subset I_\K$
define $\Sigma_p=\{w_\sigma\mid \sigma\in \Sigma\}$.
We write
$\Sigma^c=\{\sigma c\mid \sigma\in \Sigma\}$ and 
$\Sigma_p^c=\{cw\mid w\in \Sigma_p\}$.
We fix throughout the article a $p$-ordinary CM type,
which is a subset $\Sigma\subset I_\K$ such that
\[
    \Sigma\sqcup \Sigma^c=I_\K,\quad
    \Sigma_p\sqcup \Sigma_p^c=S_p^\K.
\]
The $p$-ordinary CM type $\Sigma$
always exists by the assumption \eqref{cond:ord},
and is identified with $\arch=\Hom(\F,\C)$ by restrictions.
When $v\in S_p$ decomposes into $v=w\bw$,
we understand always that $w\in \Sigma_p$.

\subsection{Artin reciprocity}
We normalize the Artin reciprocity map
$\Art_w\colon \K_w^\times \to D_w^{\textnormal{ab}}$
so that $\Art_w(\varpi_w)=\Fr_w$
is the geometric Frobenius.

\subsection{Class groups}

When $\fs\subset\oo_\K$ is an ideal
we let $\cG_{\fs}$ denote the Galois group
of the maximal abelian extension over $\K$
that is unramified away primes dividing $p\fs$
and let $\fG_{\fs}$ be the maximal pro-$p$ quotient of which.
Moreover, when $\fs=\bar{\fs}$,
the complex conjugation $c\in \Gal(\K/\F)$
acts on $\cG_{\fs}$ and $\fG_{\fs}$ by conjugation.
Let $\cG_{\fs}^\pm=\{\gamma\in \cG_{\fs}\mid \gamma^c=\gamma^{\pm1}\}$.
We call $\cG_{\fs}^a\coloneqq \cG_{\fs}/\cG_{\fs}^+$
the anticyclotomic quotient of $\cG_{\fs}$, which can be 
identified with a subgroup of $\cG_{\fs}^-$ via the homomorphism
\[
    1-c\colon \cG_{\fs}\to \cG_{\fs}\quad \gamma\to \gamma/\gamma^c
\]
since $\cG_{\fs}^+=\ker(1-c)$ by definition.
We note that under the identification
$\cG_{\fs}^-/\cG_{\fs}^a$ is an abelian group of type $(2,\cdots,2)$.
In particular, 
if we define $\fG_{\fs}^{\pm}$ and $\fG_{\fs}^a$ similarly,
then $1-c\colon \fG_{\fs}^a\cong \fG_{\fs}^-$
when $p$ is odd.

Let $\rec\colon \K^\times\backslash\A_{\K,f}^\times \to \cG_{\fs}$
denote the reciprocity map,
which is normalized so that $\Fr_w\coloneqq \rec(\varpi_w)$
is the geometric Frobenius for each finite place $w$ of $\K$.
By abuse of notation, the homomorphism denoted by
\[
1-c\colon \K^\times\backslash\A_{\K,f}^\times\to
\K^\times\backslash\A_{\K,f}^\times\quad
z\mapsto z/\bar{z}
\]
which is compatible under the reciprocity map
with the homomorphism with the same name on the Galois side,
is an surjection on to the subgroup
$\K^1\backslash \A_{\K,f}^1$.
We then define the anticyclotimc
reciprocity map $\rec\colon \K^1\backslash\A_{\K,f}^1\to \cG_{\fs}^a$
by the commutative diagram
\begin{equation}\label{eq:anticyc_rec}
\begin{tikzcd}
    K^\times\backslash\A_{\K,f}^\times
    \arrow[r,twoheadrightarrow]\arrow[d,"\rec"]&
    K^1\backslash\A_{\K,f}^1 \arrow[r]\arrow[d,"\rec",dashed]&
    K^\times\backslash\A_{\K,f}^\times\arrow[d,"\rec"]\\
    \cG_{\fs} \arrow[r,twoheadrightarrow]&
    \cG_{\fs}^a\arrow[r]&
    \cG_{\fs}
\end{tikzcd}
\end{equation}


\subsection{Characters}
Given 
$\kappa=\sum_{\sigma\in \Sigma} a_\sigma\sigma+b_\sigma\sigma c\in \Z[I_\K]$,
an algebraic Hecke character 
$\chi\colon \A_\K^\times/\K^\times\to \C^\times$ 
has type $\kappa$ if
\[
    \chi_\infty(\alpha)=
    \iota_\infty \left(\prod_{\sigma\in \Sigma} 
    \sigma(\alpha)^{a_\sigma}\sigma(c \alpha)^{b_\sigma}\right),\quad
    \alpha\in \K^\times.
\]
For $\alpha_\infty=(\alpha_\sigma)\in \A_{\K,\infty}^\times$
and $\alpha_p=(\alpha_w,\alpha_{\bw})\in \prod_{v\in S_p}\K_v^\times$, 
define
\[
    \alpha_\infty^\kappa=
    \prod_{\sigma\in \Sigma} 
    (\alpha_\sigma)^{a_\sigma}(\bar{\alpha}_\sigma)^{b_\sigma}\in \C^\times,\quad
    \alpha_p^\kappa=
    \prod_{w\in \Sigma_p}
    \prod_{\sigma\in I_w}
    \sigma_p(\alpha_w)^{a_\sigma}\sigma_p(\alpha_{\bw})^{b_\sigma}\in \C_p^\times,
\]
for example,
$(2\pi)^\Sigma=(2\pi)^{[\F:\Q]}$
when $2\pi$ is embedded diagonally in $\A_{\K,\infty}^\times$.
Define the $p$-adic avatar of $\chi$ by
\[
    \hat{\chi}\colon \A_\K^\times\to \bar{\Z}_p^\times,\quad
    \hat{\chi}(\alpha)=\iota(\chi(\alpha)\alpha_\infty^{-\kappa})\alpha_p^{\kappa}
\]
where $\alpha_\infty$ and $\alpha_p$ are respectively 
the archimedean component and the components above $p$ of $\alpha\in \A_\K^\times$.


\subsection{Matrices}
When $R$ is an $\F$-algebra and 
$m=(m_{ij})\in \text{M}_{r,s}(\K\otimes_\F R)$,
we denote by 
$m^\intercal=(m_{ji}), 
m^c=(m^c_{ij})$, and
$m^*=(m^c_{ji})$
respectively the transpose, conjugate, and conjugate-transpose of $m$.

When $r=s$ and $g\in \GL_r(\K\otimes_\F R)$ is invertible, we write
$g^{-\intercal}=(g^{-1})^\intercal$ and $g^{-*}=(g^{-1})^*$.
We write $\mtr(m)$ for the trace of a square matrix $m$,
and reserve $\Tr$ for the traces between fields extensions.

When $v=w\bw$ is a place that is split in $\K$,
identify $\K_w=\F_v=\K_{\bw}$ and 
write $\K_v=\F_v^2$, 
where the first component corresponds to $\K_w$.
Then $m=(m_w,m_{\bw})\in M_n(\K\otimes_\F\F_v)=M_n(\F_v)\times M_n(\F_v)$ 
denotes an element in $m\in M_n(\K\otimes_\F\F_v)$ and its components.

\subsection{Representations of $p$-adic groups}

Let $\oo$ be the ring of integers of a finite extension $E$
over  $\Qp$.
When $G$ is a $p$-adic analytic group,
let $\Mod_G(\oo)$ be the category
of all $\oo[G]$-modules.
We refer the readers to \cite[\S 2]{emeI} and \cite[\S 2]{pask}
for the notations and definitions of the following subcategories.
\[
\begin{tikzcd}
	\fgMod_{G}(\oo) \arrow[r,leftrightarrow] &
	\laMod_{G}(\oo) \arrow[r,hookrightarrow] &
	\aMod_{G}(\oo) \arrow[r,hookrightarrow] &
	\Mod^{\sm}_{G}(\oo) \\
					       &&
	\Mod^{\lfin}_{G}(\oo) \arrow[ru,hookrightarrow] &
\end{tikzcd}
\]






\section{Modular forms on definite unitary groups}

Let $G$ be the definite unitary group over $\F$,
such that for any $\F$-algebra $R$
\begin{equation}\label{def:def_unitary}
    G(R)=\{g\in \GL_{n}(\K\otimes_\F R) \mid gg^*=\id_n\}.
\end{equation}
In this section we introduce
the space of algebraic modular forms on $G$
and their associated Galois representations
following \cite{ger}.
Moreover, for a general parabolic subgroup $P$,
we apply Emerton's functor of $P$-ordinary parts from \cite{emeI}
systematically and define 
the subspace of $P$-ordinary modular forms
and the big Galois pseudo-representation to 
the big $P$-ordinary Hecke algebra.
We also show the density of crystalline points 
in such big Hecke algebra
after incorporating the techniques developed in \cite{pan}.
The density result will be crucial for checking
the local-global compatibility in the next section.


\subsection{Algebraic modular forms}

Let $B_n=T_nN_n\subset \GL_n$ be the subgroup of
upper triangular matrices and its Levi decomposition,
where $T_n$ is the diagonal torus.
An element $w$ in the Weyl group $W_n$ of $\GL_n$
acts on $k\in X^*(T_n)$, the set of algebraic characters,
by $(wk)(t)=k(w^{-1}tw)$.
Following \cite[Def 2.3]{ger},
we identify $X^*(T_n)$ with $\Z^n$
and $k=(k_1,\cdots,k_n)\in X^*(T_n)$
is said to be dominant if $k_1\geq \cdots\geq k_n$.
Let $w_0\in W_n$ denote the longest element
and $k\in X^*(T_n)$ be dominant.
We define $\xi_k\coloneqq \Ind_{B_n}^{\GL_n}(w_0k)$,
which is an algebraic representation 
of highest weight $k$.

For each $v\in\finite$ that splits in $\K$
we fix a prime $w$ above $v$
and write $v=w\bw$ in $\K$.
Then we can write $g_v=(g_w,g_{\bw})$
for $g_v\in \GL_n(\F_v\otimes_\F\K)
\cong \GL_n(\K_w)\times\GL_n(\K_{\bw})$.
In particular, the map
\begin{equation}
\iota_w\colon G(\F_v)\to \GL_n(\K_w)\quad
\iota_w(g_v)=g_w
\end{equation}
is an isomorphism and satisfies
$\iota_w(g_v)=\iota_{\bw}(g_v)^{-\intercal}$.
We will identify $G_w\coloneqq\GL_n(\K_w)$
with $G(\F_v)$ via $\iota_w$
and similarly identify 
$B_w=B_n(\K_w), N_w=B_n(\K_w)$ and
$T_w=B_n(\K_w)$
with subgroups of $G(\F_v)$.
Moreover, we define the open 
compact subgroups
$K_w=\GL_n(\oo_w)$,
$\Iw(w)=\{k\in K_w\mid k\bmod \varpi_w\in B_n(\oo_w)\}$, and
$\Iw_1(w)=\{k\in \Iw(w)\mid k\bmod \varpi_w\in N_n(\oo_w)\}$.
In particular, we pick $w\in \Sigma_p$ when $v\in S_p$ and define
\[
	G_p\coloneqq\prod_{w\in \Sigma_p}G_w,\quad
	K_p\coloneqq\prod_{w\in \Sigma_p}K_w.
\]

Throughout the section
we fix a finite extension $E$ over $\Qp$
that contains $\iota_p(\sigma(\K))$
for all $\sigma\in I_\K$ and
let $\oo=\oo_E$ be the ring of integers in $E$.
When $\wt{k}=(k_\sigma)\in (\Z^n)^{\Sigma}$
is dominant in the sense that
$k_\sigma=(k_{\sigma,1},\cdots,k_{\sigma,n})$
is dominant for each $\sigma\in \Sigma$,
let $\xi_{\wt{k}}$ be
the algebraic $K_p$-representation over $\oo$ given by
\begin{equation}\label{def:algrep}
	\xi_{\wt{k}}=\bigotimes_{\sigma\in \Sigma}
	\Ind_{B_n}^{\GL_n}(w_0k_{\sigma}),\quad
	\xi_{\wt{k}}(g)=
	\otimes_{w\in \Sigma_p}
	\otimes_{\sigma\in I_w}\xi_{k_\sigma}(g_w)\,
	\text{ for } g=(g_w)\in K_p.
\end{equation}
Note that over $E$, the representation $\xi_{\wt{k}}$ 
is an algebraic $G_p$-representation.

\begin{rem}
    In \cite{lee} we have used  $\rho_k$ to denote
	the algebraic representation of lowest weight  $-k$.
	Thus $\xi_k$ is isomorphic to the representation 
	$\rho^k(g)\coloneqq \rho_k(g^{-\intercal})$.
\end{rem}




\begin{defn}\label{def:algform}
When $A$ is an $\oo$-module and  
$\wt{k}\in (\Z^n)^{\Sigma}$ is dominant,
we let $g=(g^p,g_p)\in G(\A_f^p)\times K_p$ acts on 
the space of functions
$f\colon G(\F)\backslash G(\A_f)\to A\otimes_{\oo}\xi_{\wt{k}}(\oo)$
by $(g\cdot f)(g_0)=\xi_{\wt{k}}(g_p)\cdot f(g_0g)$.
Note that the action can be extended to the whole $G(\A_f)$
when either $A$ is an $E$-module or $\xi_{\wt{k}}$
is the trivial representation.
We say such a function $f$ is an algebraic modular form of
weight $\wt{k}$ with coefficients in $A$
if $f$ is invariant under the above action 
by some open compact subgroup
$U\subset G(\A_f^p)\times K_p$.
Let $S_{\wt{k}}(A)$
denote the space of all algebraic modular forms
of weight $\wt{k}$ and coefficients in $A$.
And for $U$ as above we define
\begin{equation}
S_{\wt{k}}(U,A)=
S_{\wt{k}}(A)^U=
\left\{ f: G(\F)\backslash G(\A_f)/U^p 
\rightarrow A\otimes_{\oo}\xi_{\wt{k}}(\oo)
\mid f(gu)=\xi_{\wt{k}}(u_p)^{-1}\cdot f(g), u\in U\right\} 
\end{equation}
We will write $S(A)=S_{\wt{k}}(A)$ and
$S(A,U)=S_{\wt{k}}(A,U)$
when $\xi_{\wt{k}}$ is the trivial representation.
\end{defn}


Since $G(\F)\backslash G(\A_f)/U$ is a finite set
for any open compact subgroup $U\subset G(\A_f)$,
an algebraic modular form $f\in S_{\wt{k}}(U,A)$ 
is determined by its values on a finite set of points.
Moreover, throughout the section
we fix a finite subset $S\subset \finite$
of prime-to-$p$ places $v=w\bw$ that splits in $\K$
and an open compact subgroup $U^p=\prod_{v\nmid p}U_v\subset G(\A_f^p)$ 
that satisfies the following conditions.
\begin{align}
    \label{cond:s-ram}\tag{$S$-$\Iw$}
    &\Iw_1(w)\subset U_v \subset \Iw(w) \text{ for all } 
    v=S \text{ and the fixed }w\mid v\\
    \label{cond:small}\tag{\text{small}}
	&G(\F)\cap t_i(\tilde{U})t_i^{-1}=\{1\} \text{ for all } 
    i\in I \text{ in a fixed decomposition }
    G(\A_f)=\bigsqcup_{i\in I} G(\F)t_i \tilde{U}
\end{align}
Then by \cite[Lem 2.6]{ger} the space $S_{\wt{k}}(U^pU_p,A)$
is finite free over 
$A[\prod_{v\in S}(\Iw(w)/U_v)]$
whenever $A$ is an $\oo$-algebra
and $U^p\subset K_p$ is an open compact subgroup.

\subsection{Hecke operators}

Given integers $b$ and $c$
such that $c\geq b\geq 0$ and $c>0$,
we define the open compact subgroups
$\Iw(p^{b,c})=\prod_{w\in \Sigma_p}\Iw(w^{b,c})$ of $G_p$, where 
$\Iw(w^{b,c})$, for $w\in \Sigma_p$, is defined as
\begin{equation}\label{def:Iwahori}
	\Iw(w^{b,c})=\{
	k\in K_w\mid 
    k \bmod \varpi_w^c \in B_n(\oo/\varpi_w^c)
	\text{ and }
	k \bmod \varpi_w^b \in N_n(\oo/\varpi_w^b)
	\}.
\end{equation}

Let $T\subset\finite$ be a finite set containing $S_p\cup S$
such that $U_v=K_w$ if $v\notin T$ and $v$ splits in $\K$,
where $w$ is the fixed prime above $v$.
We recall from \cite{ger} 
the definitions of the following Hecke operators,
which are defined as double cosets operators
acting on $S_{\wt{k}}(U^p\Iw(p^{b,c}),A)$.
\begin{itemize}

\item 
If $v\notin T$ and $v=w\bw$ splits in $\K$,
for $1\leq j\leq n$ we define 
\begin{equation}\label{def:hecke_away_p}
	T_w^{(j)}=
	\left[
	K_w
	\begin{pmatrix}
		\varpi_w\id_{j}&\\&\id_{n-j}
	\end{pmatrix}
	K_w
	\right],
\end{equation}
which satisfies the relation
$T_{\bw}^{(j)}=(T_{w}^{{n}})^{-1}T_w^{(n-j)}$.

\item
If $w\in \Sigma_p$, let  
$\alpha_w^{(j)}=
\smat{ \varpi_v\id_{j}&\\&\id_{n-j} } $
for $1\leq j\leq n$
and $u\in T_n(\oo_w)$ we define
\begin{equation}\label{def:hecke_at_p}
	U_{\wt{k},w}^{(j)}=
	(w_0\wt{k})^{-1}(\alpha_{w}^{(j)})\cdot
	[\Iw(p^{b,c})\alpha_w^{(j)}\Iw(p^{b,c})],\,
	\langle u\rangle=
	[\Iw(p^{b,c})u\Iw(p^{b,c})],
	\text{ and }
	\langle u\rangle_{\wt{k}}= (w_0\wt{k})^{-1}(u)\cdot \langle u\rangle.
\end{equation}
Here $w_0\wt{k}$ is viewed as an algebraic character of $T_n(\F_w)$ 
by the same recipe in \eqref{def:algrep}.

\item 
If $v\in S$ and $w$ is the fixed place above $v$,
for $\alpha_w^{(j)}$ defined as above
and $u\in T_n(\oo_w)$ we define 
\begin{equation}\label{def:hecke_at_s}
	U_{w}^{(j)}=
	[U_v\alpha_w^{(j)}U_v]
	\text{ and }
	\langle u\rangle= 
	[U_vu U_v]
\end{equation}

\end{itemize}

\begin{rem}
For $u\in T_n(\oo_w)$ in either 
\eqref{def:hecke_at_p} or \eqref{def:hecke_at_s},
the operator $\langle u\rangle$
coincides with the usual action of $u$ in
Definition \ref{def:algform}.
Therefore the action of which
factors through the quotient by some 
open compact subgroup in $T_n(\oo_w)$.
On the other hand, 
we introduce $\langle u\rangle_{\wt{k}}$
in \eqref{def:hecke_at_p}
so that some Hecke-equivariant properties
are easier to state.
Also note that the two versions of diamond operators
coincide when $\xi_{\wt{k}}$ is the trivial representation,
so there is no confusion when we write
$U_{\wt{k},w}^{(j)}=U_{w}^{(j)}$ and 
$\langle u\rangle_{\wt{k}}=\langle u\rangle$ in such case.
\end{rem}





\subsection{The space of $P$-ordinary forms}



\subsubsection{Emerton's functor}

We temporarily let $G$ be an arbitrary $p$-adic reductive group
and $P=QU$ be a parabolic subgroup of $G$ and its Levi decomposition.
To recall the functor 
$\Ord_P\colon \Mod_G^{\sm}(\oo)\to \Mod_Q^{\sm}(\oo)$
defined in \cite{emeI},
we fix an open compact subgroup $P_0\subset P$
and put $Q_0=P_0\cap Q, U_0=P_0\cap U$,
then define $Z_Q^+=Z_Q\cap Q^+$,
where $Z_Q$ is the center of $Q$ and
\[
	Q^+=\{m\in Q\mid mU_0m^{-1}\subset U_0\}.
\]
If  $V$ is a $P$-representation over $\oo$
and  $m\in Q^+$,
we follow \cite[Def 3.1.3]{emeI} and define
\begin{equation}\label{def:hUm}
	 h_{U}(m)\colon V^{U_0}\to V^{U_0}\quad
	 h_{U}(m)(v)=\sum_{u\in U_0/m U_0 m^{-1}}um\cdot v
\end{equation}
Then the functor
$\Ord_P\colon \Mod_G^{\sm}(\oo)\to \Mod_Q^{\sm}(\oo)$
is define in \cite[Def 3.1.3]{emeI} by
\begin{equation}\label{def:OrdP}
	\Ord_P(V)=\Hom_{\oo[Z_Q^+]}
    (\oo[Z_Q], V^{U_0})_{Z_Q-\textnormal{fin}}.
\end{equation}
Here $\oo[Z_Q^+]$ is a $\oo[Z_Q^+]$-modules by translation
and $V^{U_0}$ is a $\oo[Z_Q^+]$-modules by $h_U$.
And the action of $Q=Z_Q\cdot Q^+$ on $\Ord_P(V)$ is defined by 
having $Z_Q$ act by translation on $\oo[Z_Q^+]$ and 
$Q^+$ act by $h_U$ on $V^{U_0}$.


\subsubsection{P-ordinary forms and Hecke algebras}

We now resume the earlier notations and
relate the Hecke operators in \eqref{def:hecke_at_p}
with the operators from \eqref{def:hUm}.

For each  $w\in \Sigma_p$ let $P_w=Q_wU_w\supset B_w$ 
be a standard parabolic subgroup
and its the Levi decomposition.
Define 
$P=\prod_{w\in \Sigma_p}P_w$, $Q=\prod_{w\in \Sigma_p}Q_w$, and
$U=\prod_{w\in \Sigma_p}U_w$.
Then $P=QU$ is a parabolic subgroup
of the $p$-adic group $G_p$ and $P_0=K_p\cap P$
is an open compact subgroup of $P$.
We then define $U_0, Z_Q, Q^+, Z_Q^+$ as above.
In particular when $P_w=B_w=T_wN_w$ for all $w\in\Sigma_p$
we have $N_0, Z_T=T$, and $T^+=Z_T^+$.

For integers $b$ and $c$ that satisfies $c\geq b\geq 0$ and $c>0$,
we define $\Iw^P(p^{b,c})=\prod_{w\in\Sigma_p}\Iw^P(w^{b,c})$ where
\begin{equation}\label{def:Iwahori_P}
	\Iw^P(w^{b,c})=\{
	k\in K_w\mid 
    k \bmod \varpi_w^c \in P_w(\oo/\varpi_w^c)
	\text{ and }
	k \bmod \varpi_w^b \in U_w(\oo/\varpi_w^b)
	\}.
\end{equation}


\begin{defn}\label{def:hecke}
Let the monoid $U_0T^+$ act on 
$f\in S_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)$ by
\begin{equation}\label{def:T_act}
	(ut* f)(g)=(w_0\wt{k})^{-1}(t)\cdot (ut\cdot f)(g)=
    (w_0\wt{k})^{-1}(t)\cdot \big(\xi_{\wt{k}}(ut)f(gut)\big)\quad
    u\in U_0, t\in T^+.
\end{equation}
Then for $\alpha_w^{(j)}$ and $u\in T_n(\oo_w)$ 
as in \eqref{def:hecke_at_p}
We define the Hecke operators on
$S_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)$ by
$U_{\wt{k},w}^{(j)}=h_U(\alpha_w^{(j)})$
and $\langle u\rangle_{\wt{k}}=h_U(u)$.
We also define $U_P$
as the product of all $U_{\wt{k},w}^{(j)}$
for which $\alpha_w^{(j)}\in Z_Q$.

In particular, when $P=B$
and $m\in T^+$ equals either $\alpha_{w}^{(j)}$ or $u\in T_w(\oo_w)$,
a set of representatives for $U_0/mU_0m^{-1}$
is also a set of representatives for 
$\Iw(p^{b,c})/m\Iw(p^{b,c})m^{-1}$
and consequently 
$h_N(\alpha_w^{(j)})$ and $h_N(u)$
coincide with the operators $U_{\wt{k},w}^{(j)}$ and 
$\langle u\rangle_{\wt{k}}$ in \eqref{def:hecke_at_p}.
\end{defn}

Aside from the Hecke operators defined above,
the operators from \eqref{def:hecke_at_p} and
\eqref{def:hecke_at_s} also 
acts on $S_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)$.

\begin{lem}
The Hecke operators commutes with each other
and are equivariant with respect to the inclusions
$ S_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)\hookrightarrow
S_{\wt{k}}(U^p\Iw^P(p^{b',c'}),A)$
if $b'\geq b$ and $c'\geq c$.
\end{lem}
\begin{proof}
That the operators $T_w^{(j)}$ from \eqref{def:hecke_away_p}
commutes with other Hecke operators is classical,
and the equivariance is clear.
For the Hecke operators at $p$,
the commutativity follows from \cite[Lem 3.1.4]{emeI},
and the equivariance follows from 
that of the action \eqref{def:T_act}.
See also \cite[Lem 2.10]{ger} for the proof when $P=B$.
Then the result also holds for the Hecke operators from 
\eqref{def:hecke_at_s}
since the set of representatives for the double cosets
in which can be chosen as those at $p$.
\end{proof}

From this point on,
we assume that $A$ is $E$, or a finite $\oo$-module,
or the Pontryagin dual of a finite $\oo$-module.
In particular, let $\varpi\in \oo$ be a uniformizer, $A$ could be 
$\oo, \oo/\varpi^n\oo, \varpi^{-n}\oo/\oo,$ or $E/\oo$.
Except when $A=E$,
the operator $e_P\coloneqq\lim_{n\to \infty}(U_P)^{n!}$
converges to an idempotent.
We then define the space of $P$-ordinary forms 
with coefficient in $A$ by
\[
	S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,c}),A)\coloneqq
	e_PS_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)
\]
and $S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,c}),E)\coloneqq 
S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,c}),\oo)\otimes_{\oo}E$.
Alternatively,
$S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,c}),A)$
is characterized as the subspace on which 
any  $U_{\wt{k},w}^{(j)}$ such that 
$\alpha_w^{(j)}\in Z_Q$ acts invertibly.
When $P=B$ we write 
$S_{\wt{k}}^{B-\ord}(U^p\Iw(p^{b,c}),A)=
S_{\wt{k}}^{\ord}(U^p\Iw(p^{b,c}),A)$,
which coincides with \cite[Def 2.13]{ger}.

\begin{defn}\label{def:ord_hecke}
	We let $\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)\subset 
    \End_{\oo}S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,c}),A)$
	be the $\oo$-subalgebra
	generated by all
	$T_w^{(j)}$, for $1\leq j\leq n$,
	and $(T_w^{(n)})^{-1}$ from \eqref{def:hecke_away_p};
	all $U_{\wt{k},w}^{(j)}$ and $\langle u\rangle_{\wt{k}}$
    from Definition \ref{def:hecke}
	for $\alpha_w^{(j)}$ belonging to $Z_Q$ and $u\in T_n(\oo_w)$;
    and all $\langle u\rangle$ from \eqref{def:hecke_at_s}.
    When $P=B$
    we write $\TT^{\ord}_{\wt{k}}(U^p\Iw(p^{b,c}),A)=
    \TT^B_{\wt{k}}(U^p\Iw(p^{b,c}),A)$.
\end{defn}

\begin{lem}\label{lem:control}
	The following natural inclusions are also surjective.
    In particular we may restrict ourselves 
    to modular forms of levels $\Iw^P(p^{b,b})$ or $\Iw^P(p^{0,1})$
    at $p$ when considering $P$-ordinary forms.
	\begin{align*}
	&S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),A)\hookrightarrow	
	S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,c}),A)\quad 
	\text{ for } c\geq b\geq 1\\
	&S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{0,1}),A)\hookrightarrow	
	S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{0,c}),A)\quad \text{ for } c\geq 1
	\end{align*}
\end{lem}
\begin{proof}
	It suffices to show that 
	$(U_P)^{n!}S_{\wt{k}}(U^p\Iw^P(p^{b,c}),A)
	\subset S_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)$
	for $n$ sufficiently large, 
	which follows from \cite[Lem 3.3.2]{emeI}
	since $\Iw^P(p^{b,c})$ admits Iwahori decompositions.
	The same argument also applies to 
	$S_{\wt{k}}(U^p\Iw^P(p^{0,c}),A)$.
	See also \cite[Lem 2.19]{ger} for the proof when $P=B$.
\end{proof}

\begin{lem}\label{lem:PtoB}
	For any $b\geq 1$
    the space $S_{\wt{k}}^{\ord}(U^p\Iw(p^{b,b}),A)$
    is a subspace of 
    $S_{\wt{k}}^{P-\ord}(U^p\Iw(p^{b,b}),A)$
	  and the inclusions
	$S_{\wt{k}}^{\ord}(U^p\Iw(p^{b,b}),A)\subset
	S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),A)$
    are equivariant with respect to the Hecke operators.
    In particular they induce homomorphisms of $\oo$-algebras
	\[
		\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)\to
		\TT^{\ord}_{\wt{k}}(U^p\Iw(p^{b,b}),A)
	\]
\end{lem}
\begin{proof}
	We have the natural inclusions
	$S_{\wt{k}}(U^p\Iw(p^{b,b}),A)\subset 
	S_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)$
	since $U\subset N$ and consequently 
    $\Iw^P(p^{b,b})\subset \Iw(p^{b,b})$.
    Thus the lemma follows if the inclusions
	are equivariant with respect to the Hecke operators.
	This is clear except for the operators 
    $U_{\wt{k},w}^{(j)}=h_U(\alpha)$
    in Definition \ref{def:hecke},
    for $\alpha=\alpha_w^{(j)}\in Z_Q$.
    In this case we need the observation that
    the set of representatives
	\[
	\begin{pmatrix}
		\id_j&X\\&\id_{n-j}
	\end{pmatrix},\quad
	X \text{ runs through a set of representatives of }
	M_{j,n-j}(\oo_w/\varpi_w)
	\]
    given in \cite[Lem 2.10]{ger} for $N_0/\alpha N_0\alpha^{-1}$
	is also a set of representatives for 
	$U_0/\alpha U_0\alpha^{-1}$.
\end{proof}

\subsection{Weights independence}

For a parabolic subgroup $P$ as introduced above,
we would like to compare the space of 
$P$-ordinary modular forms
of a domiant weight 
$\wt{k}=(k_\sigma)\in (\Z^n)^{\Sigma}$
and that of the trivial weight.
For each $w\in\Sigma_p$ and $\sigma\in I_w$
let $\pi_{k_{\sigma}}$ denote 
the algebraic $Q_w$-representation
$\Ind_{B_w\cap Q_w}^{Q_w}(w_0 k_\sigma)$
and let $\pi_{\wt{k}}$ be the $Q$-representation
as defined by the recipe in \eqref{def:algrep}.
Then $\pi_{\wt{k}}(\oo)$ is an algebraic representation on
$Q_0\coloneqq \Q\cap K_p$,
which we extends  to $P_0\coloneqq P\cap K_p$
via the projection $P=QU\to Q$.

Note that $\pi_{\wt{k}}$
is simply the character $w_0\wt{k}$
of $Q=T$ when $P=B$.
Therefore the following proposition can be seen as
a generalization of \cite[Prop 2.22]{ger}.

\begin{lem}
	Let $\pi_{\wt{k}}^*$ denote the contragredient
	representation and $A=\varpi^{-r}\oo/\oo$.
	For each $b\geq r$ there exists 
    the following isomorphism 
    which is equivariant with respect to the Hecke operators
    in Definition \ref{def:ord_hecke}.
	\[
		\epsilon_{\wt{k}} \colon 
		S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),A)\cong 
		\Hom_{\oo}(\pi_{\wt{k}}^*(\oo),
		S^{P-\ord}(U^p\Iw^P(p^{b,b}),A)).
	\]
	Moreover, the isomorphism is $Q_0$-equivariant 
    with respect to
	the action of $u\in Q_0$ defined as follows.
	\begin{align*}
	&u\cdot F(g)=\xi_{\wt{k}}(u)\cdot F(gu),\quad
	F(g)\in S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),A)\\
	&u\cdot \phi(v^*)(g)=
	\phi(\pi^*_{\wt{k}}(u^{-1})\cdot v^*)(gu),\quad
	\phi\in \Hom_{\oo}(\pi_{\wt{k}}^*(\oo),
	S^{P-\ord}(U^p\Iw^P(p^{b,b}),A))
	\end{align*}
\end{lem}

\begin{proof}
	By inductions in steps
	we can fix an isomorphism 
	$\xi_{\wt{k}}\cong \Ind_{P}^{G_p}\pi_{\wt{k}}$.
	Let $ev\colon \xi_{\wt{k}}\to \pi_{\wt{k}}$
	be the evaluation at the identity.
	For $F(g)\in S_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)$,
	we define 
	$\epsilon_{\wt{k}}(F)$ by
	\begin{equation}\label{eq:wt_indep}
	\epsilon_{\wt{k}}(F)\colon 
	\pi^*_{\wt{k}}(\oo)\rightarrow
	S(U^p\Iw^P(p^{b,b}),A)\quad
	v^*\mapsto [g\mapsto v^*(ev(F(g)))].
	\end{equation}
    As $b\geq r$,
	the action of $\Iw^P(p^{b,b})$ on 
	$A\otimes_{\oo}\pi_{\wt{k}}(\oo)$
	is trivial.
	Thus the function defined above is indeed 
	a modular form
	of trivial weight.
	That the map is equivariant with respect
    to the $Q_0$-actions
    follows from $ev\circ \xi_{\wt{k}}(u)=\pi_{\wt{k}}(u)\circ ev$
    when $u\in Q_0$.
    It is also straightforward that the map
    is equivariant with respect to the Hecke operators away $p$.
	For the Hecke operators at $p$,
    the equivariance follows from that 
    $(w_0\wt{k})^{-1}(z)\cdot ev\circ \xi_{\wt{k}}(z)=
    (w_0\wt{k})^{-1}(z)\cdot \pi_{\wt{k}}(z)\circ ev=
    ev$ when $z\in Z_Q$.


	To construct the reversed map,
	note that if $\mu$ is a weight character of $T$ in  
	$\pi_{\wt{k}}$, then it is also a weight character 
	of $T$ in $\xi_{\wt{k}}$.
	We fix weight vectors $v_\mu\in \xi_{\wt{k}}$
	and $v^*_\mu\in \pi_{\wt{k}}^*$
	such that $v^*_{\mu}(ev(v_\mu))=1$.
	Now, let $\alpha_P\in Z_Q^+$ be the product
	of all $\alpha_w^{(j)}\in Z_Q$ and $\alpha=\alpha_P^r$,
	Let $\{x_i\}_{i\in I}$
	be a set of represntatives 
	for $U_0/\alpha U_0\alpha^{-1}$,
	we put 
	\begin{align*}
		\varphi\colon 
		\Hom_{\oo}(\pi_{\wt{k}}^*(\oo),&
		S(U^p\Iw^P(p^{b,b}),A))\longrightarrow
		S_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)\\
		\phi&\mapsto 
		F_\phi(g)=\sum_{i\in I} \sum_{\mu}
		\phi(v^*_\mu)(gx_i\alpha)\otimes
		\xi_{\wt{k}}(x_i) v_\mu
	\end{align*}
	where $\mu$ runs through the weight characters in 
	$\pi_{\wt{k}}$.
	To show that the resulting function 
	defines a modular form,
	let $u\in \Iw^P(p^{b,b})$, 
	then as explained in \cite[Prop 2.22]{ger}
	there exists a bijection $i\mapsto i'$ of $I$
	such that 
	 \[
		ux_i=x_{i'}v_i,\quad
		v_i\in\alpha\Iw^P(p^{b,b})\alpha^{-1} 
		\cap \Iw^P(p^{b,b})
	\]
	Since each $v_i$ is reduced to the identity matrix 
	modulo $\varpi^r$ and thus acts trivially on 
	$A\otimes_{\oo}\xi_{\wt{k}}(\oo)$,
	\[
		\xi_{\wt{k}}(u)\cdot F_\phi(gu)=
		\sum_{i\in I}\sum_{\mu}
		\phi(v^*_\mu)(gx_i'v_i\alpha)\otimes
		\xi_{\wt{k}}(x_i'v_i) v_\mu=
		\sum_{i\in I}\sum_{\mu}
		\phi(v^*_\mu)(gx_i'\alpha)\otimes
		\xi_{\wt{k}}(x_i')
        v_\mu=F_\phi(g).
	\]

	At last, we observe that for each $\mu$ 
	the composition
	$\epsilon_{\wt{k}}(F_\phi)$ is the homomorphism
	\[
		v_\mu^*\mapsto \sum_{i\in I}\phi(v_\mu^*)
		(gx_i\alpha) =U_P^r\phi(v_\mu^*)(g)
	\]
	On the other hand 
	if we decompose $F$ with respect to a choice of 
	weight vectors
	$F(g)=\sum_\mu F_\mu(g)v_\mu+
	\sum_{\mu'}F_{\mu'}(g)v_{\mu'}$, 
	with $\mu$ goes through weight vectors 
	that also appears in $\pi_{\wt{k}}$
	and $\mu'$ goes through the complement,
	then we have
	$\mu(\alpha)=(w_0\wt{k})(\alpha)$ for all $\mu$
	and  $\varpi^r(w_0\wt{k})(\alpha)$ divides $\mu'(\alpha)$
	in $\oo$ for all $\mu'$.
	Therefore
	\begin{multline*}
	U_P^rF(g)=
	\sum_{i\in I}
	\sum_\mu \xi_{\wt{k}}(x_i)\cdot F_\mu(gx_i\alpha)v_\mu+
	\sum_{i\in I}
	\sum_{\mu'}\frac{\mu'(\alpha)}{(w_0\wt{k})(\alpha)}
	\xi_{\wt{k}}(x_i)\cdot F_{\mu'}(gx_i\alpha)v_{\mu'}\\=
	\sum_{i\in I}
	\sum_\mu \xi_{\wt{k}}(x_i)\cdot F_\mu(gx_i\alpha)v_\mu=
	\sum_{i\in I}
	\sum_\mu 
	\epsilon_{\wt{k}}(F)(v^*_\mu)(gx_i\alpha)\otimes
    \xi_{\wt{k}}(x_i)v_\mu
	=F_{\epsilon_{\wt{k}}(F)}(g).
	\end{multline*}

	We thus have the following commutative diagram,
	from which the proposition follows.
	\[
	\begin{tikzcd}
		S_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)
		\arrow[r,"\epsilon_{\wt{k}}"]
		\arrow[d,"U_P^r"]
		& \Hom_\oo(\pi^*_{\wt{k}}(\oo), S(U^p\Iw^P(p^{b,b}),A))
		\arrow[d,"U_P^r"]
		\arrow[dl,"\varphi"]\\
		S_{\wt{k}}(U^p\Iw^P(p^{b,b}),A)
		\arrow[r,"\epsilon_{\wt{k}}"]
		& \Hom_\oo(\pi^*_{\wt{k}}(\oo), S(U^p\Iw^P(p^{b,b}),A))
	\end{tikzcd}	
	\]
\end{proof}


Let $S_{\wt{k}}^{P-\ord}(U^p,E/\oo)=
\varinjlim_{b}
S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),E/\oo)$
be the injective limit under inclusions
and define 
\[
	\TT^P_{\wt{k}}(U^p,E/\oo)=
	\varprojlim_{b}
	\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E/\oo)
\]
Since $S_{\wt{k}}^{P-\ord}(U^p,E/\oo)$
is also the injective limit of 
$S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),\varpi^{-b}\oo/\oo)$
and $\pi_{\wt{k}}^*(\oo)$ is finite over $\oo$,
the following proposition
follows immediately from the previous lemma.

\begin{prop}\label{prop:wt_indep}
	We have the following isomorphism
	which is equivariant with respect to the 
	Hecke operators in Definition \ref{def:ord_hecke}
    and the $Q_0$-action  defined in previous lemma.
	\[
		\epsilon_{\wt{k}} \colon 
		S_{\wt{k}}^{P-\ord}(U^p,E/\oo)\cong 
		\Hom_{\oo}(\pi_{\wt{k}}^*(\oo),
		S^{P-\ord}(U^p,E/\oo)).
	\]
	In particular, this isomorphism 
	induces the following surjective homomorphism
	between the Hecke algebras
	\[
		\varphi_{\wt{k}}\colon 
		\TT^P(U^p,E/\oo)\twoheadrightarrow
		\TT^P_{\wt{k}}(U^p,E/\oo).
	\]
    which satisfies the following relations.
    \begin{itemize}
    \item $\varphi_{\wt{k}}(T_w^{(j)})=T_w^{(j)}$ for $T_w^{(j)}$
    from \eqref{def:hecke_away_p}.
    \item $\varphi_{\wt{k}}(U_{\wt{k},w}^{(j)})=U_{\wt{k},w}^{(j)}$ 
    and  $\varphi_{\wt{k}}(\langle u\rangle_{\wt{k}})=
    \langle u\rangle_{\wt{k}}$ 
    for $U_{\wt{k},w}^{(j)}$ and $\langle u\rangle_{\wt{k}}$
    from Definition \eqref{def:hecke}.
    \item $\varphi_{\wt{k}}(U_{w}^{(j)})=U_{w}^{(j)}$ 
    and  $\varphi_{\wt{k}}(\langle u\rangle)=
    \langle u\rangle$  
    for $U_{w}^{(j)}$ and $\langle u\rangle$
    from \eqref{def:hecke_at_s}.
    \end{itemize}
\end{prop}


\subsection{Completed homology and cohomology}

When $A=E/\oo, \oo/\varpi^{r}\oo$ or $\varpi^{-r}\oo/\oo$
and $\{U_p\}$ is the filtered system of
all compact open subgroups in $K_p$, 
we define the inverse limit
\begin{equation}\label{eq:complete}
	S(U^p,A)\coloneqq
	\varinjlim_{U_p}S(U^pU_p,A)\in 
	\Mod^{\adm}_{G_p}(\oo).
\end{equation}
The natural $G_p$ action on which
defined by Definition \ref{def:algform}
is then the usual right translation
on modular forms of trivial weight.
Moreover, when $A=E/\oo$ we have
\[
	S(U^p,E/\oo)^{U_0}=
	\varinjlim_{b}
	S(U^p\Iw^P(p^{b,b}),\varpi^{-b}\oo/\oo)
\]
where each object on the right is 
a finite $\oo$-module.
It then follows from \cite[Lem 3.1.5]{emeI} and \cite[Prop 3.2.4]{emeI}
that $S^{P-\ord}(U^p,E/\oo)\cong \Ord_P(S(U^p,E/\oo))$,
which belongs to $\Mod^{\adm}_Q(\oo)$
by \cite[Thm 3.3.3]{emeI}.
We define the $P$-ordinary completed homology and cohomology by
\begin{align}\label{eq:completed_coh}
	M_P(U^p)&=
	\Ord_P(S(U^p,E/\oo))^\vee
	\coloneqq \Hom_\oo(\Ord_P(S(U^p,E/\oo)),E/\oo)\\
	S_P(U^p)&=\Hom_\oo(E/\oo, \Ord_P(S(U^p,E/\oo)))
	\cong \varprojlim_r \Ord_P(S(U^p,\oo/\varpi^{r}))
\end{align}
Let $\Hom_\oo^{\cts}(M(U^p),\oo)$
be the set of
$\Phi\in \Hom_\oo(M(U^p),\oo)$ 
such that for any positive integer $r$,
there exists a sufficiently large integer $b$ so that 
the reduction of $\Phi$ modulo $\varpi^r$
factors through
the Pontryagin dual of 
$S^{P-\ord}(U^p\Iw^P(p^{b,b}),E/\oo)\subset \Ord_P(S(U^p,E/\oo))$. 
It can be verified that 
\begin{equation}\label{eq:complete_isom}
	M_P(U^p)\cong \Hom_\oo(S_P(U^p),\oo),\qquad
	S_P(U^p)\cong \Hom_\oo^{\cts}(M_P(U^p),\oo)
\end{equation}
from which we see that
$\TT^P(U^p,E/\oo)$ acts faithfully
on both $M_P(U^p)$ and  $S_P(U^p)$.
In fact, 
let $S_{\wt{k}}^{P-\ord}(U^p,\oo)
=\varinjlim_{b}S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),\oo)$
and 
$\TT^P_{\wt{k}}(U^p,\oo)=
\varprojlim_b\TT_{\wt{k}}^{P}(U^p\Iw^P(p^{b,b}),\oo)$
Then the same argument in \cite[Lem 2.17]{ger}
shows that  $\TT^P_{\wt{k}}(U^p,\oo)\cong \TT^P_{\wt{k}}(U^p,E/\oo)$
as $\oo$-algebras.
We remark that this is in line with the fact that 
$S^{P-\ord}(U^p,\oo)$ is dense in $S_P(U^p)$.

\begin{defn}\label{def:big_hecke}
    We call $\TT^P(U^p,\oo)\cong \TT^P(U^p,E/\oo)$
	the big $P$-ordinary Hecke algebra,
    which, through the above identifications,
    acts faithfully on the spaces
	$S^{P-\ord}(U^p,E/\oo)=\Ord_P(S(U^p,E/\oo)), M_P(U^p), S_P(U^p)$,
	and $S^{P-\ord}(U^p,\oo)$. 
	We also define $\TT^P(U^p,E)=\TT^P(U^p,\oo)\otimes_{\oo}E$,
	which acts faithfully
	on the $E$-Banach space $G_p$-representation
    $S_P(U^p)_E\coloneqq S_P(U^p)\otimes_{\oo}E$.
    When $P=B$ we write 
    $\TT^B(U^p,A)=\TT^{\ord}(U^p,A)$.
\end{defn}

Note that by Lemma \ref{lem:PtoB}
we have the following inclusions
that are compatible among integers $b\geq 1$
\[
	S_{\wt{k}}^{\ord}(U^p\Iw(p^{b,b}),E/\oo)\subset
	S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),E/\oo)
\]
which are equivariant with the Hecke operators.
Consequently we have a Hecke-equivariant inclusion
$\iota_P\colon \Ord_B(S(U^p,E/\oo)\hookrightarrow\Ord_P(S(U^p,E/\oo)$
and the lemma below follows directly.

\begin{lem}\label{lem:coh_to_ord}
    The Hecke-equivariant inclusion
    induces an $\oo$-algebra homomorphism
    \[
        \TT^P(U^p,\oo)\to \TT^{\ord}(U^p,\oo)
    \]
    with respect to which 
    the surjective homomorphism 
	$(\iota_P)^\vee\colon M_P(U^p)\to M^{\ord}(U^p)$ 
    is also equivariant.
\end{lem}


\begin{lem}\label{lem:inj}
	The restriction of the $Q$-module
	$\Ord_P(S(U^p,E/\oo))$ to $Q_0$ 
	is an injective object
	in $\Mod^{\sm}_{Q_0}(\oo)$.
\end{lem}
\begin{proof}
	Following the strategy of 
	\cite[Prop 3.2.4]{pan}, 
	it suffices to show the surjectivity of
	\[
		\Hom_{\oo[Q_0]}(\pi,\Ord_P(S(U^p,E/\oo)))\to 
		\Hom_{\oo[Q_0]}(\pi_1,\Ord_P(S(U^p,E/\oo)))
	\]
	when $\pi_{1}\hookrightarrow \pi$ 
	is an injective morphism between admissible 
    $Q_0$-representations of finite $\oo$-modules.
    Expand the definition of $\Ord_P$ from \eqref{def:OrdP}
    and note that any homomorphism  in 
    $\Hom_{\oo[Q_0]}(\pi_1,\Ord_P(S(U^p,E/\oo)))$ factors through
	\begin{multline*}
		\Hom_{\oo[Q_0]}(\pi_1,
		\Hom_{\oo[Z_Q^+]}
		(\oo[Z_Q], S(U^p\Iw^P(p^{b,b}),
		\varpi^{-r}\oo/\oo)))\\=
		\Hom_{\oo[Z_Q^+]}(\oo[Z_Q],
		\Hom_{\oo[Q_0]}(\pi_1, 
		S(U^p\Iw^P(p^{b,b}),\varpi^{-r}\oo/\oo)))
	\end{multline*}
	for some $b$ and $r$ sufficiently large
    since $\pi_1$ is admissible and $\oo$-finite,
	on which 
	the $Z_Q$-fintieness condition is automatic
	by \cite[Lem 3.1.5]{emeI}.

    Let $\Iw(p^{0,b})$ 
    act on $\pi$ through $Q_0\cap \Iw(p^{0,b})$
    by the Iwahori decomposition
    and $\pi^\vee$ denote the Pontryagin dual of $\pi$.
	Define the space of modular forms with
    coefficients in $\pi^\vee$ by
	\[
		S_{\pi^\vee}(U^p\Iw(p^{0,b}))=
		\{
			F\colon G(\F)\backslash G(\A_f)\to 
			\pi^\vee\mid 
			F(gu)=\pi^\vee(u_p)^{-1}\cdot F(g),\,
			u\in \Iw(p^{0,b})
		\}
	\]
	Enlarge $b$ if necessary, we may assume
	$Q_0\cap \Iw(p^{b,b})$ acts trivially on $\pi$.
	Then there exists an isomorphism
	\[
		\epsilon\colon 
		S_{\pi^\vee}(U^p\Iw(p^{0,b}))\cong 
		\Hom_{\oo[Q_0]}(\pi,
		S(U^p\Iw^P(p^{b,b}),\varpi^{-r}\oo/\oo)))
		\quad \epsilon(F)\colon
		v\mapsto [g\mapsto v(F(g))]
	\]
	and similarly for $\pi_1$.
    Since \eqref{cond:small} implies that
	that $S_{\pi^\vee}(U^p\Iw(p^{0,b}))$
	are $S_{\pi_1^\vee}(U^p\Iw(p^{0,b}))$
	are direct sums of 
	$\pi^\vee$ and  $\pi_1^\vee$
    indexed by
	$G(\F)\backslash G(\A_f)/U^p\Iw(p^{0,b})$,
    the natural map
	$S_{\pi^\vee}(U^p\Iw(p^{0,b}))\to 
	S_{\pi_1^\vee}(U^p\Iw(p^{0,b}))$ is then
	surjective
	as $\pi^\vee\to \pi_1^\vee$ is surjective.
	Localize to the $P$-ordinary parts
	and apply \cite[Lem 3.1.5]{emeI} again,
	we see that
	\[
		\Hom_{\oo[Z_Q^+]}(\oo[Z_Q],
		S_{\pi^\vee}(U^p\Iw(p^{0,b})))\to 
		\Hom_{\oo[Z_Q^+]}(\oo[Z_Q],
		S_{\pi^\vee_1}(U^p\Iw(p^{0,b})))
	\]
	is also surjective, from which 
	the proposition follows.
\end{proof}


\begin{prop}\label{prop:density}
The subspace $S_P(U^p)_E^{\textnormal{alg}}$ 
of $Q_0$-algebraic vectors, defined as
\[
\Image\left(ev\colon
\bigoplus_{\wt{k}}\Hom_{E[Q_0]}(\pi_{\wt{k}}^*(\oo), S_P(U^p)_E)
\otimes_E \pi_{\wt{k}}^*(E)\rightarrow S_P(U^p)_E\right)
\]
where $\wt{k}$ ranges through all dominant weights,
is dense in the $E$-Banach space $S_P(U^p)_E$.
\end{prop}
\begin{proof}
	Since $\Ord_P(S(U^p,E/\oo))$ is an injective object
	in $\Mod_{Q_0}^{\sm}(\oo)$
	by Lemma \ref{lem:inj},
	we may follow the strategy of 
	\cite[Prop 3.2.9]{pan}
	and use \cite[Cor 3.2.6]{pan}
	to reduce the statement to that of
	$\mathcal{C}(Q_0,E)$,
	the space of continuous  $E$-valued
	functions on $Q_0$.
	The density result then follows from
	\cite[Prop 6.A.17]{Pask14}.
\end{proof}


\begin{prop}\label{prop:wt_space}
	There exists a Hecke-equivariant isomorphism
	\[
	S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{0,1}),E)\cong 
	\Hom_{\oo[Q_0]}(\pi_{\wt{k}}^*(\oo), S_P(U^p)_E)
	\]
\end{prop}
\begin{proof}
    Apply $\Hom_\oo(E/\oo,*)$ to the isomorphism 
    in Proposition \ref{prop:wt_indep}
    and use \eqref{eq:complete_isom}, we obtain 
	\begin{multline*}
		\Hom_\oo(E/\oo, S_{\wt{k}}^{P-\ord}(U^p,E/\oo))\cong 
		\Hom_\oo(E/\oo,
		\Hom_{\oo}(\pi_{\wt{k}}^*(\oo),
		S^{P-\ord}(U^p,E/\oo)))\\=
		\Hom_{\oo}(\pi_{\wt{k}}^*(\oo),
		\Hom_\oo(E/\oo,
		S^{P-\ord}(U^p,E/\oo)))\cong
		\Hom_{\oo}(\pi_{\wt{k}}^*(\oo), S_P(U^p))
	\end{multline*}
	which is equivariant with respect to 
	the Hecke operators and the $Q_0$-actions defined there.
    Observe that 
	taking the $Q_0$-invariant subspaces
	on the right hand side gives
	$\Hom_{\oo[Q_0]}(\pi_{\wt{k}}^*(\oo), S(U^p))$.

	On the other hand, since
	$\Hom_\oo(E/\oo, S_{\wt{k}}^{P-\ord}(U^p,E/\oo))\cong
	\varprojlim_r S_{\wt{k}}^{P-\ord}(U^p,\oo/(\varpi^r))$,
	by Lemma \ref{lem:control}
	the $Q_0$-invariant subspace 
	on the left hand side
	is $S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{0,1}),\oo)$.
	The claimed result now follows by
	tensoring both subspaces with $E$.
\end{proof}

\begin{rem}
	The above results generalize
	\cite[Prop 3.2.9]{pan} and 
	\cite[\S 3.2.10]{pan},
	which deals with the case 
	when $n=2$ and $P=G_p$,
	in which the $P$-ordinary condition is empty.
\end{rem}

\begin{cor}\label{cor:density}
    When $\wt{k}$ goes through all dominant weight, 
    there exists an injective homomorphism
    \[
        \TT^P(U^p,E)\to \prod_{\wt{k}}\TT^P(U^p\Iw^P(p^{0,1}),E)
    \]
\end{cor}
\begin{proof}
This is an immediate consequence of the previous two propositions.
\end{proof}




\subsection{Hida family}

We digress temporarily 
and give an ad-hoc definition
of Hida families of $B$-ordinary modular forms
in terms of the completed homology and cohomology.

For each $w\in \Sigma_p$ and $b\geq 0$
let $T_n(w^b)=\{u\in T_n(\oo_w)\mid u\equiv \id \mod\varpi_w^b\}$
so that $T_n(w^b)=T_n(\oo_w)$ when $b=0$
and put $T_n(p^b)=\prod_{w\in\Sigma_p}T_n(w^b)$.
By the Teichm\"{u}ller lift
there exists a finite subgroup $\Delta_p\subset T_n(p^0)$
of prime-to-$p$ order such that 
$T_n(p^0)=\Delta_p\times T_n(p^1)$.
And for $v\in S$ 
we put $\Delta_v=U_v/\Iw_1(w)$,
where $w$ is the fixed prime above $v$,
and define $\Delta_S=\prod_{v\in S}\Delta_v$.
Then we define the completed group rings
\begin{equation}\label{def:lambda_rings}
    \Lambda\coloneqq \oo\llbracket T_n(p^1)\rrbracket,\,
    \text{ and }\,
    \Lambda^+\coloneqq \Lambda[\Delta_p\times \Delta_S].
\end{equation}
The diamond operators 
defined in \eqref{def:hecke_at_p} and \eqref{def:hecke_at_s}.
then induces an $\oo$-algebra homomorphism
\begin{equation}\label{eq:Lambda_hecke}
    \langle *\rangle\colon \Lambda^+\to 
    \TT^{\ord}(U^p, \oo)\quad
    u\mapsto \langle u\rangle.
\end{equation}




\begin{defn}\label{def:Hida_family}

Let $\I$ be a local complete Noetherian ring
that is finite over $\Lambda^+$ and flat over $\oo$.
Write $S_B(U^p)=S^{\ord}(U^p)$, we define
the space of $\I$-adic Hida families 
of tame level $U^p$ as 
\begin{equation}\label{eq:Hida_family}
    S^{\ord}(U^p,\I)\coloneqq 
    \{\euF\in S^{\ord}(U^p)\widehat{\otimes}_\oo\I\mid 
    (\langle u\rangle\otimes\id)\euF=
    (\id\otimes\langle u\rangle)\euF\, \text{ for }
    u\in \Lambda^+\}.
\end{equation}
Here $(\langle u\rangle\otimes\id)$ denotes
the action through the Hecke algebra and
$(\id\otimes\langle u\rangle)$ denotes the action
through $\I$.
Note that $S^{\ord}(U^p,\I)$
is stable by the usual Hecke action on 
the first factor since $T^{\ord}(U^p,\oo)$ is commutative.
This defines the action of $\TT^{\ord}(U^p,\oo)$ on $S^{\ord}(U^p,\I)$.
\end{defn}

\begin{rem}
Let $\Delta'$ be the prime-to-$p$ part of the 
finite abelian group $\Delta_p\times \Delta_S$.
Since $\I$ is local,
the restriction of the $\Lambda^+$-algebra to $\oo[\Delta']$,
potentially after replacing $\oo$ by a finite extension,
determines a character 
$\gamma\colon\Delta'\to \oo^\times$
such that $\oo[\Delta']\to \I$
factors through the homomorphism induced by $\gamma$.

\end{rem}

\begin{lem}
    Write $M_B(U^p)=M^{\ord}(U^p)$
    and $M^{\ord}(U^p,\I)=M^{\ord}(U^p)\otimes_{\Lambda^+}\I$.
    Then there exists a Hecke-equivariant isomorphism
    $S^{\ord}(U^p,\I)\cong\Hom_\I(M^{\ord}(U^p,\I), \I)$.
\end{lem}
\begin{proof}
Recall from \eqref{eq:complete_isom} that
$S^{\ord}(U^p)\cong \Hom^{\cts}_\oo(M^{\ord}(U^p),\oo)$.
From which we have
$S^{\ord}(U^p)\widehat{\otimes}_\oo\I
\cong \Hom^{\cts}_\oo(M^{\ord}(U^p),\I)$.
Then the subspace on which the actions
$(\langle u\rangle\otimes\id)$ and
$(\id\otimes\langle u\rangle)$
coincide is precisely
\[
    \Hom^{\cts}_{\Lambda^+}(M^{\ord}(U^p),\I)\cong
    \Hom_{\I}(M^{\ord}(U^p,\I),\I).
\]
\end{proof}

\begin{prop} \label{prop:ord_to_dual}
The spaces $M^{\ord}(U^p,\I)$ and
$S^{\ord}(U^p,\I)$,
are finite free over $\I$
under the condition \eqref{cond:s-ram} and \eqref{cond:small}.
In particular there exists a Hecke-equivariant isomorphism
\[
    M^{\ord}(U^p,\I)\cong \Hom_\I(S^{\ord}(U^p,\I),\I).
\]
\end{prop}

\begin{proof}
Under the condition \eqref{cond:s-ram} and \eqref{cond:small},
\cite[Lem 2.6]{ger} implies that  the spaces 
$S(U^p\Iw(p^{b,b}),\oo)$ are finite over over 
$\oo[T_n(p^1)/T_n(p^b)][\Delta]$.
Let $\fa_b\subset\Lambda^+$
be the augmented ideal generated by $T_n(p^b)$ for $b\geq1$.
We can then argue as in \cite[Prop 2.20]{ger} and show that
\[
    M^{\ord}(U^p)/\fa_b M^{\ord}(U^p)
\]
is finite-free over $\I/\fa_b\I$
of constant rank
$r=\operatorname{rank}_\oo S^{\ord}(\tilde{U}^p\Iw(p^{0,1}),\oo)$,
where $\tilde{U}^p$ is the prime-to-$p$ part
of the open compact subgroup $\tilde{U}$ in \eqref{cond:small}.
Therefore $M^{\ord}(U^p,\I)$ is finite free over $\Lambda^+$
of rank $r$ and 
$M^{\ord}(U^p,\I)$ is finite free over $\I$ of rank $r$.
It then follows from the previous lemma that 
$M^{\ord}(U^p,\I)\cong \Hom_\I(S^{\ord}(U^p,\I),\I)$.

\end{proof}


\subsection{Hecke algebras and Galois representations}

Let $\mathcal{A}$ be
the space of automorphic forms on $G(\A)$,
on which $G(\A)$ acts by right translation.
And for dominant $\wt{k}\in (\Z^n)^{\Sigma}$
let $G(\A_f)$ act on $S_{\wt{k}}(\bar{\Q}_p)$
as in Definition \ref{def:algform}.
We let $\xi_{\wt{k}}^*(\C)$
denote the algebraic
$G(\A_\infty)$-representation
defined by the inclusions
$G(\F_\sigma)\subset \GL_n(\F_\sigma\otimes \K)=\GL_n(\C)$
for each $\sigma\in\Sigma$.
By \cite[Prop 3.3.2]{CHT},
there exists an $G(\A_f)$-equivariant isomorphism
\begin{equation}\label{eq:p_to_infty}
	\iota\colon S_{\wt{k}}(\bar{\Q}_p)\otimes_{\iota,\bar{\Q}_p}\C
	\rightarrow \Hom_{G(\A_\infty)} (\xi_{\wt{k}}^*(\C), \mathcal{A})\quad
	\iota(F)\colon v^*\mapsto 
	[g\mapsto \xi_{\wt{k}}(g_\infty)\cdot 
    \iota\left(\xi_{\wt{k}}(g_p)F(g_f)\right)].
\end{equation}


\begin{prop}\cite[Prop.2.27]{ger}\label{prop:gal_ger}
	Let $\pi$ be an irreducible constituent of the
	$G(\A_f)$-representation $S_{\wt{k}}(\bar{\Q}_p)$,
	then there exist a unique 
	continuous semi-simple Galois representation
	\[
	r_\pi: \Gal_\K \rightarrow \GL_n(\bar{\Q}_p)\quad
	\]
    satisfying $r_\pi^c \cong r_\pi^{\vee} \epsilon^{1-n}$,
	where $\epsilon$ is the $p$-th cyclotomic character,
	with the following properties.
\begin{enumerate}[label=(\alph*)]
\item If $v\in \finite$ is inert and $\pi_v$
is fixed by a hyperspecial maximal compact open subgroup 
of $G(\F_v)$ then $r_\pi\vert_{D_v}$ is unramified.
\item If $v\in \finite$ splits into $w\bw$ in $\K$
let $\pi_w$ denote the $\GL_n(\K_w)$-representation
$\pi_v\circ \iota_w^{-1}$, then
\[
\WD\left(\left.r_\pi\right|_{D_w}\right)^{\mathrm{ss}} \cong
\Rec(\pi_w|\cdot|^{\frac{1-n}{2}})^{\mathrm{ss}}.
\]
Moreover, $r_\pi\vert_{D_w}$ is unramified if $\pi_w$ is unramified.
\item 
If $w\in\Sigma_p$ the representation
$r_\pi\vert_{D_w}$ is potentially semi-stable.
Moreover $r_\pi\vert_{D_w}$ is crystalline
if the representation $\pi_w$ defined as above is unramified,
in which case the characteristic polynomial of 
the geometric Frobenius $\Fr_w$ on 
$\WD\left(D_{\mathrm{cris }}\left(\left.r_\pi\right|_{D_w}\right)\right)$
coincides with that of 
$\Rec(\pi_w|\cdot|^{\frac{1-n}{2}})^{\mathrm{ss}}$.
\item 
Define $k_{\sigma,j}=-k_{\sigma c, n-j+1}$ for $\sigma\in \Sigma^c$.
If $w\mid p$ and  $\sigma\in I_w$, then 
$\dim_{\bar{\Q}_p}\operatorname{gr}^i
\left(r_\pi \otimes_{\sigma, \K_w} B_{\dR}\right)^{D_w}=1$
exactly when $i=k_{\sigma, j}+n-j$ 
for $j=1, \ldots, n$ and is equal to 0 otherwise.
\end{enumerate}
\end{prop}

In the rest of the section,
we restrict ourselves to the following case.
\begin{equation}\label{cond:parabolic}\tag{P}
	n=2,\, 
	P_{w_0}=G_{w_0} \text{ for the fixed prime }w_0\in \Sigma_p,\,
	P_{w'}=B_{w'} \text{ for } w'\in \Sigma_p\setminus\{w_0\}.
\end{equation}
Note that by definition \eqref{def:Iwahori_P}
we have $K_{w_0}\subset \Iw^P(p^{0,1})$.


\begin{lem}\label{lem:hecke_red}
Both
$\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)$ and
$\TT^{\ord}_{\wt{k}}(U^p\Iw(p^{b,b}),\oo)$
are finite flat reduced $\oo$-algebras.
\end{lem}
\begin{proof}
For $\TT^{\ord}_{\wt{k}}(U^p\Iw(p^{b,b}),\oo)$
this is \cite[Lem 2.14]{ger}
so we only prove the lemma for
$\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)$.

It is clear that the Hecke algebra,
which is a subalgebra of the endormorphism ring
of the finite free $\oo$-module
$S^{P-\ord}_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)$,
is finite flat over $\oo$.
For the reducedness,
since the Hecke algebra is $\oo$-flat,
it suffices to tensor $E$ and show that 
$\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)$
is semi-simple,
or the Hecke operators
generating which act semi-simply on 
$S^{P-\ord}_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)$.
This is clear for 
the operators $T_{w}^{(j)}$ from \eqref{def:hecke_away_p}
and the operators $\langle u\rangle $
from \eqref{def:hecke_at_s}.
For the operators at $w'\in\Sigma_p\setminus\{w_0\}$
this follows from \cite[Lem 2.14]{ger}.
For the operators at $w=w_0$,
we only need to consider the operators
$h_U(\smat{\varpi_{w}&\\&\varpi_w})$ and
$h_U(\smat{x&\\&x})$ for $x\in \oo_w^\times$.
These are essentially the central action
of $\K_w^\times\subset \GL_2(\K_w)$
and the semi-simplicity of which is also clear.

\end{proof}

Consequently $\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)$
is the a product of residue fields 
$E_{\fp}\coloneqq \TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)/\fp$,
which are finite extensions over $E$,
where $\fp$ goes through minimal primes.
By abuse of notation, let $\fp$ also denote 
the height one prime ideal 
$\fp\cap \TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)$
in $\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)$.

\begin{defn}\label{def:rep_prime}
	Write 
	$\lambda_\fp\colon \TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)\to E_\fp$
    for the projection associated 
    to a minimal prime $\fp\subset \TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)$.
    Let $\pi$ be an irreducible constituent 
    of $S_{\wt{k}}(\bar{\Q}_p)$
    and $r_\pi$ be the corresponding Galois representation.
    We say $\pi$ belongs to $\fp$ if
	$\pi\cap S_{\wt{k}}^{P-\ord}(U^p\Iw^P(p^{b,b}),E)_{\fp}\neq 0$
    and write $r_\fp=r_\pi$.
    Then part (b) in Proposition \ref{prop:gal_ger} implies that
	\begin{equation}\label{eq:Gal_hecke_away_p}
		\mtr(r_\pi(\Fr_w))=\lambda_\fp(T_w^{(1)}),\quad
		\det(r_\pi(\Fr_w))=q_w\lambda_\fp(T_w^{(2)}),\,
	\end{equation}
	for primes $v=w\bw$ in \eqref{def:hecke_away_p}.
    Since the set of such primes has density one,
	by Chebotarev's density theorem
	the representation $r_\pi$ is defined over $E_{\fp}$
	and independent of the choice of $\pi$ belonging to $\fp$.
\end{defn}



Following \cite{ger},
we say $\wt{k}$ is sufficiently regular
at $w\in \Sigma_p$
if there exists  $\sigma\in I_{w}$
such that  $k_{\sigma,1}>k_{\sigma,2}$.
\begin{lem}\label{lem:galois_at_p}
	Let $r_{\fp}$ be the Galois representation
	associated to a minimal prime
	$\fp\subset \TT^P_{\wt{k}}(U^p\Iw^P(p^{0,1}),E)$.
	\begin{enumerate}[label=(\alph*)]
	\item The representation $r_\fp$ is crystalline at
    $w'\in \Sigma_p\setminus\{ w_0\}$
	if $\wt{k}$ is sufficiently regular at $w'$.
	Moreover, $r_\fp\vert_{D_{w'}}$ 
	fits into an exact sequence
	$0\to \psi_1\to r_{\fp}\vert_{D_{w'}} \to \epsilon^{-1}\psi_2\to 0$
	for characters $\psi_i\colon D_{w'}\to E_{\fp}^{\times}$ with
	\begin{equation}\label{eq:Gal_hecke_at_p'}
	\begin{aligned}
		\psi_1\circ \Art_{w'}(\varpi_{w'})&=
		\lambda_{\fp}(U_{\wt{k},w'}^{(1)}) &
		\psi_1\circ \Art_{w'}(x)&=
		\lambda_{\fp}
		(\langle 
		(\begin{smallmatrix}
			x&\\&1
		\end{smallmatrix})
		\rangle)\, \text{ for }x\in \oo_{w'}^{\times}\\
		\psi_2\circ \Art_{w'}(\varpi_{w'})&=
		\lambda_{\fp}(U_{\wt{k},w'}^{(2)})/
		\lambda_{\fp}(U_{\wt{k},w'}^{(1)}) &
		\psi_1\circ \Art_{w'}(x)&=
		\lambda_{\fp}
		(\langle 
		(\begin{smallmatrix}
			1&\\&x
		\end{smallmatrix})
		\rangle)\, \text{ for }x\in \oo_{w'}^{\times}
	\end{aligned}
	\end{equation}
	\item The representation $r_\fp$ is 
	crystalline at $w=w_0$, with 
	\begin{equation}\label{eq:Gal_hecke_at_p}
	(\epsilon\det r_\fp)\circ \Art_w(\varpi_w)=
	\lambda_{\fp}(U_{\wt{k},w}^{(2)}),\quad
	(\epsilon\det r_\fp)\circ \Art_w(x)=
	\lambda_{\fp}
	(\langle 
	(\begin{smallmatrix}
		x&\\&x
	\end{smallmatrix})
	\rangle)\, \text{ for }x\in \oo_{w}^{\times}
	\end{equation}
	\end{enumerate}
\end{lem}
\begin{proof}
The first part is a restatement of \cite[Cor 2.33]{ger}.
Here we have used the fact that
$\lambda_\fp(\langle u\rangle)=(w_0\wt{k})^{-1}(u)$ 
for $u\in T_n(\oo_{w'})\subset \Iw(w'^{0,1})$. 
And the second part follows from part (c)
of Proposition \ref{prop:gal_ger}.
\end{proof}

\begin{rem}
If we consider the ordinary Hecke algebra
$\TT^{\ord}(U^p\Iw(p^{0,1}),E)$ instead,
then \cite[Cor 2.33]{ger} states that 
part (a) of the lemma above
holds for all $w\in\Sigma_p$.
\end{rem}

By Lemma \ref{lem:hecke_red},
when $\fp$ goes through all minimal primes
of $\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)$
we have an injection
\[
	\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)\hookrightarrow
	\TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),E)\xrightarrow{\sim} 
	\prod_{\fp}E_{\fp}.
\]
the image is a closed subring.
Therefor \eqref{eq:Gal_hecke_away_p}
and Chebotarev's density theorem
implies that there exists
a pseudo-representation
$T=T_{\wt{k}}(U^p\Iw^P(p^{b,b}))$ 
such that $\lambda_\fp\circ T=\mtr(r_\fp)$ 
for all $\fp$ and
\begin{equation}\label{eq:pseudo_rep_finite}
\begin{aligned}
	T&\colon \Gal_{\K}
	\to \TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)\quad
	\Fr_w\mapsto T_w^{(1)}\\\
	(\epsilon\det T)&\colon \Gal_{\K}
	\to \TT^P_{\wt{k}}(U^p\Iw^P(p^{b,b}),\oo)\quad
	\Fr_w\mapsto T_w^{(2)}
\end{aligned}
\end{equation}
for $v=w\bw$ in \eqref{def:hecke_away_p}.
By the formula above the pseudo-representations
are compatible among different levels.
We take the inverse limit and define
the big $P$-ordinary Galois pseudo-representation.
\[
T_{\wt{k}}(U^p)\colon \Gal_{\K} \to \TT^P_{\wt{k}}(U^p,\oo)
\]
which also satisfies \eqref{eq:pseudo_rep_finite}.
We also define 
$T_{\wt{k}}^{\ord}(U^p)\colon 
\Gal_{\K} \to \TT^{\ord}_{\wt{k}}(U^p,\oo)$
in a similar fashion.

\begin{defn}\label{def:big_Gal}
We write $T(U^p)=T_{\wt{k}}(U^p)$ and 
$T^{\ord}(U^p)=T_{\wt{k}}^{\ord}(U^p)$
when $\wt{k}$ is the trivial weight.
Note that since all pseudo-representations satisfy
\eqref{eq:pseudo_rep_finite}
for $v=w\bw$ in \eqref{def:hecke_away_p},
by Chebotarev's density theorem 
the pseudo-representations are comptatible among
the commutative diagram
\[
\begin{tikzcd}
    \TT(U^p,\oo) 
    \arrow[r] \arrow[d]&
    \TT_{\wt{k}}(U^p,\oo) 
    \arrow[d]\\
    \TT^{\ord}(U^p,\oo) 
    \arrow[r] &
    \TT^{\ord}_{\wt{k}}(U^p,\oo) 
\end{tikzcd}
\]
where the horizontal maps come from Proposition \ref{prop:wt_indep}
and the vertical maps come from Lemma \ref{lem:coh_to_ord}.
\end{defn}

\begin{prop}\label{prop:big_char_at_p}
    For each $w'\in \Sigma_p\setminus\{w_0\}$
    the restriction of $T(U^p)$ to $D_w$
    is reducible and 
    \[
        T(U^p)\vert_{D_{w'}}=\Psi_{w',1}+
        \epsilon^{-1}\Psi_{w',2},\quad
        T(U^p)^c\vert_{D_{w'}}=\epsilon^{-1}\Psi_{w',1}^{-1}+
        \Psi_{w',2}^{-1}
    \]
    where $T(U^p)^c(\gamma)\coloneqq T(U^p)(\gamma^c)$,
    for characters 
    $\Psi_{w',1},\Psi_{w',2}\colon D_{w'}\to \TT^P(U^p,\oo)$
    such that
	\begin{equation}
	\begin{aligned}
		\Psi_{w',1}\circ \Art_{w'}(\varpi_{w'})&=
		U_{w'}^{(1)}=h_U(\smat{\varpi_{w'}&\\&1}) &
		\Psi_{w',1}\circ \Art_{w'}(x)&=
		\langle 
		(\begin{smallmatrix}
			x&\\&1
		\end{smallmatrix}
		\rangle)\, \text{ for }x\in \oo_{w'}^{\times}\\
		\Psi_{w',2}\circ \Art_{w'}(\varpi_{w'})&=
		U_{w'}^{(2)}/
		U_{w'}^{(1)} =h_U(\smat{1&\\&\varpi_{w'}}) &
		\Psi_{w',2}\circ \Art_{w'}(x)&=
		\langle 
		(\begin{smallmatrix}
			1&\\&x
		\end{smallmatrix})
		\rangle\, \text{ for }x\in \oo_{w'}^{\times}
	\end{aligned}
	\end{equation}
    And the statement holds for all $w\in \Sigma_p$
    if we consider $T^{\ord}(U^p)$ instead.
\end{prop}
\begin{proof}

Since the proof is the same for $T(U^p)$ and $T^{\ord}(U^p)$,
we only consider $T(U^p)$.
By Lemma \ref{lem:galois_at_p}
we can define characters $\Psi_{w',i,\wt{k}}$ as above
to $\TT^P(U^p\Iw^P(p^{0,1}),E)$
when $\wt{k}$ is sufficiently regular
at all $w'\in \Sigma_p\setminus{w_0}$.
And the pushforward of $T(U^p)\vert_{D_{w'}}$ on which
is the sum of $\Psi_{w',1,\wt{k}}$ and
$\epsilon^{-1}\Psi_{w',2,\wt{k}}$.

Now the proof of \cite[Cor 3.4]{ger}
implies that Corollary \ref{cor:density} still holds
if we restricts to those $\wt{k}$
that are sufficiently regular
at all $w'\in \Sigma_p\setminus{w_0}$.
Therefore the image of $\TT^P(U^p,\oo)$
via the injection in the corollary
is a closed subring of $\prod_{\wt{k}}\TT^P(U^p\Iw^P(p^{0,1}),\oo)$
and the direct product of the characters
$\Psi_{w',i,\wt{k}}$ factors through which.
From this we conclude the existence 
of the characters $\Psi_{w',i}$.
Using the density result again,
we have that $T(U^p)\vert_{D_{w'}}$
is the sum of $\Psi_{w',1}$ and $\epsilon^{-1}\Psi_{w',2}$.
The other equality regarding $T(U^p)^c$ is proved similarly,
once we notice that
$\mtr(r_\fp^c)\vert_{D_{w'}}=
\mtr(r_\fp^\vee\epsilon^{-1})\vert_{D_{w'}}=
\epsilon\psi_1^{-1}+\psi_2$
for characters $\psi_i$ in Lemma \ref{lem:galois_at_p}.




\end{proof}

\section{Results on p-adic local Langlands}

We keep the notations and conditions from last subsection.
Specifically, we have
\begin{itemize}
\item The definite unitary group $G$ over $\F$
defined by \eqref{def:def_unitary} for $n=2$.
\item A finite subset $S\subset\finite$ of prime-to-$p$
places that splits in $\K$
and an open compact subgroup $U^p$
satisfying \eqref{cond:s-ram} and \eqref{cond:small}.
\item A parabolic subgroup $P\subset G_p\cong\prod_{v\in S_p}G(\F_v)$
satisfying \eqref{cond:parabolic}.
\end{itemize}
Throughout the section
we fix a sufficiently large finite extension $E/\Qp$.
Then over the ring of integers $\oo=\oo_E$ 
we can introduce the space of 
algebraic modular forms 
$S^{P-\ord}(U^p,E/\oo), S^{\ord}(U^p,E/\oo)$;
the completed homology
$M(U^p)=M_P(U^p), M^{\ord}(U^p)=M_B(U^p)$; 
the completed cohomology
$S(U^p)=S_P(U^p), S^{\ord}(U^p)=S_B(U^p)$;
and the big Hecke algebras
$\TT(U^p,\oo)=\TT^P(U^p,\oo)$ and $\TT^{\ord}(U^p,\oo)$.

For the degree one place $w_0\in \Sigma_p$,
we will write $D_{w_0}$ and $\Gp$,
the absolute Galois group of  $\Qp$, interchangeably,
where the two Galois groups are identified 
through an fixed isomorphism $\K_{w_0}\cong \Qp$.
Then \eqref{cond:parabolic}
implies that the Levi part $Q$
of the parabolic subgroup $P$
is the product of $\GL_2(\K_{w_0})\cong \GL_2(\Qp)$
and the torus $\prod_{w'\in\Sigma_p\notin\{w_0\}}T(\K_{w'})$
(we write $T=T_n$ for $n=2$).
In particular the restriction of the $Q$-admissible representation
$S^{P-\ord}(U^p,E/\oo)\coloneqq \Ord_P(S(U^p,E/\oo))$
to $\GL_2(\Qp)$
is a locally admissible representation.

The goal of the section is as follows.
Fix a maximal ideal $\fm\subset \TT(U^p,\oo)$.
By the lemma below,
potentially after replacing $E$ by a finite extension,
we may assume that 
$\TT(U^p,\oo)/\fm$ coincides with the residue field $\fF$ of $\oo$.
Let $T_{\fm}=T(U^P)_{\fm}\colon \Gal_\K\to \TT(U^p)_{\fm}$
denote the localization of 
the big Galois pseudo-representation in 
Definition \ref{def:big_Gal}.
We further assume  $T_{\fm}$ is 
residually reducible and locally generic at $w_0$,
in the sense that there exists characters
$\bar{\delta}_1, \bar{\delta}_2\colon \Gal_{\K}\to \fF^\times$
such that 
\begin{equation}\tag{red.gen}\label{cond:red_gen}
	T_\fm\equiv \bar{\delta}_1+\bar{\delta}_2
	\mod \fm,\quad
    \text{ and }\quad
	\bar{\delta}_1\bar{\delta}_2^{-1} \vert_{D_{w_0}}
	\neq \id,\omega^{\pm}
\end{equation}
where $\omega$ is the Teichmuler character.
We apply P\v{a}sk\={u}nas' theory of blocks
of $\GL_2(\Qp)$-representations
to $M(U^p)_{\fm}$.
A modified version of the method in \cite{urban}
then shows that $\TT(U^p,\oo)_{\fm}$ is Noetherian
and the ``reducible'' part of  $M(U^p)_{\fm}$
is essentially given by $M^{\ord}(U^p)_{\fm}$,
here we take $M^{\ord}(U^p)$
as a $\TT(U^p,\oo)$-module 
through the homomorphism in Lemma \ref{lem:coh_to_ord}
and take the localization.
From these result we derive a fundamental exact sequence
in Corollary \ref{cor:fund} that will be critical
for our construction of the Euler systems in next section.


\begin{lem}
The big Hecke algebras 
$\TT(U^p,\oo)$ and $\TT^{\ord}(U^p,\oo)$
are $\oo$-finite, reduced, and semi-local.
In fact, the natural homomorphism
$\TT(U^p,\oo)\to \TT^P(U^p\Iw^P(p^{0,1}),\oo/\varpi)$ 
induces a bijection between maximal ideals of the two rings
and similarly for $\TT^{\ord}(U^p,\oo)$.
\end{lem}
\begin{proof}
The the Hecke algebras are $\oo$-finite and reduced
follows from Lemma \ref{lem:hecke_red}.
And the last part of the statement
follows from the same argument
in \cite[Prop 3.3.6]{pan}.
\end{proof}







\subsection{Generically reducible deformation}

We first recall from \cite[\S B.1]{pask}
the structure of the universal deformation ring 
$R$ of a $2$-dimensional pseudo-representation 
$\chi_1+\chi_2$,
where $\chi_1,\chi_2\colon \Gp\to \fF^\times$ 
are continuous characters that satisfies the 
the following generic assumption
\begin{equation}\label{cond:generic}\tag{\text{gen}}
	\chi_1\chi_2^{-1}\neq \id,\omega^{\pm1}.
\end{equation}

By \textit{loc.cit}, the assumption
implies the existence of non-split extensions
of Galois representations
\begin{equation*}
    0\to \chi_1\to \rho_{12}\to \chi_2\to 0\quad
    0\to \chi_2\to \rho_{21}\to \chi_1\to 0
\end{equation*}
which are unique up to isomorphisms;
and that the universal deformation rings
$R_{ij}$ of the Galois representations $\rho_{ij}$
are formally smooth of relative dimension $5$ over $\oo$.


Let $\tilde{\rho}_{ij}\colon \Gp\to\GL_2(R_{ij})$
denote the universal deformations.
Under suitable choices of bases we may assume
their reductions modulo the maximal ideals give
$\rho_{12}=\smat{\chi_1&*\\&\chi_2}$ and
$\rho_{21}=\smat{\chi_1&\\ *&\chi_2}$.
The trace then induces 
$\theta_{ij}\colon R\cong R_{ij}$
by \cite[Prop B.17]{pask}.
Let $R_{\red}$ be the quotient of $R$
that represents reducible deformations.
Then $R_{\red}$ is isomorphic
to the complete tensor of the
deformation rings for the characters $\chi_1$ and $\chi_2$.
Since the pro-$p$ completion of $\Qp^\times$
has rank 2 over $\Zp$,
we see that $R_{\red}$ is formally smooth of
relative dimension $4$ over $\oo$.
Consequently the reducibility ideal 
$\tau\coloneqq \ker(R\to R_{\red})$ 
is a principal ideal generated by 
an element $\xx\in\fm_R\setminus \fm_R^2$,
where $\fm_R\subset R$ is the maximal ideal.
By \cite[Prop B.23]{pask},
we have $\theta_{ij}(\tau)=\tau_{ij}$
for the ideal $\tau_{ij}\subset R_{ij}$
generated by the $(j,i)$-entry of $ \tilde{\rho}_{ij}(g)$
for all $g\in \Gp$.

Write $x=\xx$ and $\theta=\theta_{12}$.
By \cite[Prop B.24]{pask},
the representation 
$\tilde{\rho}_{12}^x\colon \Gp\to \GL_2(R_{12})$
defined by
\begin{equation*}
	\tilde{\rho}_{12}^x(g)\coloneqq 
	\smat{\theta(x)&\\&1}
	\tilde{\rho}_{12}(g)
	\smat{\theta(x)&\\&1}^{-1}
\end{equation*}
is a deformation of $\rho_{21}$ to $R_{12}$
and the induced map
$\alpha\colon R_{21}\to R_{12}$ is an isomorphism.
Moreover, the following diagram is commutative.
From now on we identify 
$R_{21}$ with $R_{12}$ and
$\tilde{\rho}_{21}$ with 
$\tilde{\rho}_{12}^x$.
\begin{equation*}
	\begin{tikzcd}
		R_{21} \arrow[r,"\alpha"] &
		R_{12}\\
		R\arrow[u,"\theta_{21}"] \arrow[r,equal] &
		R\arrow[u,"\theta_{12}",swap]
	\end{tikzcd}
\end{equation*}

\begin{lem}\cite[Prop B.26]{pask}
\label{lem:B26}
The modules
$\Hom_{\Gp}(\tilde{\rho}_{12}, \tilde{\rho}_{21})$ and
$\Hom_{\Gp}(\tilde{\rho}_{21}, \tilde{\rho}_{12})$
are free of rank one over $R\cong R_{12}$ and
generated respectively by
\begin{equation}\label{eq:Phi_ij}
	\Phi_{12}=\smat{\theta(x)&\\&1} \text{ and }
	\Phi_{21}=\smat{1&\\&\theta(x)}.
\end{equation}
Moreover, the algebra
$\End_{\Gp}(\tilde{\rho}_{12}\oplus \tilde{\rho}_{21})$
is isomorphic to the generalized matrix algebra
$\smat{R& R\Phi_{12}\\ R\Phi_{21}& R}$.
In particular it is free of rank $4$ over $R$ and
its center is isomorphic to $R$.
\end{lem}

\subsection{Generically reducible block}

We briefly recall from \cite{pask} the results on
$p$-adic local Langlands for $\GL_2(\Qp)$ 
that will be relevant.
Following the notations in \textit{loc.cit.},
we temporarily let $G$, $K$ and $B=TN$ respectively
denote $\GL_2(\Qp)$, $\GL_2(\Zp)$,
the subgroup of upper triangular matrices in $\GL_2(\Qp)$
and its Levi decomposition.
We also identify the center $Z\subset T$ with $\Qp^\times$
and write $\bar{B}$ for
the subgroup of lower triangular matrices in $\GL_2(\Qp)$.


Let $\chi_1,\chi_2$ be characters satisfying
\eqref{cond:generic} and fix a continuous character 
$\zeta\colon \Gp\to \oo^\times$
such that $\epsilon\zeta\equiv \chi_1\chi_2$ 
modulo $\varpi$.
For the deformation rings
$R, R_{\red}, R_{12}$ and $R_{21}$
introduced earlier, we let 
$R^{\zeta\epsilon}, R^{\zeta\epsilon}_{\red}, 
R^{\zeta\epsilon}_{12}$ and $R^{\zeta\epsilon}_{21}$
denote the quotients that represent
deformations with the
fixed determinant $\epsilon\zeta$.
All the results in the last subsection
still hold true for these deformation rings,
except that the dimensions are decreased by $2$.

We identify $\chi_i$ with the characters
$\chi_i\circ \Art$ on $\Q^\times$,
where $\Art\colon \Qp^\times\to \Gp^{\textnormal{ab}}$
is the normalized reciprocity map
so that $\Fr\coloneqq \Art(p)$
is a geometric Frobenius.
We define the character
$\chi=\chi_1\otimes\chi_2\omega^{-1}$
of $T\cong \Qp^\times\times\Qp^\times$
and put $\chi^s(a,b)=\chi(b,a)$, so that 
$\chi^s\alpha=\chi_2\otimes \chi_1\omega^{-1}$
for $\alpha\coloneqq \omega\otimes\omega^{-1}$.
By \cite[Thm 30]{barthel},
the inductions
\[
\pi_1\coloneqq \Ind_{B}^G\chi\cong
\Ind_{B}^G\chi_1\otimes\chi_2\omega^{-1}\quad
\pi_2\coloneqq \Ind_{B}^G\chi^s\alpha\cong 
\Ind_{B}^G\chi_2\otimes\chi_1\omega^{-1} 
\]
are irreducible representations
in $\Mod^{\sm}_{G,\zeta}(\oo)$.

\begin{defn}\label{def:block}
Let $\Mod^{\lfin}_{G,\zeta}(\oo), \Mod^{\lfin}_{T,\zeta}(\oo)$
be the subcategories
of representations that are 
locally of finite length 
and with central character $\zeta$;
and let $\fC_G(\oo), \fC_T(\oo)$
be the dual categories
of the Pontryagin duals.
Then $\B\coloneqq\{\pi_1,\pi_2\}$,
for $\pi_1,\pi_2$ as above, is a block 
in the sense of \cite[\S 5]{pask}.
We then let $\Mod^{\lfin}_{G,\zeta}(\oo)^\B$
denote the subcategory
of representations whose subquotients
all belong to $\B$;
and $\fC_G(\oo)^\B$
be the category of Pontryagin duals.
\end{defn}

Let $\Ord\colon \Mod_{G,\zeta}^{\sm}(\oo)
\to \Mod_{T,\zeta}^{\sm}(\oo)$
denote Emerton's functor of $B$-ordinary parts.
When $V\in \Mod^{\sm}_G(\oo)$ and
$U\in \Mod^{\sm}_T(\oo)$,
the adjunction formula
from \cite[Thm 4.4.6]{emeI} states that
\begin{equation}\label{eq:adjunct}
	\Hom_{\oo[G]}(\Ind_{\bar{B}}^GU,V)
	\xrightarrow{\Ord}
	\Hom_{\oo[T]}(\Ord(\Ind_{\bar{B}}^GU),\Ord V)
	\cong
	\Hom_{\oo[T]}(U,\Ord V)
\end{equation}
is an isomorphism, where the last isomorphism
is induced by $\Ord(\Ind_{\bar{B}}^GU)\cong U$
from  \cite[Prop 4.3.4]{emeI}.

By \cite[Prop 7.1]{pask},
if $\iota\colon \pi_1\hookrightarrow \tilde{J}_1$
is the injective envelope of $\pi_1$
in $\Mod^{\lfin}_{G,\zeta}(\oo)$,
then we have $\Ord\pi_1=\Ord(\Ind_B^G\chi)=\chi^s$
and $\Ord(\iota)\colon \chi^s \to \Ord(\tilde{J}_1)$
is isomorphic to an injective envelope
$\tilde{J}_{\chi^s}$ of $\chi^s$
in $\Mod^{\lfin}_{T,\zeta}(\oo)$.
Furthermore, the morphism 
$\iota_1\colon \Ind_{\bar{B}}^G(\tilde{J}_{\chi^s})\to
\tilde{J}_1$
induced through the adjunction formula \eqref{eq:adjunct}
by a fixed isomorphism
$\tilde{J}_{\chi^s}\to \Ord_B(\tilde{J}_1)$
is injective.
To simplify notations,
we identify $\Mod^{\lfin}_{T,\zeta}(\oo)$
with $\Mod^{\lfin}_{\Qp^\times}(\oo)$ through 
the map $\Qp^\times\cong \{\smat{1&\\&*}\}\subset T$
and write $\tilde{J}_{\chi_1}=\tilde{J}_{\chi^s}$.
Then for $ \tilde{J}_{\chi_2}$
and $ \tilde{J}_2$ defined as above
we also have the injective morphisms
$\iota_2\colon \Ind_{\bar{B}}^G(\tilde{J}_{\chi_2})\to
\tilde{J}_2$.


\begin{lem}\cite[Cor 7.7]{pask}
\label{lem:proj_enve}
Let $\tilde{P}_{\chi_i^\vee}\coloneqq \tilde{J}_{\chi_i}^\vee
\in\fC_T(\oo)$ and
$\tilde{M}_i\coloneqq 
\Ind_{\bar{B}}^G(\tilde{J}_{\chi_i})^\vee,
\tilde{P}_i\coloneqq \tilde{J}_i^\vee\in\fC_G(\oo)$
for $i=1,2$.
The morphisms
$p_i\colon \tilde{P}_i\twoheadrightarrow \tilde{M}_i$
that are dual to
$\iota_i\colon 
\Ind_{\bar{B}}^G(\tilde{J}_{\chi_i})\hookrightarrow 
\tilde{J}_i$ 
extend to the exact sequences
\begin{equation}\label{eq:exact_PPM}
	0\to \tilde{P}_{2}\xrightarrow{\phi_{12}} 
	\tilde{P}_{1}\xrightarrow{p_1} \tilde{M}_1\to 0 
	\text{ and }
	0\to \tilde{P}_{1}\xrightarrow{\phi_{21}} 
	\tilde{P}_{2}\xrightarrow{p_2} \tilde{M}_2\to 0
\end{equation}
\end{lem}

Let $\Rep_{\Gp}(\oo)$
be the category of compact $\oo$-modules with
continuous actions of $\Gp$,
and $\V\colon \fC_G(\oo)\to \Rep_{\Gp}(\oo)$
be the Colmez functor introduced 
in \cite[\S 5.7]{pask},
which is exact and covariant.
By \cite[Cor 8.7]{pask},
for $(i,j)=(1,2)$ or  $(2,1)$,
there exists unique non-split extensions
in $\Mod^{\sm}_{G,\zeta}(\oo)$ 
\[
	0\to \pi_2\to \kappa_{12}\to \pi_1\to 0,\quad
	0\to \pi_1\to \kappa_{21}\to \pi_2\to 0
\]
such that
$\V(\pi_i^\vee)=\chi_i$, $\V(\kappa_{ij}^\vee)=\rho_{ij}$,
and $\V(\tilde{P}_j)=\tilde{\rho}^{\zeta\epsilon}_{ij}$
are the universal deformations
with determinant $\zeta\varepsilon$.

It then follows from \cite[Lem 8.10]{pask} that 
taking the Colmez functor 
$\V$ induces the isomorphisms below.
\begin{equation}\label{eq:end_deform}
\begin{split}
	\End_{\fC_{G}(\oo)}(\tilde{P_2})\cong 
    R^{\zeta\epsilon}_{12}\cong R^{\zeta\epsilon},\quad
	\Hom_{\fC_G(\oo)}(\tilde{P}_2, \tilde{P}_1)\cong
    R^{\zeta\epsilon}\Phi_{12}\\
	\Hom_{\fC_G(\oo)}(\tilde{P}_1, \tilde{P}_2)\cong
    R^{\zeta\epsilon}\Phi_{21},\quad
	\End_{\fC_{G}(\oo)}(\tilde{P_1})\cong 
    R^{\zeta\epsilon}_{21}\cong R^{\zeta\epsilon}
\end{split}
\end{equation}
Write $ \tilde{P}_\B=\tilde{P}_1\oplus \tilde{P}_2$,
then $\tilde{E}_\B\coloneqq
\End_{\fC_G(\oo)}(\tilde{P}_\B)$
is isomorphic to 
$\End_{\Gp}(\tilde{\rho}^{\zeta\epsilon}_{12}\oplus
\tilde{\rho}^{\zeta\epsilon}_{21})$.

Also,  by \cite[Prop 7.1]{pask}
every morphism from $\tilde{P}_i$ to $\tilde{M}_i$
factors through $p_i$.
Applying the adjunction formula \eqref{eq:adjunct} shows that
$\Hom_{\fC_G(\oo)}(\tilde{P}_i, \tilde{M}_i)=
\End_{\fC_G(\oo)}(\tilde{M}_i)$
are isomorphic to 
$\End_{\fC_T(\oo)}(\tilde{P}_{\chi_i^\vee})$,
which is isomorphic by \cite[Prop 3.34]{pask} to
a formal power series ring
$ \oo\llbracket x,y\rrbracket$
of two variables.

\begin{lem}\label{lem:ker_red}
	The kernel of the homomorphism
    $p_i\colon R^{\zeta\epsilon}\cong
    \End_{\fC_G(\oo)}(\tilde{P}_i)\twoheadrightarrow
	\End_{\fC_G(\oo)}(\tilde{P}_i, \tilde{M}_i)$
	is the reducibility ideal $\tau\subset R^{\zeta\epsilon}$.
    In other word the functor $\Ord$ induces
	\begin{equation}
	R^{\zeta\epsilon}_\red\cong 
	\Hom_{\fC_G(\oo)}(\tilde{P}_i, \tilde{M}_i)\cong
	\End_{\fC_G(\oo)}(\tilde{P}_{\chi_i^\vee})\cong
	\oo\llbracket x,y\rrbracket
	\end{equation}
\end{lem}
\begin{proof}
It suffices to show that 
the image of $\tau$ consists of 
$\phi\in \End_{\fC_G(\oo)}(\tilde{P}_i)$
such that $p_i\circ \phi$ is trivial.
Apply $\Hom(\tilde{P}_j,*)$
to the following exact sequences
from \eqref{eq:exact_PPM}.
\[
\begin{tikzcd}
	0 \arrow[r]&
	\tilde{P}_1  \arrow[r,"\phi_{21}"]  &
	\tilde{P}_2 \arrow[r,"p_2"] \arrow[dr,equal] &
	\tilde{M}_2  \arrow[r] & 0 \\
	0 & 
	\tilde{M}_1 \arrow[l]&
	\tilde{P}_1 \arrow[l,"p_1",swap]  &
	\tilde{P}_2  \arrow[l,"\phi_{12}",swap]  & 
	0  \arrow[l] 
\end{tikzcd}
\]
The adjunction formula implies that
$\Hom_{\fC_G(\oo)}(\tilde{P}_j,\tilde{M}_i)\cong
\Hom_{\fC_T(\oo)}
(\tilde{P}_{\chi_j^\vee},\tilde{P}_{\chi_i^\vee})$,
which are zeros for $i\neq j$
since blocks in $\fC_T(\oo)$ are singletons
by the discussion in \cite[\S 7.2]{pask}.
Consequently there are isomorphisms
\[
	\phi_{12}\circ\colon
	\End_{\fC_G(\oo)}(\tilde{P}_2)\cong
	\Hom_{\fC_G(\oo)}(\tilde{P}_2, \tilde{P}_1)\quad
	\phi_{21}\circ\colon
	\End_{\fC_G(\oo)}(\tilde{P}_1)\cong
	\Hom_{\fC_G(\oo)}(\tilde{P}_1, \tilde{P}_2)
\]
Combined with the isomorphisms in \eqref{eq:end_deform},
we may assume that $\V(\phi_{ij})$ agree with 
$\Phi_{ij}$ in \eqref{eq:Phi_ij}.
Thus the image of 
$\phi_{ij}\circ\phi_{ji}\in \End_{\fC_G(\oo)}(\tilde{P}_i)$,
which belongs to the kernel in question,
corresponds to the generator 
$\xx=\Phi_{ij}\circ\Phi_{ji}$ of 
$\tau\subset R^{\zeta\epsilon}$.
Now the lemma follows 
since $R^{\zeta\epsilon}$ is formally smooth of relative dimension  $3$.
\end{proof}

\subsubsection{Univeral unitary completion}

Let $\Ban(E)$
denote the category of admissible $E$-Banach space
representations of $G$ with central character $\zeta$
as defined in \cite{pask}.
Identify the center of $\fC_G(\oo)^\B$ with $R^{\zeta\epsilon}$,
then $R^{\zeta\epsilon}[\frac{1}{p}]$ acts on objects of $\Ban(E)^{\B}$.
If $\fn\subset R^{\zeta\epsilon}[\frac{1}{p}]$ 
is a maximal ideal,
let $\Irr(\fn)$ denote the set of
irreducible representations in  $\Ban(E)^{\B}$
on which the action of $R^{\zeta\epsilon}[\frac{1}{p}]$ 
factors through $\fn$.

On the other hand,
let $T\colon \Gp\to R^{\zeta\epsilon}$ 
and $T_\fn\colon \Gp\to R^{\zeta\epsilon}[\frac{1}{p}]/\fn$ 
denote the universal deformation and 
the reduction.
Enlarge $E$ if necessary,
we assume $R^{\zeta\epsilon}[\frac{1}{p}]/\fn\cong E$.
Then there exists 
the unique semi-simple Galois representation
$r_{\fn}\colon \Gp\to \GL_2(E)$
such that $\mtr r_{\fn}=T_{\fn}$.
When $r_\fn$ is potentially semi-stable,
we let $\Delta_{\fn}$ denote
the associated Weil-Deligne representation 
on $D_{\pst}(r_\fn)$
and $\pi_{\fn}$ denote the smooth irreducible
$\GL_2(\Qp)$-representation attached to $\Delta_{\fn}$
by local Langlands correspondence.
We normalize the correspondence so that 
when $r_{\fn}$ is crystalline, 
thus $\Delta_{\fn}$
is the sum of unramified characters $\mu_1$ and $\mu_2$,
the representation $\pi_\fn$ 
is the smooth un-normalized induction
$\Ind_B^G(\mu_1\otimes\mu_2|\cdot|^{-1})_{\sm}$.
This is the Hecke correspondence used in \cite{pan}.

\begin{rem}
	The representation 
	$\Ind_B^G(\mu_1\otimes\mu_2|\cdot|^{-1})_{\sm}$
	is irreducible since otherwise
	$T_\fn$ would be of the form
	$\eta+\eta\epsilon$ for some character  $\eta$,
    which contradicts 
    the assumption \eqref{cond:generic}.
\end{rem}

\begin{lem}\label{lem:uni_completion}
	Suppose $r_\fn$ is crystalline of
	Hodge-Tate weights $\{-l,-l-k\}$
    up to twisting by a finite character.
    Let $\pi_{-l,1-l-k}^*\cong W_{l,k}\coloneqq
    \Sym^{k-1}\otimes\det^l$, which is the contragredient of
    the algebraic $\GL_2$-representation
    with highest weight $(-l,1-l-k)$.
	Then the universal unitary completion of 
	$\pi_\fn\otimes \pi_{-l,1-l-k}^*(E)$ belongs to 
	$\Irr(\fn)$.
\end{lem}
\begin{proof}
    By assumptions $r_{\fn}$ is potentially semi-stable and
    $\pi_{\fn}$ is a smooth irreducible principal series.
    When $r_\fn$ is irreducible, $\Irr(\fn)$
    has only one object by \cite[Cor 8.14]{pask},
    which we denote by $\Pi_{\fn}$.
    On the other hand,
    the universal unitary completion $\Pi$ in question
    is a non-ordinary admissible absolutely 
    irreducible $E$-Banach space representation
    by \cite[Thm 12.3]{pask},
    and the $(\varphi,N)$-module
    associated to which
    coincides with $D_{\pst}(r_\fn)$
    by \cite[Thm. 1.3]{CDP}.
    Since the same is true for $\Pi_{\fn}$
    by definition,
    it follows from the same theorem
    that $\Pi=\Pi_{\fn}\in \Irr(\fn)$.

	When  $r_\fn$ is reducible
	and $T_\fn=\psi_1+\psi_2$
	for characters
	$\psi_i\colon \Gp\to E^\times$,
	say of Hodge-Tate weights
	$-l-k$ and  $-l$ respectively,
	then $\pi_\fn=\Ind_B^G(\mu_1\otimes\mu_2|\cdot|^{-1})$
	for the charaters
	\[
	\mu_1=\psi_1(\epsilon|\cdot|^{-1})^{-l-k},\quad
	\mu_2=\psi_2(\epsilon|\cdot|^{-1})^{-l}	
	\]
	By \cite[Thm 12.3]{pask} the universal unitary completion
	of $\pi_\fn\otimes W_{l,k}$
	is $\Ind_B^G(\psi)_{cont}$ for
	\[
		\psi( (\begin{smallmatrix}
			a&b\\&d
		\end{smallmatrix}))
		=\mu_2(a)a^l\mu_1(d)|d|^{-1}d^{l+k-1}
		=\psi_2(a)\psi_1\epsilon^{-1}(d)
	\]
	since $\val_p(\mu_2(p))=-l$ and $\varepsilon(a)=a|a|$.
    And the lemma follows since
	by \cite[Cor 8.15]{pask}
	\[
	\Irr(\fn)=\{(\Ind_B^G\psi_1\otimes\psi_2\varepsilon^{-1})_{cont},
	(\Ind_B^G\psi_2\otimes\psi_1\varepsilon^{-1})_{cont}\}.
	\]
\end{proof}

\subsection{Local-global compatibility}
\label{sub:compatible}

We now resume to previous notations and settings.
Recall that $\fm\subset \TT(U^p,\oo)$ 
is a maximal ideal such that
$T_\fm\bmod\fm =\bar{\delta}_1+\bar{\delta}_2$
for characters $\bar{\delta}_i\colon \Gal_\K\to \fF^\times$
satisfying \eqref{cond:red_gen}.
For the same reaseon in \cite[Rem 3.5.3]{pan},
we normalize $T_\fm$ by the cyclotomic character so that
\[
    \epsilon T_\fm=\omega\chi_1+\omega\chi_2\mod\fm.
\]
Therefore the pair fo characters
$\chi_i\coloneqq \omega\bar{\delta}_i\vert_{\Gp}$
satisfies \eqref{cond:generic} because of 
\eqref{cond:red_gen}.
Let $T\colon \Gp\to R$
denote the universal deformation 
of $\chi_1+\chi_2$
and $\B=\{\pi_1,\pi_2\}$
be the associated block of irreducible of $\GL_2(\Qp)$-representations.
By the universal property
there exists homomorphisms of $R$
to the Noetherian finite level
Hecke operators $\TT(U^p\Iw^P(p^{b,b}),\oo)_\fm$
that push the $T$ to 
$\epsilon\cdot T(U^p\Iw^P(p^{b,b}))_\fm\vert_{\Gp}$.
Then the inverse limit of which
gives the homomorphism
\begin{equation}\label{eq:RtoT}
    R\to \TT(U^p,\oo)_{\fm}=
    \varprojlim_b\TT^P(U^p,\Iw^P(p^{b,b}),\oo)_{\fm}
\end{equation}
that pushes $T$ to $\epsilon T_\fm\vert_{\Gp}$.
Note that the homomorphism has to be defined this way
since we do not know a priori whether
$\TT(U^p,\oo)_{\fm}$ is Noetherian.

In order to apply the results recalled earlier,
we need to follow the approach in \cite[\S 5]{urban}
and twist the $\GL_2(\Qp)$-action on 
$\Ord_P(S(U^p,E/\oo))_\fm$.
To this end we fix a crystalline character
$\zeta\colon \Gp\to \oo^\times$
such that $\epsilon\zeta=\chi_1\chi_2$
and let 
$T^{\zeta\epsilon}\colon \Gp\to R^{\zeta\epsilon}$
be the universal deformation
with determinant $\zeta\epsilon$.

Let $\fm_R\subset R$ be the maximal ideal.
Since $\det T\equiv \zeta\epsilon\bmod \fm_R$ and $p$ is odd,
there exists a character
\begin{equation}\label{eq:root_char}
	\xi^{1/2}
    \colon \Gp\to 1+
    \fm_{R},
    \, \text{ such that }
	\xi\coloneqq(\xi^{1/2})^2=\epsilon\zeta(\det T)^{-1}.
\end{equation}
Consequently there exists a homomorphism 
$R^{\zeta\epsilon}\to R$ that pushes 
$T^{\zeta\epsilon}$ to $T'\coloneqq \xi^{1/2}T$.
We write $\xi_\fm^{1/2}\colon \Gp\to \TT(U^p,\oo)_\fm$
for the composition of $\xi^{1/2}$ with \eqref{eq:RtoT}.
Then as $T$ is sent to $\epsilon T_\fm$ by \eqref{eq:RtoT} we have
\begin{equation}\label{eq:root_charm}
	\xi_\fm\coloneqq (\xi_\fm^{1/2})^2=
	\epsilon\zeta(\det \epsilon T_\fm)^{-1}\vert_{\Gp}
	=\zeta(\epsilon\det T_\fm)^{-1}\vert_{\Gp}.
\end{equation}


\begin{defn}\label{def:twist}

Let $\Qp^\times$ be the central torus in $\GL_2(\Qp)$, and 
\begin{align*}
\text{ for }
Q&=\GL_2(\Qp)\times \prod_{w'\in\Sigma_p\setminus{w_0}}T(\K_{w'}) & 
\text{define }\,
Q'&=T(\Qp)\times Z_Q=\GL_2(\Qp)\times 
\big(\Q^\times\prod_{w'\in\Sigma_p\setminus{w_0}}T(\K_{w'})\big),\\
T&=\GL_2(\Qp)\times \prod_{w'\in\Sigma_p\setminus{w_0}}T(\K_{w'}) & 
T'&=T(\Qp)\times Z_Q=T(\Qp)\times 
\big(\Q^\times\prod_{w'\in\Sigma_p\setminus{w_0}}T(\K_{w'})\big),\\
\end{align*}
We define $\Ord_P(S(U^p,E/\oo))_{\fm}'$
to be the $Q'$-representation on
$\Ord_P(S(U^p,E/\oo))_{\fm}$,
where the action of $Z_Q$ is as usual
but the $\GL_2(\Qp)$-action is twisted by 
$(\xi_{\fm}^{1/2}\circ\Art)$.
The $T'$-representation
$S^{\ord}(U^p,\oo)_\fm'$
is then defined by a similar twist on $T(\Qp)$.
We also write $M(U^p)'_\fm$ and $M^{\ord}(U^p)'_\fm$
for the Pontryagin duals.
\end{defn}

\begin{prop}\label{lem:twist}
The twist $\Ord_P(S(U^p,E/\oo))_\fm'$
has the following properties.
\begin{enumerate}
\item There exists a homomorphism 
$R^{\zeta\epsilon}\to \TT(U^p,\oo)_\fm$
that pushes $T^{\zeta\epsilon}$ to 
$T_\fm'\coloneqq \xi_{\fm}^{1/2}\epsilon T_\fm\vert_{\Gp}$.

\item The Hecke algebra $\TT(U^p,\oo)_{\fm}$
acts on $\Ord_P(S(U^p,E/\oo))_\fm=\Ord_P(S(U^p,E/\oo))_\fm'$
as usual.

\item For $w'\in \Sigma_p\setminus{w_0}$,
the action of $T(\K_w)=\K_w^2$ on
$\Ord_P(S(U^p,E/\oo))_\fm=\Ord_P(S(U^p,E/\oo))_\fm'$
coincides with the action induced by
the characters $\Psi_{w',1}\otimes\Psi_{w',2}$ from
Proposition \ref{prop:big_char_at_p}.
\item For $w=w_0$,
the action of $\Qp^\times$ on
$\Ord_P(S(U^p,E/\oo))_\fm=\Ord_P(S(U^p,E/\oo))_\fm'$
coincides with the action induced by
$(\epsilon\det T_\fm)\vert_{\Gp}\circ \Art$.
\item
The $\GL_2(\Qp)$-action on $\Ord_P(S(U^p,E/\oo))_\fm'$.
has central character $\zeta$.
\item 
As a $Q'$-representation
$\Ord_P(S(U^p,E/\oo))_\fm'$ is admissible.
\end{enumerate}
\end{prop}

\begin{proof}

The first three statements follows directly by definition.
For the fourth, the same argument in the proof of
Proposition \ref{prop:big_char_at_p} shows that 
\[
    (\epsilon \det T_\fm)\vert_{\Gp}\circ \Art(p)=
    U_{p}^{(2)}\coloneqq h_U(\smat{p&\\&p})\quad
    (\epsilon \det T_\fm)\vert_{\Gp}\circ \Art(x)=
    \langle \smat{x&\\&x}\rangle
    \coloneqq h_U(\smat{x&\\&x})\text{ for }x\in\Zp^\times,
\]
which coincides with the central action of $\Qp^\times$ on
$\Ord_P(S(U^p,E/\oo))_\fm=\Ord_P(S(U^p,E/\oo))_\fm'$.
Compare with \eqref{eq:root_charm}
and we see that the $\GL_2(\Qp)$-action
has central character $\zeta$.

For the last statement,
if suffices to show that the $\Qp^\times$-action
via $\xi_\fm^{1/2}$ is admissible.
Since the original $\Qp^\times$-action is locally admissible,
the action of $\xi_\fm$ on
any $f\in \Ord_P(S(U^p,E/\oo))_\fm$
is trivial on some open subgroup of $\Zp^\times$.
The same is therefore true for $\xi_\fm^{1/2}$ as well
since $p$ is odd.
Consequently the twisted $\GL_2(\Qp)$-action
is still locally admissible.

\end{proof}


\begin{prop}\label{prop:twist_ord}
The twist $S^{\ord}(U^p,E/\oo)_\fm'$
has the following properties.
\begin{enumerate}
\item The Hecke algebra $\TT^{\ord}(U^p,\oo)_{\fm}$
acts on $S^{\ord}(U^p,E/\oo)_\fm=S^{\ord}(U^p,E/\oo)_\fm'$
as usual.

\item The action of $Z_Q$ on
$S^{\ord}(U^p,E/\oo)_\fm=S^{\ord}(U^p,E/\oo)_\fm'$
is as described in last proposition.

\item For $w=w_0$,
the action of $T(\Qp)=\Qp^2$ on $S^{\ord}(U^p,E/\oo)_\fm'$
coincides with the action induced by the character
$\xi_\fm^{1/2}\Psi_{w,1}\otimes \xi_\fm^{1/2}\Psi_{w,2}$
from Proposition \ref{prop:big_char_at_p}
and has central character $\zeta$.

\item 
Let $\Ord\colon \Mod^{\sm}_{\GL_2(\Qp)}(\oo)
\to \Mod^{\sm}_{T(\Qp)}(\oo)$ denote the Emerton's
functor of $B(\Qp)$-ordinary parts.
Then $\Ord(\Ord_P(S(U^p,E/\oo))_\fm')=S^{\ord}(U^p,E/\oo)_\fm'$.

\end{enumerate}
\end{prop}
\begin{proof}
The above statements either follows directly from 
the definition or can be proved by the same way
as the previous proposition.
\end{proof}


It follows that
$M(U^p)_{\fm}'\in \fC(\oo)$, the category of
$\Mod^{\lfin}_{\GL_2(\Qp),\zeta}(\oo)$,
as a $\GL_2(\Qp)$-representation.
Recall that $R^{\zeta\epsilon}$
is isomorphic to the center of the subcategory $\fC(\oo)^{\B}$
and acts on any object of which.

\begin{prop}\label{prop:compatibility}
    The restriction of  $M(U^p)_{\fm}'$ to $\GL_2(\Qp)$
    belongs to $\fC(\oo)^{\B}$
	and the $R^{\epsilon\zeta}$-action on which
    as the center of the category
	factors through $\TT(U^p,\oo)_\fm$.
\end{prop}

\begin{proof}

Let $\pi$ be an irreducible constituent of
the $G(\A_f)$-representation $S_{\wt{k}}(\bar{\Q}_p)$
that belongs to a minimal prime
$\fp\subset \TT_{\wt{k}}^P(U^p\Iw^P(p^{0,1}),E)_{\fm}$.
Then $\pi_{\fp}\coloneqq\pi_{w_0}$
is an unramified $\GL_2(\Qp)$-representation
and corresponds to the crystalline $\Gp$-representation
$r_\fp\vert_{\Gp}$ by Lemma \ref{lem:galois_at_p}.
The beginning of the proof of
Proposition \ref{prop:wt_space} shows that 
$S_{\wt{k}}^{P-\ord}(U^p,\oo)\cong
\Hom_{\oo}(\pi_{\wt{k}}^*(\oo), S(U^p))$,
which give a homomorphism
\begin{equation}\label{eq:hom_wt}
    \pi_\fp\otimes \pi_{\wt{k}}^*(E)\to S(U^p)_\fm\otimes_{\oo}E
\end{equation}
between $\GL_2(\Qp)$-representations
after tensoring with $E$ since
$\pi_\fp\subset S^{P-\ord}_{\wt{k}}(U^p,E)$.


Let $\fn\subset R^{\zeta\epsilon}[\frac{1}{p}]$ be the kernel of 
$R^{\zeta\epsilon}[\frac{1}{p}]\to \TT(U^p,E)_{\fm}\to E_\fp$,
the composition of the homomorphism in Proposition \ref{lem:twist}
and $\lambda_\fp$.
Combine the strategy of the proof of \cite[Thm 3.5.5]{pan}
with Corollary \ref{cor:density},
it suffices to show that
the universal unitary completions of
the twist of $\pi_{\fp}\otimes\pi_{\wt{k}}^*(E)$
by $\xi_\fm^{1/2}$ belongs to $\Irr(\fn)$.

Since $w_0\in \Sigma_p$ is of degree one
there is a unique embedding $\sigma$ in $I_{w_0}$.
Write $k_1=k_{\sigma,1}$ and $k_2=k_{\sigma,2}$,
then $r_\fp\vert_{\Gp}$ is crystalline
of Hodge-Tate weights  $k_1+1,k_2$
and $\epsilon\det r_{\fp}$
is of Hodge-Tate weight $k_1+k_2$.
Define $\xi_\fp^{1/2}=\lambda_\fp\circ \xi_\fm^{1/2}$
so that $\xi_\fp\coloneqq(\xi_\fp^{1/2})^2=
\zeta(\epsilon\det r_\fp)^{-1}$.
Suppose $\zeta$ has Hodge-Tate weight $w_0$,
then the Hodge-Tate weight $w_0-(k_1+k_2)$ of
$\xi_\fp$ is even as $\xi_\fp$
is congruence to the trivial character.
Therefore the character $\xi_{\fp}^{1/2}$
is crystalline of Hodge-Tate weight 
$w_{\fp}\coloneqq \frac{1}{2}(w_0-k_1-k_2)$ 
up to a quadratic twist.

Now the representation
$r_{\fp}\vert_{\Gp}(\xi_{\fp}^{1/2}\epsilon)$
is crystalline up to a quadratic twist
and has Hodge-Tate weights  $\{k_1',k_2'-1\}$ 
for $k_1'=k_1+w_\fp, k_2'=k_2+w_\fp$.
And $\pi_\fp(\xi_\fp^{1/2}(\epsilon|\cdot|^{-1})^{w_\fp})$
is the smooth irreducible
representation associated to 
$D_{\pst}(r_{\fp}(\xi_\fp^{1/2}\epsilon))$
since $\pi_\fp$ is associated to 
$D_{\pst}(r_{\fp}(\epsilon))$.
Now twist \eqref{eq:hom_wt} by $\xi_\fm^{1/2}$ gives
\[
    (\pi_{\fp}\otimes \pi_{\wt{k}}^*(E))(\xi_\fp^{1/2})=
    \pi_\fp(\xi_\fp^{1/2}(\epsilon|\cdot|^{-1})^{w_\fp})
    \otimes \pi_{\wt{k}}^*(E)(\epsilon|\cdot|^{-1})^{-w_{\fp}} \to 
    S(U^p)_\fm'\otimes_{\oo}E
\]
Since  $T_\fn=\mtr(r_{\fn}\vert_{\Gp}(\xi_\fm^{1/2}\epsilon))$
and $\pi_{\wt{k}}^*(E)(\epsilon|\cdot|^{-1})^{-w_{\fp}}\cong 
\pi_{k_1',k_2'}^*(E)$,
it follows from Lemma \ref{lem:uni_completion}
that the universal completion of 
$(\pi_{\fp}\otimes \pi_{\wt{k}}^*(E))(\xi_\fp^{1/2})$
does belong to $\Irr(\fn)$.
\end{proof}

The proposition implies that
all the irreducible $\GL_2(\Qp)$-subquotients
of $\Ord_P(S(U^p,E/\oo))_\fm'$ are 
isomorphic to either $\pi_1$ or $\pi_2$.
On the other hand, the action of $Z_Q$
on $\Ord_P(S(U^p,E/\oo))_\fm'$ coincides 
with the character 
$Z_Q\to \TT(U^p,\oo)_{\fm}^{\times}$
described in Proposition \ref{lem:twist}.
By abuse of notation,
let $\upsilon\colon Z_Q\to \TT^P(U^p,\oo)/\fm=\fF^\times$
denote the residual character
and view $\pi_1,\pi_2$
as $Q'$-representations,
with $Z_Q$ acting by $\upsilon$,
then all the irreducible $Q'$-subquotients
of $\Ord_P(S(U^p,E/\oo))_\fm'$ are 
isomorphic to either $\pi_1$ or $\pi_2$.
We similarly view $\chi^s$ and $\chi\alpha^s$
as $T'$-representations
with $Z_Q$ acting by $\upsilon$.

\begin{defn}

We let $\Mod^{\lfin}_{Q',\zeta}(\oo)$
and $\Mod^{\lfin}_{T',\zeta}(\oo)$
denote the categories of smooth representations of 
$Q'$ and $T'$ that are locally of finite type
whose restriction to $\GL_2(\Qp)$ or $T(\Qp)$
has central character $\zeta$.
We also let $\fC_{Q'}(\oo), \fC_{T'}(\oo)$
denote the category of Pontryagin duals.
When the context is clear,
we will simply write $\Hom_{Q'}$ and $\Hom_{T'}$
for the space of homomorphisms.
\end{defn}

\begin{lem}\label{lem:end_comp}
Let $\tilde{P}$ be the projective envelope of 
$\upsilon^\vee\in \fC_{Z_Q}(\oo)$, the category
of Pontryagin duals of $\Mod_{Z_Q}^{\lfin}(\oo)$,
and $\tilde{E}\coloneqq\End_{\fC_{Z_Q}(\oo)}(\tilde{P})$.
Then $\tilde{P}$ is isomorphic to 
the universal deformation of $\upsilon^{-1}$
and free of rank one over $\tilde{E}$.
More specifically,
let $Z_Q^\wedge$ denote the pro-$p$ completion of $Z_Q$,
\[
    \tilde{P}=\tilde{E}
    =\oo\llbracket Z_Q^\wedge\rrbracket
\]
where $Z_Q$ acts on $\tilde{P}$
by the product of the tautological character
and a lift of $\upsilon$.
\end{lem}
\begin{proof}
The same argument in \cite[Prop. 3.34]{pask} 
shows that $\tilde{P}$
is free of rank one over $\tilde{E}$
and we may assume $\upsilon$ is the trivial character.
The description of $\tilde{P}$ then follows from 
\cite[Cor. 3.27]{pask} and the proof of
\cite[Lem. 3.32]{pask}.
\end{proof}


\begin{prop}\label{prop:envelope}
    Write $\tilde{P}_{*,\fm}=
    \tilde{P}_*\hat{\otimes}_{\oo}\tilde{P}$
    for $\tilde{P}_*\in\{\tilde{P}_\B, \tilde{P}_1, \tilde{P}_2,
    \tilde{P}_{\chi_1^\vee}, \tilde{P}_{\chi_2^\vee}\}$
    introduced in Lemma \ref{lem:proj_enve}
	and write 
    $\tilde{E}_{\fm}=\tilde{E}_\B
	\hat{\otimes}_{\oo}\tilde{E},
    R_{\fm}=R^{\epsilon\zeta}
	\hat{\otimes}_{\oo}\tilde{E},
    R_{\fm}^\red=R^{\epsilon\zeta}_\red
	\hat{\otimes}_{\oo}\tilde{E},$.
	Then $\tilde{P}_{i,\fm}\in \fC_{Q'}(\oo)$
	is the projective envelope of $\pi_i^\vee$;
	$\tilde{P}_{\chi_1^\vee,\fm}, \tilde{P}_{\chi_1^\vee,\fm}
    \in \fC_{T'}(\oo)$ are the projective envelopes
	of $(\chi^s)^\vee$ and
    $(\chi\alpha^s)^\vee$ respectively.
    Moreover
    \begin{align}\label{eq:proj_0}
    &\Hom_{Q'}(\tilde{P}_{\B,\fm}, \tilde{P}_{\B,\fm}) \cong 
    \Hom_{\GL_2(\Qp)}(\tilde{P}_\B, \tilde{P}_\B)
    \hat{\otimes}_\oo \End_{\fC_{\Z_Q}(\oo)}(\tilde{P})\cong 
    \tilde{E}_\B \hat{\otimes}_\oo \tilde{E}
    = \tilde{E}_\fm\\\label{eq:proj_1}
    &\Hom_{Q'}(\tilde{P}_{i,\fm}, \tilde{P}_{j,\fm}) \cong 
    \Hom_{\GL_2(\Qp)}(\tilde{P}_{i}, \tilde{P}_{j})
    \hat{\otimes}_\oo \End_{\fC_{\Z_Q}(\oo)}(\tilde{P})\cong 
    R^{\zeta\epsilon} \hat{\otimes}_\oo \tilde{E}
    = R_\fm\\\label{eq:proj_2}
    &\End_{T'}(\tilde{P}_{\chi_i^\vee,\fm}) \cong 
    \End_{(\Qp^\times)^2}(\tilde{P}_{\chi_i^\vee})
    \hat{\otimes}_\oo \End_{\fC_{\Z_Q}(\oo)}(\tilde{P})\cong 
    R^{\zeta\epsilon}_\red \hat{\otimes}_\oo \tilde{E}
    =R_\fm^{\red}
    \end{align}
\end{prop}
\begin{proof}
    We first observe that any $Q'$-admissible vector 
	is $Z_Q$-finite by \cite[Lem 2.3.5]{emeI}
    and thus generates an admissible $Q'$-representation
    that is finitely-generated over $\GL_2(\Qp)$,
	which is also of finite length by \cite[Thm 2.3.8]{emeI}.
	In other word,
	any locally admissible $Q'$-representation 
	is also locally of finite length.
    That $\tilde{P}_{*,\fm}$ gives
    the corresponding projective envelops now follows from 
    \cite[Lem B.6]{GN}
	and the argument in \cite[Lem B.8]{GN}.
    And the isomorphisms 
    \eqref{eq:proj_1} and
    \eqref{eq:proj_2} follows respectively from  
    \eqref{eq:end_deform} and 
    Lemma \eqref{lem:ker_red}.
\end{proof}

\begin{cor}
Let $\Mod^{\lfin}_{Q',\zeta}(\oo)^{\B}$
denote the subcategory of $Q'$-representations
with all irreducible subquotients isomorphic 
to either $\pi_1$ or $\pi_2$
and $\fC_{\Q'}(\oo)^\B$ be the corresponding 
subcategory of $\fC_{\Q'}(\oo)$. Then
\begin{equation}\label{eq:anti_equiv}
        M  \mapsto 
        \mathbf{m}(M)\coloneqq 
        \Hom_{Q'}(\tilde{P}_{\B,\fm}, M)
\end{equation}
gives an equivalence between $\fC_{Q'}(\oo)^\B$
and the category of compact modules over 
$\tilde{E}_{\fm}$.
\end{cor}
\begin{proof}
This follows from the general formalism of abelian categories.
See also the proof of \cite[Prop.5.45]{pask}.
\end{proof}


\begin{cor}\label{cor:Hecke_Noetherian}
    The $\TT(U^p,\oo)_{\fm}$-module
	$\mathbf{m}\coloneqq \mathbf{m}(M(U^p)_{\fm}')$
	is finite faithful and $\TT(U^p,\oo)_{\fm}$
    is Noetherian.
\end{cor}
\begin{proof}
    Since $\TT(U^p,\oo)_\fm$ acts faithfully on 
    $M(U^p)_\fm'\in \fC_{Q'}(\oo)^\B$,
    it also acts faithfully on 
	$\mathbf{m}$
    by the previous corollary.
    Moreover, $\mathbf{m}$
    is finitely-generated  over $\tilde{E}_{\fm}$ 
    by \cite[Prop 4.17]{pask} since 
    $\Ord_P(S(U^p,E/\oo))'_{\fm}$ is $Q'$-admissible.
    Consequently it is also finite over  $R_{\fm}$
    by Lemma \ref{lem:B26}.
    It then follows from Proposition
    \ref{prop:compatibility}
    that  $\mathbf{m}(M(U^p)_{\fm}')$ is finite over 
    $\TT(U^p,\oo)_\fm$.

    We now have an injective $R_\fm$-algebra homomorphism 
	$\TT(U^p,\oo)_{\fm}\to\End_{R_{\fm}}(\mathbf{m})$.
    Since $\mathbf{m}$ is finite over $R_\fm$,
    so are $\End_{R_\fm}(\mathbf{m})$.
    Therefore $\TT(U^p,\oo)_\fm$
	is finite over $R_{\fm}$ and thus Noetherian.
\end{proof}


\subsection{Reducible part of completed homology}

We fix a generator $\xx$ of the reducibility ideal
$\tau=\ker(R^{\epsilon\zeta}\to R^{\epsilon\zeta}_{\red})$
and identify which with a generator of the natural map
$\ker(R_\fm\to R_\fm^{\red})$.
\begin{defn}
For any $R_{\fm}$-module $M$
we call $M^{\red}\coloneqq M/\xx M$
the reducible part of $M$.
\end{defn}
In this subsection we follow \cite{urban}
and relate $(M(U^p)_\fm')^{\red}$
with $S^{\ord}(U^p,E/\oo)_\fm'$.

\begin{lem}
	For some non-negative integer $r$
	there exists a projective resolution 
	\begin{equation}\label{eq:resolution}
	0\to \tilde{P}_{\B,\fm}^{\oplus r}\to 
	\tilde{P}_{\B,\fm}^{\oplus r}\to 
	M(U^p)_{\fm}'\to 0
	\end{equation}
\end{lem}
\begin{proof}
Identify $\Qp^\times$ with the center of $\GL_2(\Qp)$.
By \cite[Thm 33]{barthel} and \cite[Thm 19]{barthel}, 
there exists
smooth irreducible 
$\GL_2(\Zp)\Qp^\times$-representations $\sigma_i$
and exact sequences
\begin{equation}
	0\to 
	\cInd_{\GL_2(\Zp)\Qp^\times}^{\GL_2(\Qp)}\sigma_i\to
	\cInd_{\GL_2(\Zp)\Qp^\times}^{\GL_2(\Qp)}\sigma_i\to
	\pi_i\to 0
\end{equation}
Let $Z_Q$ act on above by $\upsilon$
and apply $\Ext^i_{Q'}(*,S')$
for $S'=\Ord_P(S(U^p,E/\oo))_{\fm}'$,
we obtain
\begin{equation*}
    \begin{tikzcd}[row sep=2ex]
	    \Ext^{i-1}_{Q'}
	    (\pi, S')\arrow[r] &
	    \Ext^{i}_{Q'}
        (\cInd_{KZ\times Z_Q}^{Q'}\sigma, S')
	    \arrow[r] \arrow[d,equal] &
	    \Ext^{i}_{Q'}
        (\cInd_{KZ\times Z_Q}^{Q'}\sigma, S')
	    \arrow[r] \arrow[d,equal] &
	    \Ext^{i}_{Q'}(\pi, S')\\ 
	 & \Ext^i_{\GL_2(\Zp)\times Z_Q}(\sigma ,S') &
	    \Ext^i_{\GL_2(\Zp)\times Z_Q}(\sigma ,S') &
    \end{tikzcd}
\end{equation*}
for $K=\GL_2(\Zp)$ and $Z=\Qp^\times$.
By Lemma \ref{lem:inj}
the restriction of $\Ord_P(S(U^p,E/\oo))_\fm$ to $K$
is an injective object.
Since lemma \ref{lem:twist} and \eqref{eq:root_charm} imply that 
the restriction of $\xi_{\fm}^{1/2}\circ \Art$ to $\Zp^\times$
factors through  $\oo\llbracket 1+p\Zp\rrbracket$,
we can apply the twist to all smooth $K$-representations.
In particular as a $K$-representation
the twist $S'=\Ord_P(S(U^p,E/\oo))_\fm'$
is still an injective object.
Therefore the long exact sequence reduces to 
the following sequence, where
all the terms are finite-dimensional over $\fF$
since $S'$ is $Q'$-admissible.
\begin{equation*}
	0 \to \Hom_{Q'}(\pi_i,S')\to 
	\Hom_{\GL_2(\Zp)\times Z_Q}(\sigma_i,S')\to 
	\Hom_{\GL_2(\Zp)\times Z_Q}(\sigma_i,S')\to 
	\Ext^1_{Q'}(\pi_i,S')\to 0
\end{equation*}



Write $a_i\coloneqq \dim_{\fF} \Hom_{Q'}(\pi_i,S')=
\dim_{\fF} \Ext^1_{Q'}(\pi_i,S')$
so that $\soc(S')=\pi_1^{a_1}\oplus \pi_2^{a_2}$.
Let $\tilde{J}_{i,\fm}$ denote 
the injective envelope of $\pi_i$.
Then the injective envelope 
$\soc(S')\hookrightarrow \tilde{J}=
\tilde{J}_{1,\fm}^{'a_1}\oplus \tilde{J}_{2,\fm}^{'a_2}$
factors through an injective morphism 
$\phi_0\colon S'\to \tilde{J}$
since the inclusion $\soc(S')\hookrightarrow S'$
is essential.
Apply the same construction 
to $\soc(\coker(\phi_0))$
and use $\dim_{\fF}\Hom_{Q'}(\pi_i, \coker(\phi_0))=
\dim_{\fF}\Ext^1_{Q'}(\pi_i, S')=a_i$
gives another injective morphism
$\phi_1\colon \coker(\phi_0)\to \tilde{J}$,
which is surjective as 
$\Hom(\pi_i,\coker(\phi_1))
\cong \Ext^1(\phi_i,\coker(\phi_0))
\cong \Ext^2(\pi, S')=0$.
Now the lemma follows by picking
$r=\max\{a_1,a_2\}$ and taking the Pontryagin dual.
\end{proof}

Let 
$A\colon \tilde{P}_{\B,\fm}^{\oplus r}\to\tilde{P}_{\B,\fm}^{\oplus r}$ 
denote the morphism in \eqref{eq:resolution} and
identify $\Phi_{ij}$ with $\Phi_{ij}\otimes \id_{\tilde{P}}\in
\Hom_{Q'}(\tilde{P}_{j,\fm},\tilde{P}_{i,\fm})$.
By \eqref{eq:proj_1}
the morphism $A$
can be represented by a matrix
$A=\smat{A_{11} & A_{12}\Phi_{12}\\A_{21}\Phi_{21} & A_{22}}$,
where $A_{ij}\in M_r(R_{\fm})$.
By Lemma \ref{lem:proj_enve}
and Lemma \ref{lem:ker_red} we have
$\Ord(\tilde{P}_{i,\fm}^\vee)^\vee\cong 
\tilde{P}_{\chi_i^\vee,\fm}$
and $\Ord(A)$ is represented by the matrix
$\smat{\tilde{A}_{11} & \\& \tilde{A}_{22}}$,
where $\bar{A}_{ij}\in M_r(R^{\red}_{\fm})$ are 
the reductions of the matrices.
Apply the right exact functor
$\Ord$ to 
\eqref{eq:resolution} gives
\begin{equation}\label{eq:exact_ord}
	\tilde{P}_{\chi_1^\vee,\fm}^{\oplus r}\oplus 
	\tilde{P}_{\chi_2^\vee,\fm}^{\oplus r}
	\xrightarrow{\overline{A}_{11}\oplus\overline{A}_{22}}
	\tilde{P}_{\chi_1^\vee,\fm}^{\oplus r}\oplus 
	\tilde{P}_{\chi_2^\vee,\fm}^{\oplus r}
	\to M^{\ord}(U^p)_\fm'\to 0
\end{equation}
It follows that 
$M^{\ord}(U^p)_\fm'$ is the direct sum of
$M^{\ord}(U^p)_{\fm,i}'\coloneqq \coker(\bar{A}_{ii})$,
on which the action of 
$\Qp^\times=\{\smat{1&\\&*}\}\subset \GL_2(\Qp)$
has all irreducible subquotients
isomorphic to $\chi_i^\vee$.

\begin{cor}\label{cor:two_max}
There are only two maximal ideals 
$\fm_1,\fm_2$ in $\TT^{\ord}(U^p,\oo)_{\fm}$,
which are determined by 
$\Psi_{2,w_0}\bmod \fm_i=\chi_i$,
and $M^{\ord}(U^p)_{\fm,i}'=M^{\ord}(U^p)_{\fm_i}$
as $\TT^{\ord}(U^p,\oo)_{\fm_i}$-modules.
\end{cor}
\begin{proof}
Since $\TT^{\ord}(U^p,\oo)$ is 
the $\TT(U^p,\oo)$-algebra generated by the image of $\Psi_{2,w_0}$
in Proposition \ref{prop:big_char_at_p},
the corollary follows from the above decomposition of 
$M^{\ord}(U^p)_{\fm}'$ and the fact that 
the action of $\Qp^\times=\{\smat{1&\\&*}\}$ on which 
factors through $\TT^{\ord}(U^p,\oo)$
via $\xi_{\fm}^{1/2}\Psi_{2,w_0}$ by 
Proposition \ref{prop:twist_ord}.
Note that $\xi_{\fm}^{1/2}\Psi_{2,w_0}\equiv\Psi_{2,w_0}\bmod\fm_i$
since $\xi_{\fm}$ is congruent to the trivial character.
\end{proof}




\begin{lem}    
The sequence \eqref{eq:exact_ord}
is also left exact.
\end{lem}
\begin{proof}
    Since $S^{\ord}(U^p,E/\oo)_\fm'$
    is an admissible $T'$-representation,
	by \cite[Lem 2.2.11]{emeI}
    the Pontryagin dal $M^{\ord}(U^p)_\fm'$
    is finite over the algebra
    $\Lambda=\oo\llbracket T(p^1)\rrbracket$
    introduced in \eqref{def:lambda_rings}.
	Apply $\Hom_{T'}(\tilde{P}_{\chi_i^\vee,\chi},*)$
	to \eqref{eq:exact_ord} gives
\begin{equation*}
	\End_{T'}(\tilde{P}_{\chi_i^\vee,\fm})^r\xrightarrow{\bar{A}_{ii}}
	\End_{T'}(\tilde{P}_{\chi_i^\vee,\fm})^r\to 
	\Hom_{T'}(\tilde{P}_{\chi_i^\vee,\fm}, M^{\ord}(U^p)_\fm')
	\to 0
\end{equation*}
    We observe that 
    $\Hom_{T'}(\tilde{P}_{\chi_i^\vee,\fm}, M^{\ord}(U^p)_\fm')$
    must be torsion over $R_{\fm}^\red$
    since the relative dimension of $\Lambda$ is
	strictly smaller than that of $R_{\fm}^{\red}$,
    while $\End_{T'}(\tilde{P}_{\chi_i^\vee,\fm})$
	is finite free over $R_{\fm}^{\red}$.
	Passing to the field of fraction of $R_{\fm}^{\red}$,
	we see that the matrix $\bar{A}_{ii}$ has to be invertible
	and the result follows.
\end{proof}
\begin{prop}\label{prop:no_torsion}
    The $R_\fm$-module $M(U^p)_{\fm}'$
    has no $\xx$-torsion.
\end{prop}
\begin{proof}
    By the anti-equivalence \eqref{eq:anti_equiv},
	it suffices to show that
	$\Hom_{Q'}(\tilde{P}_{j,\fm}, M(U^p)_{\fm}'[\xx])=0$
	for $j=1,2$.
    Since $R_\fm$ acts faithfully on $\tilde{P}_{i,\fm}$
    by \eqref{eq:proj_1}, 
	we can apply the snake lemma to the commutative diagram
    below then apply the exact functor
    $\Hom_{Q'}(\tilde{P}_{j,\fm}, *)$
    to the resulting sequence.
    \begin{equation*}
    \begin{tikzcd}
    0 \arrow[r] & 
    \tilde{P}_{\B,\fm}^{\oplus r} 
	\arrow[d,"\xx",hookrightarrow] \arrow[r,"A"] & 
	\tilde{P}_{\B,\fm}^{\oplus r} 
	\arrow[d,"\xx",hookrightarrow] \arrow[r] & 
	M(U^p)_{\fm}'
    \arrow[d,"\xx"]  \arrow[r] & 0 \\ 
    0 \arrow[r] & 
    \tilde{P}_{\B,\fm}^{\oplus r}
	\arrow[r,"A"] & 
    \tilde{P}_{\B,\fm}^{\oplus r}
	\arrow[r] &
    M(U^p)_{\fm}'  
    \arrow[r] & 0 
    \end{tikzcd}
\end{equation*}
From which we can observe that
$\Hom_{Q'}(\tilde{P}_{j,\fm}, M(U^p)_{\fm}'[\xx])$
is isomorphic to the kernel of the homomorphism below,
which is injective by the previous lemma.
\begin{equation}\label{eq:fil_ij}
	\smat{\bar{A}_{ii}& \bar{A}_{ij}\Phi_{ij}\\& \bar{A}_{jj}}\colon 
	\Hom_{Q'}(\tilde{P}_{j,\fm},\tilde{P}_{\B,\fm}^{\oplus r})^{\red}\to
	\Hom_{Q'}(\tilde{P}_{j,\fm},\tilde{P}_{\B,\fm}^{\oplus r})^{\red}
\end{equation}
\end{proof}


\begin{cor}\label{cor:fil_by_ord}
	We have the following exact sequence of
	$\TT(U^p,\oo)_\fm\times R_{\fm}^{\red}$-modules
\begin{equation*}
\begin{aligned}
	0\to M^{\ord}(U^p)_{\fm,1}'\to
	\Hom_{Q'}(\tilde{P}_{2,\fm},M(U^p)_{\fm}')^{\red}
    \to
	M^{\ord}(U^p)_{\fm,2}'\to0\\
	0\to M^{\ord}(U^p)_{\fm,2}'\to
	\Hom_{Q'}(\tilde{P}_{1,\fm},M(U^p)_{\fm}')^{\red}
    \to
	M^{\ord}(U^p)_{\fm,1}'\to0
\end{aligned}
\end{equation*}
\end{cor}
\begin{proof}
    Apply the snake lemma again to the 
    commutative diagram in the previous proposition 
    and apply $\Hom_{Q'}(\tilde{P}_{2,\fm},*)$
    to the resulting exact sequence
	gives the middle row of the commutative diagram
\begin{equation*}
    \begin{tikzcd}
	    0 \arrow[r]& 
	    \Hom_{Q'}(\tilde{P}_{2,\fm},\tilde{P}_{1,\fm}^{\oplus r})^{\red}
	    \arrow[r,"\bar{A}_{11}"] \arrow[d]&
	    \Hom_{Q'}(\tilde{P}_{2,\fm}, \tilde{P}_{1,\fm}^{\oplus r})^{\red}
	    \arrow[d] &&\\
	    0\arrow[r] & 
	    \Hom_{Q'}(\tilde{P}_{2,\fm},\tilde{P}_{\B,\fm}^{\oplus r})^{\red}
	    \arrow[r,"\eqref{eq:fil_ij}"] \arrow[d,"\Ord"] &
	    \Hom_{Q'}(\tilde{P}_{2,\fm},\tilde{P}_{\B,\fm}^{\oplus r})^{\red}
	    \arrow[d,"\Ord"] \arrow[r]&
	    \Hom_{Q'}(\tilde{P}_{2,\fm}, M(U^p)_{\fm}')^{\red}\arrow[r]
        \arrow[d,"\Ord"] &0\\
	    0\arrow[r] & 
	    \End_{T'}(\tilde{P}_{\chi_2^\vee,\fm})^{r}
	    \arrow[r,"\bar{A}_{22}"] &
	    \End_{T'}(\tilde{P}_{\chi_2^\vee,\fm})^{r}
        \arrow[r]&
        \Hom_{T'}(\tilde{P}_{\chi_2^\vee,\fm}, M^{\ord}(U^p)_\fm')
        \arrow[r]&0
    \end{tikzcd}
\end{equation*}
The columns and the exact of which follows from 
Lemma \ref{lem:ker_red} since
$\Hom_{Q'}(\tilde{P}_{2,\fm}, \tilde{P}_{2,\fm})^{\red}
\cong \End_{T'}(\tilde{P}_{\chi_2^\vee,\fm})$
and the exactness of the rows follows from the previous lemma.
Since $\tilde{P}_{\chi_i^\vee,\fm}$
is free of rank one over over $R_\fm^{\red}$
by Lemma \ref{lem:end_comp} and
$\Hom_{T'}(\tilde{P}_{\chi_i^\vee,\fm},\tilde{P}_{\chi_j^\vee,\fm})=0$
if $i\neq j$, we have
\begin{equation}
    \Hom_{T'}(\tilde{P}_{\chi_i^\vee,\fm}, M^{\ord}(U^p)_\fm')\cong
    \Hom_{T'}(\tilde{P}_{\chi_i^\vee,\fm}, M^{\ord}(U^p)_\fm')
    \hat{\otimes}_{R^{\red}_\fm}\tilde{P}_{\chi_i^\vee,\fm}\cong
    M^{\ord}(U^p)_{\fm, i}'
\end{equation}
as $\TT(U^p,\oo)_\fm\times R_{\fm}^\red$-modules,
where the last isomorphism is the valuation map
(see \cite[Lem. 3.24]{pask}).
Similarly,  since
$\Hom_{Q'}(\tilde{P}_{2,\fm}, \tilde{P}_{1,\fm})^{\red}=
\Hom_{Q'}(\tilde{P}_{1,\fm}, \tilde{P}_{1,\fm})^{\red}
\hat{\otimes}_{R_\fm^\red}R_\fm^{\red}\Phi_{12}$,
the cokernel of the first row is
$\Hom_{Q'}(\tilde{P}_{1,\fm}, M(U^p)_{\fm}')^{\red}
\hat{\otimes}_{R_\fm^\red}R_\fm^{\red}\Phi_{12}$,
which is isomorphic to $M^{\ord}(U^p)_{\fm, 1}'$
as a $\TT(U^p,\oo)_\fm\times R_{\fm}^\red$-module.
From these we get the first claimed exact sequence,
and the second one can be derived similarly.
\end{proof}  

Now recall that both $\TT(U^p,\oo)$
and $\TT^{\ord}(U^p,\oo)$
are algebras over $\Lambda=\oo\llbracket T(p^1)\rrbracket$
via the diamond operators in Definition \ref{def:ord_hecke}.
In particular $M(U^p)_\fm'$ is also a module over $\Lambda$ and
$\Lambda\hat{\otimes}_{\oo}\oo\llbracket\xx\rrbracket=
\Lambda\llbracket\xx\rrbracket$.


\begin{prop}\label{prop:Hecke_finite}
The modules
$\Hom_{Q'}(\tilde{P}_{1,\fm},M(U^p)_{\fm}'),
\Hom_{Q'}(\tilde{P}_{2,\fm},M(U^p)_{\fm}')$,
are finite free over 
$\Lambda\llbracket \xx\rrbracket$
and consequently so is 
$\mathbf{m}=
\Hom_{Q'}(\tilde{P}_{\B,\fm},M(U^p)_{\fm}')$.
\end{prop}
\begin{proof}
    The same proof in Proposition \ref{prop:ord_to_dual}
    shows that $M^{\ord}(U^p)_\fm$ is finite free over $\Lambda$
    under the assumption \eqref{cond:small}.
    Therefore $M^{\ord}(U^p)_{\fm,i}$ are finite free over $\Lambda$
    by Corollary \ref{cor:two_max} and so are 
    $\Hom_{Q'}(\tilde{P}_{i,\fm},M(U^p)_{\fm}')^{\red}$
    by the previous corollary.

    Write $\mathbf{m}_i=\Hom_{Q'}(\tilde{P}_{i,\fm},M(U^p)_{\fm}')$.
    Since the finite $R_\fm$-module
    $\mathbf{m}_i$ has a natural compact topology
    and $\mathbf{m}_i^\red$ is finite free over $\Lambda$,
	by the topological Nakayama lemma
	$\mathbf{m}_i$ is finite over $\Lambda\llbracket x\rrbracket$.
    Suppose $r=\rank_{\Lambda}\mathbf{m}_i^\red$
    and fix an isomorphism $\Lambda^{\oplus r}\cong \mathbf{m}_i^\red$.
    We can lift which to a surjective homomorphism
    $\Lambda\llbracket \xx\rrbracket^{\oplus r}\to\mathbf{m}$.
    Let $N$ denote the kernel of which and 
    apply the snake lemma to the diagram
    \[
    \begin{tikzcd}
    0\arrow[r]& 
    N\arrow[r]\arrow[d,"\xx"]&
    \Lambda\llbracket \xx\rrbracket^{\oplus r}\arrow[r]\arrow[d,"\xx"]&
    \mathbf{m}_i\arrow[r]\arrow[d,"\xx"] &0\\
    0\arrow[r]& 
    N\arrow[r]&
    \Lambda\llbracket \xx\rrbracket^{\oplus r}\arrow[r]&
    \mathbf{m}_i\arrow[r] &0
    \end{tikzcd}
    \]
    Then $N^\red=0$ by Proposition \ref{prop:no_torsion}
    and $N=0$ by Nakayama's lemma, which proves the claim.
\end{proof}



\begin{cor}\label{cor:Hecke_ff}

Let $\xx$ acts on $\TT(U^p,\oo)_\fm$ via 
the homomorphism in part (1) of Proposition \ref{lem:twist}.
Then $\TT(U^p,\oo)_\fm$ is a finite free 
$\Lambda\llbracket\xx\rrbracket$-algebra.
In particular we may view $\xx$ as an element in $\TT(U^p,\oo)_\fm$
and the ideal $\xx\TT(U^p,\oo)_\fm$
is free of rank one over $\TT(U^p,\oo)_\fm$.

\end{cor}

\begin{proof}
Since $\TT(U^p,\oo)_{\fm}$ acts faithfully on 
$M(U^p)_{\fm}'$, it also acts faithfully on
$\mathbf{m}=\Hom_{Q'}(\tilde{P}_{\B,\fm},M(U^p)_{\fm}')$ 
because of the anti-equivalence \eqref{eq:anti_equiv}.
The previous proposition then gives an injective homomorphism
\[
    \TT(U^p,\oo)_\fm\hookrightarrow
    \End_{\Lambda\llbracket\xx\rrbracket}(\mathbf{m})
\]
between $\Lambda\llbracket\xx\rrbracket$-algebras
where the right hand side is finite free,
from which the corollary follows.
\end{proof}

\subsection{Fundamental exact sequence}
\label{sub:fund_exact_sequence}

Recall that for $\Lambda^+=\Lambda[\Delta_p\times\Delta_S]$
introduced in \eqref{def:lambda_rings},
both $\TT(U^p,\oo)$ and $\TT^{\ord}(U^p,\oo)$
are $\Lambda$-algebras via the diamond operators
and the map 
$\TT(U^p,\oo)\to \TT^{\ord}(U^p,\oo)$
from Lemma \ref{lem:coh_to_ord}
is a homomorphism between $\Lambda^+$-algebras.


Let $\fG=W\times \Delta$ be an abelian pro-$p$ group,
where $W$ is fintie free over $\Zp$
and $\Delta$ is a finite abelian group,
then $\I\coloneqq\oo\llbracket\fG\rrbracket$
is a local complete Noetherian flat $\oo$-algebra.
We suppose there exists a homomorphism
$\Lambda^+\to \I$ such that 
$\I$ is finite over $\Lambda^+$.
Let $\lambda^{\ord}\colon 
\TT^{\ord}(U^p,\oo)\to\I$
be a homomorphism of $\Lambda^+_{\fs}$-algebras and
\begin{equation}
    \lambda\colon 
    \TT(U^p,\oo)\to
    \TT^{\ord}(U^p,\oo)\to\I
\end{equation}
denote the composition, by which
we view $\I$ as a $\TT(U^p,\oo)$-algebra.
If $\fm_\I$ is the maximal ideal of $\I$,
we consider the maximal ideals
$\fm=\lambda^{-1}(\fm_\I)$ 
and $\fm^\circ=(\lambda^{\ord})^{-1}(\fm_\I)$
of the Hecke algebras.
We will assume that
$\lambda$ is surjective and that 
$\fm$ satisfies \eqref{cond:red_gen}.
Then Corollary \ref{cor:two_max} implies that
that $\fm^\circ$ is either $\fm_1$ or $\fm_2$ and,
say $\fm^{\circ}=\fm_2$,
there exists characters 
$\bar{\delta}_i\colon \Gal_\K\to \fF^\times$ such that
\begin{align*}
    (\lambda\circ T_\fm\bmod \fm_\I)&=
    (T_\fm\bmod \fm)=
    (\bar{\delta}_1+\bar{\delta}_2)\colon 
    \Gal_\K\to \fF\\
    (\lambda^{\ord}\circ \Psi_{2,w_0}\bmod\fm_\I)&=
    (\Psi_{2,w_0}\bmod\fm^{\circ})=
    (\omega\bar{\delta}_2\vert_{\Gp})\colon 
    \Gp\to \fF^\times
\end{align*}

We write
$M^{\ord}(U^p,\I)_{\fm_i}\coloneqq
M^{\ord}(U^p)_{\fm_i}\otimes_{\Lambda^+}\I$ for $i=1,2$
and make the following assumptions.
\begin{enumerate}[label=(C\arabic*)]
\item There exists a $\TT(U^p,\oo)_\fm$-module 
homomorphism
$\Theta\colon M^{\ord}(U^p,\I)_{\fm_2}\to \I$.
\label{cond:C1}
\item There exists $F\in M^{\ord}(U^p,\I)_{\fm^\circ}$
such that,
for any character $\alpha$ of $\Delta$,
the image of $\Theta(F)$ under the induced homomorphism
$\alpha\colon\I\to\oo\llbracket W\rrbracket$ is nonzero.
\label{cond:C3}
\item There exists an ideal 
$\fq\subset \TT(U^p,\oo)_{\fm}$
that contains $\xx$ such that
\[
    \fq M^{\ord}(U^p)_{\fm,1}'=0\quad
    \text{ and }\quad
    \fq F=0 \text{ in } M^{\ord}(U^p,\I)_{\fm^{\circ}}.
\]
\label{cond:C2}

\end{enumerate}

In the rest of the section, we write
$M=\Hom_{Q'}(\tilde{P}_{2,\fm},M(U^p)_{\fm}')
\otimes_{\Lambda^+}\I$,
$M_i^{\ord}=M^{\ord}(U^p,\I)_{\fm_i}$ for $i=1,2$ and
$\TT=\TT(U^p,\oo)_{\fm}$.
By Corollary \ref{cor:fil_by_ord}
we have a right exact sequence of $\TT(U^p,\oo)_\fm$-modules
\begin{equation}\label{eq:chain_coh}
    M_1^{\ord}\to M/\xx M\xrightarrow{(*)} M_2^{\ord}\to 0
\end{equation}
We define $S_2^{\ord}=\ker(\Theta)$ and let $S\subset M$
be the pre-image of $S_2^{\ord}$ under $(*)$.
Note that $\xx M\subset S$ by definition.
For any character $\alpha$ of $\Delta$,
we let $\Lambda_\alpha$ denote the $\I$-algebra structure
on $\Lambda_W=\oo\llbracket W\rrbracket$ given by 
the induced homomorphism $\alpha\colon\I\to \Lambda_W$.
We also write $\lambda_\alpha$
for the composition of which with $\lambda$.


\begin{lem}\label{lem:right_exact}
There exists an exact sequence
of $\TT$-modules
\begin{equation}\label{eq:fund}
	M/S\xrightarrow{\xx} \fq M/\fq S\to 
	\fq M_2^\ord/\fq S_2^\ord \to 0
\end{equation}
\end{lem}

\begin{proof}
Since $\xx\in \fq$ by \ref{cond:C2}
we have the commutative diagram
\[
\begin{tikzcd}
	S\arrow[r,"\xx"] \arrow[d]
	& \fq S \arrow[r] \arrow[d]
	& \fq S^{\red} \arrow[r] \arrow[d] & 0\\
	M\arrow[r,"\xx"]
	& \fq M \arrow[r]
	& \fq M^{\red} \arrow[r] & 0
\end{tikzcd}
\]
Applying the snake lemma
reduces the lemma to showing that
$\fq M^{\red}/\fq S^{\red}=\fq M_2^{\ord}/\fq S_2^{\ord}$.
Observe that $\fq M^{\red}=\fq M/\xx M$ 
is mapped injectively into $M^{\red}=M/\xx M$ and we have
\begin{align*}
    M_1^{\ord}\to M/\xx M\to M_2^{\ord}\to 0
    &\Longrightarrow
	\Image(\fq M^{\red}\to M^{\red})=
    \fq M/\xx M\cong\fq M_2^{\ord}\\
    M_1^{\ord}\to S/\xx M\to S_2^{\ord}\to 0
    &\Longrightarrow
	\Image(\fq S^{\red}\to M^{\red})=
    \fq S+\xx M/\xx M\cong\fq S_2^{\ord}.
\end{align*}
where the last isomorphisms 
follows from \ref{cond:C2}.
From the above we have the desired isomorphism.
\end{proof}


Let $\hat{\Delta}$ be the set 
of characters on the finite abelian group $\Delta$.
We write $K_W=\textnormal{Frac}\Lambda_W$
and $K_\alpha=\textnormal{Frac}\Lambda_\alpha$
for $\alpha\in \hat{\Delta}$
if we want to specify the $\I$-algebra structure.
Note that the natural map
$\I\hookrightarrow\prod_{\alpha\in\hat{\Delta}}\Lambda_\alpha$ 
is injective and the cokernel is $p$-torsion.
Now observe that each terms in 
the sequence \eqref{eq:fund}
is a quotient of $M/S$ 
and the $\TT$-action on which factor through $\lambda$.
Thus \eqref{eq:fund} is also a sequence of $\I$-modules.

\begin{lem}\label{lem:inj_crit}
The sequence \eqref{eq:fund}
is left exact if 
$(\fq M/\fq S)\otimes_{\I}K_\alpha\neq 0$
for all $\alpha\in\hat{\Delta}$.
\end{lem}
\begin{proof}
Since $\Theta$ induces $M/S\hookrightarrow\I$,
the $\I$-module $M/S$ has no $p$-torsion and we have the diagram
\[
\begin{tikzcd}
M/S
\arrow[r,"(a)"]\arrow[d,hookrightarrow] &
\fq M/\fq S
\arrow[r]\arrow[d] &
\fq M_2^{\ord}/\fq S_2^{\ord}
\arrow[r]\arrow[d] & 0\\
(M/S)\otimes_{\I}\I[1/p]
\arrow[r,"(b)"] &
(\fq M/\fq S)\otimes_{\I}\I[1/p]
\arrow[r] &
(\fq M_2^{\ord}/\fq S_2^{\ord})\otimes_{\I}\I[1/p]
\arrow[r] & 0
\end{tikzcd}
\]
Therefore $(a)$ is injective if
$(b)$ is injective.
Moreover, since $\I[1/p]=\prod_\alpha \Lambda_\alpha[1/p]$,
the map $(b)$ is injective if and only if the map $(b)_\alpha$ below
is injective for each $\alpha\in\hat{\Delta}$.
\[
(M/S)\otimes_{\I}\Lambda_\alpha[1/p]
\xrightarrow{(b)_\alpha}
(\fq M/\fq S)\otimes_{\I}\Lambda_\alpha[1/p] \to
(\fq M_2^{\ord}/\fq S_2^{\ord})\otimes_{\I}\Lambda_\alpha[1/p]\to 0
\]
Since $\Theta$ also induces
$(M/S)\otimes_{\I}\Lambda_\alpha[1/p]
\hookrightarrow\Lambda_\alpha[1/p]$,
we can pass to the field of fraction and get
\[
\begin{tikzcd}
(M/S)\otimes_{\I}\Lambda_\alpha[1/p]
\arrow[r,"(b)_\alpha"]\arrow[d,hookrightarrow] &
(\fq M/\fq S)\otimes_{\I}\Lambda_\alpha[1/p]
\arrow[r]\arrow[d] &
(\fq M_2^{\ord}/\fq S_2^{\ord})\otimes_{\I}\Lambda_\alpha[1/p]
\arrow[r]\arrow[d] & 0\\
(M/S)\otimes_{\I}K_\alpha
\arrow[r,"(b)_\alpha'"] &
(\fq M/\fq S)\otimes_{\I}K_\alpha
\arrow[r] &
(\fq M_2^{\ord}/\fq S_2^{\ord})\otimes_{\I}K_\alpha
\arrow[r] & 0
\end{tikzcd}
\]
From which we see that $(b)_\alpha$ 
is injective if $(b)_\alpha'$ is injective.
Since the map of $K_W$-modules
$(M/S)\otimes_{\I}K_\alpha\hookrightarrow K_\alpha$
induced by $\Theta$ is nonzero by \ref{cond:C3},
we can identify
$(M/S)\otimes_{\I}K_\alpha=K_\alpha$.

On the other hand,
let $E_2^{\ord}\subset M_2^{\ord}$
be the $\TT$-submodule generated by $F$.
Then \ref{cond:C3} implies that
$(M_2^{\ord}/(S_2^{\ord}+E_2^{\ord}))\otimes_{\I}\Lambda_\alpha$
is a torsion module and \ref{cond:C2} implies that
$\fq(S_2^{\ord}+E_2^{\ord})=\fq S_2^{\ord}$.
Consequently
\[
    0=\fq\otimes_{\TT}\left(M_2^{\ord}/(S_2^{\ord}+E_2^{\ord})\right)
    \otimes_{\I}K_\alpha
    =\fq\otimes_{\TT}(M_2^{\ord}/S_2^{\ord})
    \otimes_{\I}K_\alpha
    \twoheadrightarrow
    (\fq M_2^{\ord}/\fq S_2^{\ord})\otimes_{\I}K_\alpha
\]
In other word $(b)_\alpha'$ is a surjective map from $K_W$,
and therefore it is injective if and only if
$(\fq M/\fq S)\otimes_{\I}K_\alpha$ is nonzero.
This conclude the proof of the lemma.
\end{proof}

We now consider a fixed 
$\lambda_\alpha\colon \TT\to \Lambda_\alpha$
and define the prime ideals 
$\wp_1=\ker(\lambda_\alpha)\subset \TT$,
$\fp_1=\wp_1\cap \Lambda\llbracket\xx\rrbracket$, and
$\fp=\fp_1\cap \Lambda$.
Note that $\fp_0\coloneqq \fp\Lambda\llbracket\xx\rrbracket\subset \fp_1$
is also a prime ideal.
And in fact $\fp_1=\fp_0+(\xx)$
since $\lambda$ factors through the ordinary Hecke algebra.
Let $\Lambda'\coloneqq \Lambda/\fp$,
which is isomorphic to a subring of $\Lambda_\alpha$ via $\lambda_\alpha$
and $K$ denote the field of fraction of $\Lambda'$,
then $K_\alpha/K$ is a finite extension 
since $\I$ is finite over $\Lambda$.


\begin{lem}
There exists a prime ideal 
$\wp_0\subset \wp_1$ of $\TT$ such that 
$\wp_0\cap \Lambda\llbracket \xx\rrbracket=\fp_0$.
\end{lem}
\begin{proof}

We first note that 
by Proposition \ref{prop:Hecke_finite}
the localization and quotient
$\TT_{\fp_1}/\fp_0\TT_{\fp_1}$,
as an $\Lambda\llbracket\xx\rrbracket$-algebra,
is finite free over
the complete discrete valuation ring
\[
\Lambda\llbracket\xx\rrbracket_{\fp_1}/
\fp_0\Lambda\llbracket\xx\rrbracket_{\fp_1}\cong
\left(
\Lambda\llbracket\xx\rrbracket/\fp_0
\right)_{\fp_1}\cong
(\Lambda'\llbracket\xx\rrbracket)_{\fp_1}\cong 
K\llbracket\xx\rrbracket
\]
Therefore $\TT_{\fp_1}/\fp_0\TT_{\fp_1}$
is the direct product of its localizations at the maximal ideals.
In particular $\TT_{\wp_1}/\fp_0\TT_{\fp_1}$
is one of the component and is also finite free over 
$K\llbracket\xx\rrbracket$.
This implies that $\TT_{\wp_1}/\fp_0\TT_{\fp_1}$ cannot be Artinian
% $K\llbracket\xx\rrbracket\to \TT_{\wp_1}/\fp_0\TT_{\fp_1}$ is injective.
and the pull-back of any minimal ideal of which to $\TT$
gives the desired ideal.

\end{proof}

Let $\wp_0\subset \TT$ be a prime above $\fp_0$,
then $\TT_{\wp_1}/\wp_0\TT_{\wp_1}$
is an integral domain and a finite extension
over $K\llbracket\xx\rrbracket$.
The integral closure of $K\llbracket\xx\rrbracket$
in the field of fraction of 
$\TT_{\wp_1}/\wp_0\TT_{\wp_1}$ is then a Dedekind domain.
Let $\tilde{\TT}$ denote the localization of which
at any maximal ideal.
Then $\tilde{\TT}$ is a discrete valuation ring
and $\fq\tilde{T}\cong \tilde{T}$.
From which we have the isomorphism
\begin{multline*}
((\fq M/\fq S)\otimes_{\I} K_\alpha)
\otimes_{\TT_{\wp_1}}\tilde{\TT}\cong 
(\fq M\otimes_{\I} K_\alpha)
\otimes_{\TT_{\wp_1}}\tilde{\TT}/
(\fq S\otimes_{\I} K_\alpha)
\otimes_{\TT_{\wp_1}}\tilde{\TT}\\\cong
(M\otimes_{\I} K_\alpha)
\otimes_{\TT_{\wp_1}}\tilde{\TT}/
(S\otimes_{\I} K_\alpha)
\otimes_{\TT_{\wp_1}}\tilde{\TT}\cong
((M/S)\otimes_{\I} K_\alpha)
\otimes_{\TT_{\wp_1}}\tilde{\TT}=
K_\alpha \otimes_{\TT_{\wp_1}}\tilde{\TT}
\end{multline*}
The last ring is nonzero since 
the spectrum of which 
is nothing but the pre-image
under the finite morphism
$\Spec(\tilde{\TT})\to \Spec(\TT_{\wp_1})$
of the maximal ideal $\wp_1\TT_{\wp_1}=\ker(\TT_{\wp_1}\to K_\alpha)$,
which is the maximal ideal of $\tilde{\TT}$.
By Lemma \eqref{lem:inj_crit}
we can conclude that \eqref{eq:fund} is left exact.
We organize this result into the following corollary.


\begin{cor}\label{cor:fund}
	Under the setting of this subsection
    and the assumptions
    \ref{cond:C1},
    \ref{cond:C2}, and
    \ref{cond:C3},
    we have the following commutative diagram
    of exact sequences of $\TT$-modules
    \begin{equation}
    \begin{tikzcd}
    & (M/S)
    \arrow[r,"\xx"]\arrow[d,equal] &
    (M/S)\otimes_{\TT}\fq
    \arrow[r]\arrow[d] &
    (M/S)\otimes_{\TT}\fq^\red
    \arrow[r]\arrow[d] &0\\
    0\arrow[r] &
    (M/S)
    \arrow[r,"\xx"] &
    \fq M/\fq S
    \arrow[r] &
    \fq M_2^{\ord}/\fq S_2^{\ord}
    \arrow[r] &0
    \end{tikzcd}
    \end{equation}
\end{cor}
\begin{proof}
The vertical maps are the natural ones
and the commutative properties 
follows from the isomorphism
$\fq M^\red/\fq S^\red=\fq M_2^{\ord}/\fq S_2^{\ord}$
shown in the proof of Lemma \ref{lem:right_exact}.
The exactness of the first row
is straightforward and
the exactness of the second row
follows from the discussions above.
\end{proof}

\begin{rem}
Aside from some modifications,
the formulation and the proof of the corollary
are entirely from \cite[Prop. 6.3.5]{urban},
in which the corollary is proven 
for the case of Eisenstein ideals on modular curves.
We also refer to \cite[Thm 3.4.1]{urban}
for a different proof 
which relies on the geometry of eigencurves.
\end{rem}


\section{Construction of Euler systems}

Let $G$ and $H$ denote the algebraic groups over $\F$
defined by \eqref{def:def_unitary}
for $n=2$ and $n=1$ respectively.
The Hermitian pairing on $\K^{\oplus 2}$
that defines $G$ can be twisted in to 
a skew-Hermitian pairing after multiplied by 
a nonzero $\delta\in \K$ such that $\delta=-\bar{\delta}$.
Then $(G, H)$ forms a dual reductive pair
and the theory of theta correspondence 
allows us to transfer automorphic representations
between $G$ and $H$.

In particular, 
let $\eta$ be a Hecke character on $\K$,
then the theta lift $\pi=\pi_\eta$ of the restriction of $\eta$
to $H(\A)=\A_{\K}^1$ could be zero or an irreducible 
automorphic representation. 
And when $\pi\neq 0$, the associated Galois representation
$r_\pi$ is essentially the direct product of $\eta$ and $\eta^c$.
In fact, another way is to think about $\pi$ as the Jacquet-Langlands
transfer of the classical CM representations.

In the author's previous work,
it is shown that the theta lifts
can be obtained from the quasi-split unitary group
of signature $(2,2)$ through a pull-back procedure.
Using the theory of integral models
of PEL-type Shimura varieties
associated to quasi-split unitary groups
developed in \cite{Hida04},
it is then shown in \cite{lee}
that these theta lifts 
are $p$-integral up to powers of the canonical
CM periods of $\K$
and form a Hida family.
We note that the same technique has already appeared in \cite{wan}.
And such pull-back argument is well-know 
for Eisenstein series and is used for example in 
\cite{SU},\cite{EHLS}, and \cite{Hsieh2014}.

In this section,
we fix a finite order Hecke character $\mu$ of $\K$
and assume that the conductor of $\mu$
is divisible only by primes that splits in $\K$.
Moreover, we assume that the anticyclotomic character
$\psi=\mu^c/\mu$ satisfies
\begin{equation}\label{cond:gen_psi}
    \psi\vert_{D_{w_0}}\not\equiv 1,\omega^{\pm1}.
\end{equation}
For each ideal $\ff\subset \oo_\K$
that is a square-free product of split primes
such that $\ff+\ff^c=\oo_K$,
let $\fs=\ff\ff^c$
and $\fG^a_{\fs}$ be the Galois group
of the maximal pro-$p$ anticyclotomic
extension over $\K$ with tame level $\fs$.
Use the results from \cite{lee},
we will show the existence of a Hida family
$\euF_\fs$ over $\I_\fs\coloneqq \eo\llbracket\fG_\fs^a\rrbracket$,
and verify \ref{cond:C1} and \ref{cond:C3}
for the corresponding Hecke eigensystem.
We remark that here $\eo$ is a finite extension
over $\bar{\Q}_p^{un}$,
but the relevant results from previous sections still holds 
after the flat base change from $\oo$,
the ring of integers of a finite field extension over $\Qp$,
to $\eo$.

Then after verifying \ref{cond:C2},
we will apply Corollary \ref{cor:fund}
and construct a nontrivial cohomology class for 
\[
    \Psi_\fs\colon\Gal_\K\to \I_\fs\quad
    \gamma\mapsto \psi(\gamma)\langle \gamma\rangle
\]
where $\langle*\rangle$ denote the tautological character
to $\I_\fs=\eo\llbracket\fG_\fs^a\rrbracket$.
At last, we show that these classes are compatible under the norm maps 
in a way that justifies calling them
an ``anticyclotomic Euler system''
when we vary the ideal $\ff$.
We postpone the application of the Euler system
to Iwasawa theory till the next section.


\subsection{Hida family of theta lifts}


To define the theta correspondence between $G$ and $H$
it is necessary to fix an auxiliary Hecke character
$\chi$ of $\K$ which restricts to 
$\qch_{\K/\F}$ on $\A_\F^\times$.
We further require that
\[
\chi_\sigma(z)=\bar{z}/|z|\,
\text{ for all }\sigma\in \Sigma 
\]
In other word $\chi_\circ\coloneqq \chi|\cdot|^{1/2}$
is an algebraic Hecke character
of infinity type $\Sigma^c$.

\begin{defn}\label{def:admchar}
An algebraic Hecke character $\eta$ of $\K$ is admissible
if it satisfies the following conditions.
\begin{enumerate}
\item 
There exists an ideal $\fn=\fn^c$
consisting only of split primes such that 
$\eta$ is trivial on
$\A_{\K,f}^1\cap (1+\fs\widehat{\oo}_K)^\times$.
\item 
It has the infinity type
$\sum_{\sigma\in\Sigma}a_\sigma\sigma+b_\sigma\bar{\sigma}$
such that 
$k_\sigma\coloneqq a_\sigma-b_\sigma\geq0$
for all $\sigma\in\Sigma$.
\end{enumerate}
When $\eta$ is an admissible Hecke character as above.
We write $k=\sum_{\sigma}k_\sigma\sigma$ and $\wt{k}=(0,-k)$.
\end{defn}

\begin{prop}\cite[Prop. 7.5]{lee}\label{prop:single}
When $\eta$ is admissible and $\wt{k}$ is as above,
there exists an open compact subgroup $U^p\subset G(\A_f^p)$
that satisfies \eqref{cond:s-ram}
and an integer $n\geq 1$,
which depends on the conductors of $\eta$ and $\chi$,
and an algebraic modular form
$f(\eta)\in S_{\wt{k}}^{\ord}(K(\fs)^p\Iw(p^{n,n}),\eo)$
that satisfies the following conditions.
\begin{itemize}
\item 
Apply \eqref{eq:p_to_infty} and let $\iota(f(\eta))\in
\Hom_{G(\A_\infty}(\xi_{\wt{k}}^*(\C),\mathcal{A})$.
Then $\iota(f(\eta))(v_{-\wt{k}})\in\mathcal{A}$
for the lowest weight vector
$v_{-\wt{k}}\in \xi_{\wt{k}}^*(\C)$
is the theta lift of $\eta$
up to canonical CM periods and explicit factors.
\item The central character of $f(\eta)$
is the restriction of $\hat{\eta}$ to $\A_f^1$.
\item  It is an eigenform for 
$\TT_{\wt{k}}(U^p\Iw(p^{n,n}),\eo)$ with eigenvectors:
\begin{align*}
&T_w^{(1)}\mapsto
q_w\chi_\circ(\varpi_w)+\chi_\circ^{-1}\tilde{\eta}(\varpi_w)&
&T_w^{(2)}\mapsto \tilde{\eta}(\varpi_w)\\
&U_{\wt{k},w}^{(1)}\mapsto
\wt{k}(\smat{\varpi_w&\\&1})(\chi_\circ^{-1}\tilde{\eta})(\varpi_w)&
&U_{\wt{k},w}^{(2)}\mapsto
\wt{k}(\smat{\varpi_w&\\&\varpi_w})\tilde{\eta}(\varpi_w)&
&\langle u\rangle_{\wt{k}}\mapsto\wt{k}(\smat{u_{11}&\\&1})
\tilde{\eta}(u_{11})\\
&U_{w}^{(1)}\mapsto\chi_\circ^{-1}\tilde{\eta}(\varpi_w)&
&U_{w}^{(2)}\mapsto\tilde{\eta}(\varpi_w)&
&\langle u\rangle\mapsto \tilde{\eta}(u_{11})
\end{align*}
\end{itemize}

\end{prop}

\begin{rem}
In \cite{lee}
the proposition was stated 
for characters $\eta$
with conductors coprime to that of $\chi$
But the choice of the Schwartz functions
at non-split places only depends
on the restriction of $\eta$ to $\A_\K^1$.
In particular, after replacing 
$\phi_{1,w}=\chi_w^{-1}\id_{\oo_v^\times}$
in $(\phi 2)$ \cite[p.14]{lee}
by $\phi_{1,w}=(\tilde{\eta}\chi_w^{-1})\id_{\oo_v^\times}$,
the formulae in
\cite[Prop 4.3]{lee} and \cite[Prop 4.5]{lee},
and thus \cite[Prop 7.5]{lee}, 
still hold for any admissible $\eta$.
\end{rem}

We now fix an admissible $\eta$
and let $U^p$ be the open compact subgroup 
that satisfies \eqref{cond:s-ram}.
Let $\ff$ be an square-free prime-to-$p$ ideal that is divisible
only by split primes $w$ such that $U_v=\iota_w^{-1}(\GL_2(\oo_w))$
if $w\mid v$ and satisfies $\ff+\ff^c=\oo_\K$.
We then set $\fs=\ff\ff^c$
and replace $U_v$ by $\Iw_1(w)$ for $w\mid \ff$ and $w\mid v$,
$S$ by the union of $S$ and the set of places below $\ff$.
Then the open compact subgroup $U^p$ still satisfies \eqref{cond:s-ram}.

Recall that $\fG_\fs^a$
is the Galois group of the maximal pro-$p$
anticyclotomic extension over $\K$ with tame level $\fs$.
For $w\in \ff$ and $w\mid v$
let $\Delta_v=\Iw(w)/\Iw_1(w)$
and $\Delta_{\fs}=\prod_{v\mid \ff}\Delta_v$.
We put 
\[
\Lambda=\eo\llbracket T(p^1)\rrbracket,\quad
\Lambda_\fs=\Lambda[\Delta_\fs],\quad
\Lambda_\fs^+=\Lambda_\fs[\Delta_p],\quad
\]
and let $\Lambda^+_\fs\to \I_\fs$
be the ring homomorphism induced by 
the map $T(p^0)\times \Delta_{\fs}\to \fG_\fs^a$,
which is the composition of
the projection to the upper-left entry
from $T(p^0)\times \Delta_{\fs}$ to 
$\prod_{w\in \Sigma_p}\oo_w^\times\times 
\prod_{w\mid \ff}\big(\oo_w^\times/(1+\varpi_w\oo_w)\big)$
and the reciprocity map \eqref{eq:anticyc_rec}.
We then let $S^{\ord}(U^p,\I_\fs)$ 
denote the space of $\I_\fs$-adic Hida families
as in Definition \ref{def:Hida_family}.

\begin{prop}\cite[Thm. 7.6]{lee}\label{prop:family}
Let $\fX_\fs(\eta)$ denote the set of all
algebraic Hecke characters $\alpha$ such that 
$\eta\alpha$ is admissible 
and that the prime-to-$p$ part of the conductor
of $\alpha$ divides $\fs$.
    There exists 
    $\euF\in S^{\ord}(U^p, \I_\fs)$ such that,
    when viewed as a $S^{\ord}(U^p)$-valued measure on $\fG_\fs^a$,
    \[
    \int_{\fG_\fs^a} \tilde{\alpha}^\wedge\,d\euF
    =\beta_{\wt{k}'}(f(\eta'))\quad\text{ for }
    \eta'=\eta\alpha\text{ and }
    \alpha\in \fX_\fs(\eta).
    \]
    Here $\wt{k}'$ is the weight associated to $\eta'$
    and $\beta_{\wt{k}'}\colon 
    S^{\ord}_{\wt{k}'}(U^p)\to S^{\ord}(U^p)$
    is the injection induced by Proposition \ref{prop:wt_indep},
    using that $\pi_{\wt{k}}^*$ is one-dimensional in the ordinary case.
    See also \cite[Prop 2.22]{ger}.
\end{prop}

Moreover, let
$B_\fs\colon S^{\ord}(U^p,\I_\fs)\times 
S^{\ord}(U^p,\I_\fs)\to\I_\fs$ 
denote the pairing defined in \cite[\S 6.4.1]{lee}
and let $L=B_\fs(\euF,U_\fs^{-1}\euF)$,
where $U_{\fs}$ be the product of all $U_w^{(1)}$ for $w\mid\ff$.
\begin{prop}\cite[Thm 7.7]{lee}\label{prop:function}
The element $L\in \I_\fs$
is an anticyclotomic $p$-adic $L$-function is the sense that
for $\alpha\in \fX_\fs(\eta)$ as above,
up to powers of $2$ we have
\begin{multline*}
	\frac{1}{\Omega_p^{2\Sigma+2k'}}
	\int_{\fG_{\fs}^a}\tilde{\alpha}^\wedge\,L=
	c(\eta')C(\chi,\K)
	\frac{(2\pi i)^{k'}\Gamma(k'+2)
	}{\Omega_\infty^{2\Sigma+2k'}}
    L(1,\chi^{-2}\tilde{\eta}')\\\cdot
	\prod_{w\in\Sigma_p\text{ or }w\mid\ff\fc}
	\varepsilon(1,(\chi^{2}\tilde{\eta}'^{-1})_w,\psi_w)
	(1-(\chi^{-2}\tilde{\eta}')(\varpi_{\bw})
	(1-(\chi^{-2}\tilde{\eta}')(\varpi_{\bw})q_{\bw}^{-1})
\end{multline*}
where $\fc$ is an ideal divisible only by split primes
that depends on the conductor of $\chi$ and $\eta$.
\end{prop}
We refer to \textit{loc.cit.} for the precise definition
of the noataions.
Here we only note that
$\Omega_p$ and $\Omega_\infty$
are the canonical CM periods associated to $\K$,
$C(\chi,\K)$ and $c(\eta)$ are explict constants in $\eo$,
with $c(\eta)$ being an $p$-unit,
and $C(\chi,\K)$ being
essentially the square of the algebraic part
of $L(1/2,\chi)$.


\begin{lem}\label{lem:good_chi}
Assume that $\K$ satisfies the following conditions.
\begin{enumerate}[label=($\K$\arabic*)]
\item The extension $\K/\F$ is generic 
in the sense of \cite{Rohrlich},
so $\oo_\K^\times\subset \F$
and $Cl_\F\to Cl_\K$ is injective.
\label{cond:K2}
\item Every prime of $\F$ above $2$ splits in $\K$.
\label{cond:K3}
\item 
Write $\qch=\qch_{\K/\F}$, 
then $\qch_v(-1)=1$ if $v\mid \mathfrak{D}_{\K/\F}$.
\label{cond:K4}
\end{enumerate}
Then there exists a unitary Hecke character $\chi$
with the following properties.
\begin{enumerate}
\item The restriction of $\chi$ to $\A_F^\times$ is $\qch_{\K/\F}$.
\item The character $\chi_\circ=\chi|\cdot|^{1/2}_\K$
has the infinity type $\Sigma^c$.
\item There exists a split prime $\fl_\circ\neq \fl_\circ^c$
such that $\chi$ is trivial on 
$\A_{\K,f}^1\cap (1+\fl_\circ\fl_\circ^c\widehat{\oo}_\K)^\times$.
\item The central value $L(1/2,\chi)$ is nonzero.
\end{enumerate}
\end{lem}
\begin{proof}

Let $\chi_{can}$
be the canonical Hecke character 
with the infinity type $-\Phi=-\Sigma^c$
defined in \cite{Rohrlich} 
under the condition \ref{cond:K2}.
Then $\chi_{can}$ 
is ramified precisely at all $w\mid \mathfrak{d}_{\K/\F}$.
And the restriction of $\chi_{can}$ to $\oo_w^\times$
is the unique character 
of conductor $(\varpi_w)$ 
that extends $\qch_{\K_w/\F_v}$ for $w\mid v$.
In particular,
$\chi_{can}$ is trivial 
on $\A_{\K,f}^1\cap \widehat{\oo}_\K^\times$
by \ref{cond:K4}
and it follows from \cite[\S 8]{Rohrlich}
(see also \cite[Lem 2.1]{Rod})
that the root number $W(\chi_{can})=1$
under the condition \ref{cond:K3}.

Therefore the conditions in
\cite[Thm A]{Hsieh2012}
are satisfied for the self-dual character
$\chi_{can}^{-1}$.
Consequently for any split prime $\fl_\circ$
that is prime to $p$, there exists 
a twist of which by a finite-order 
anticyclotomic character
ramified at $\fl_\circ\fl^s_\circ$
for which the central $L$-value is nonzero
(in fact, the algebraic part of the 
the central $L$-value is nonzero modulo $p$).
We take $\chi$
for which $\chi_\circ=\chi|\cdot|^{1/2}_\K$
is such a twist.

Now the last property above follows by definition.
The third follows from the above discussion.
The second follows from that 
$\chi_\circ$ is a finite-order twist of $\chi_{can}^{-1}$,
which has the infinity type $\Sigma^c$.
And the first follows from that 
$\chi_{can}$ restricts to $\qch_{\K/\F}|\cdot|^{-1}_\F$.
\end{proof}

\begin{defn}\label{def:family_at_s}
For the finite order character
$\psi^{-1}=\tilde{\mu}$
in the beginning of the section
and a Hecke character $\chi$ as in the lemma,
we set $\eta=\chi_0\mu$
and let $U^p$ be as in Proposition \ref{prop:single}.

Let $\ff$ be a square-free prime-to-$p$ ideal
that is divisible only by split primies $w$
such that $U_v=\iota_w^{-1}(\GL_2(\oo_w))$
if $w\mid v$ and satisfies $\ff+\ff^c=\oo_\K$.
We then set $\fs=\ff\ff^c$ and 
let $U^p_\fs\subset U^p$ be the compact open subset
obtained by replacing each $U_v$ with $\Iw_1(w)$
for $w\mid\ff$ and $w\mid v$.
It is clear by definition that $U^p_\fs$
satisfies \eqref{cond:s-ram} 
if $S$ is the set of places below $\fs$.
Potentially shrinking $U^p$, we assume $U^p_{\fs}$
satisfies \eqref{cond:small} for all $\fs$. 
We then set
\[
    \euF_{\fs}\in 
    S^{\ord}(U^p_{\fs},\I_\fs),\quad
    L_\fs=B_\fs(\euF_{\fs}, U_\fs^{-1}\euF_{\fs})
    \in \I_\fs
\]
as given in Proposition \ref{prop:family} and
Proposition \ref{prop:function}.
We will write $\euF_\fs=\euF$ and $L_\fs=L$
when $\fs=\oo_\K$.


We note that the set $\fX_\fs(\eta)$ is then
equal to the set $\fX_\fs^+$ of all Hecke characters $\alpha$
such that the prime-to-$p$ part of the conductor
of $\alpha$ divides $\fs$ 
and that $\alpha$ has the infinity type
$\sum_{\sigma\in\Sigma}(a_\sigma\sigma+b_\sigma\bar{\sigma})$
with $a_\sigma-b_\sigma>0$ for all $\sigma\in \Sigma$.
Observe that the weight $k'$ associated to $\eta'=\eta\alpha$
is then equal to 
$\sum_{\sigma\in\Sigma}(a_\sigma-b_\sigma-1)(\sigma-\bar{\sigma})$.
\end{defn}

Below we summarize the properties of 
the Hida family $\euF_\fs$ and the $p$-adic $L$-function $L_\fs$.


\begin{prop}\label{prop:eigensystem}
The Hida familiy $\euF_\fs$ induces an eigensystem
$\lambda_{\fs}^{\ord}\colon \TT^{\ord}(U^p_\fs,\eo)\to\I_\fs$ with
\begin{align*}
&T_w^{(1)}\mapsto
q_w\chi_\circ(\varpi_w)(1+\Psi_\fs(\varpi_w))&
&T_w^{(2)}\mapsto q_w\chi_\circ^2\Psi_\fs(\varpi_w)\\
&U_{w}^{(1)}\mapsto
\epsilon^{-1}\chi_\circ\Psi_\fs(\varpi_w)&
&U_{w}^{(2)}\mapsto
\epsilon^{-1}\chi_\circ^2\Psi_\fs(\varpi_w)&
&\langle u\rangle\mapsto
\epsilon^{-1}\chi_\circ^2\Psi_\fs(u_{11})\\
&U_{w}^{(1)}\mapsto q_w\chi_\circ\Psi_\fs(\varpi_w)&
&U_{w}^{(2)}\mapsto q_w\chi_\circ^2\Psi_\fs(\varpi_w)&
&\langle u\rangle\mapsto \Psi_\fs(u_{11})
\end{align*}
Here we identify $\Psi_\fs$ with a character of 
$\A_{\K}^\times/\K^\times$ by composition with the 
reciprocity map.
\end{prop}
\begin{proof}
The is a direct consequence of Proposition \ref{prop:single}
applied to 
$\tilde{\eta}=\chi^2\psi^{-1}=\chi_\circ^2|\cdot|^{-1}\psi^{-1}$.
We also note that since $\chi_\circ$ has the infinity type $\Sigma^c$,
for $w\in \Sigma_p$ we have 
$\chi_\circ(\varpi_w)=\hat{\chi}_\circ(\varpi_w)$.
\end{proof}

\begin{cor}
Let $T^{\ord}=T^{\ord}(U^p_\fs)
\colon\Gal_\K\to \TT^{\ord}(U^p_\fs,\eo)$
be the big ordinary Galois pseudo-representation
as in Definition \ref{def:big_Gal}, then we have
\begin{equation*}
    \lambda_{\fs}^{\ord}\circ T^{\ord}=
    \epsilon^{-1}\hat{\chi}_\circ+
    \epsilon^{-1}\hat{\chi}_\circ\Psi_\fs,\quad
    \lambda_{\fs}^{\ord}\circ (\epsilon \det T^{\ord})=
    \epsilon^{-1}\hat{\chi}^2_\circ\Psi_\fs.
\end{equation*}
\end{cor}
\begin{proof}
The claim is immediate from Chebotarev's density
and the formulae in the previous proposition.
\end{proof}


For $\alpha\in \fX_\fs^+$ and $\eta'=\eta\alpha$
we write $\lambda=
\epsilon \chi^{-2}\tilde{\eta}'=\epsilon\psi^{-1}\tilde{\alpha}$.
Note that if $\alpha$ has the infinity type 
$\sum_{\sigma\in\Sigma}(a_\sigma\sigma+b_\sigma\bar{\sigma})$,
then $\lambda$ has the infinity type
$2\Sigma+\sum_{\sigma\in\Sigma}(a_\sigma-b_\sigma-1)(\sigma-\sigma^c)$.
To simplify notations
we then let $C(\lambda)=c(\eta')C(\chi,\K)$
and $W(\lambda)$ be the product of the $\varepsilon$-factors
at $w\in\Sigma_p$ and $w\mid \ff\fl_\circ$,
for $\fl_\circ$ in Lemma \ref{lem:good_chi}.

\begin{prop}\label{prop:L-function_at_s}
For $\alpha$ and $\lambda$ as above we define 
$\lambda^*=(\lambda)^{-c}\epsilon=\psi^{-1}\tilde{\alpha}$, then
\begin{equation*}
	\frac{1}{\Omega_p^{2\Sigma+2k'}}
	\int_{\fG_{\fs}^a}\tilde{\alpha}^\wedge\,L_\fs=
	C(\lambda)W(\lambda)\cdot 
	\frac{(2\pi i)^{k'}\Gamma(k'+2)
	}{\Omega_\infty^{2\Sigma+2k'}}
    L(0,\lambda)\cdot
	\prod_{w\mid \Sigma_p\text{ or }w\mid\ff\fl_\circ}
	(1-\lambda(\varpi_{\bw}))
	(1-\lambda^*(\varpi_{\bw}))
\end{equation*}
We recall that 
$k'=\sum_{\sigma\in\Sigma}(a_\sigma-b_\sigma-1)(\sigma-\bar{\sigma})$
is the infinity type of $\tilde{\eta}'$
for $\eta'=\eta\alpha=(\chi_\circ\mu)\alpha$.
\end{prop}

\begin{rem}
By the assumption \eqref{cond:gen_psi}
we can pick $\fl_\circ$ 
such that both $\psi(\varpi_{\fl_\circ})-1$
and $\omega\psi(\varpi_{\fl})-1$ are $p$-units.
Then $(1-\Psi_\fs(\varpi_{\bar{\fl}_\circ}))$
and $(1-\epsilon\Psi_\fs(\varpi_{\bar{\fl}_\circ}))$
are units in $\I_\fs^\times$.
We can multiplied $L_\fs$ with these 
to cancel the $L$-factors at $\fl_\circ$,
which doesn't change the ideal generated by 
the $L$-function in $\I_\fs$.
\end{rem}


\subsection{Main construction}

We now apply the formulation in \S\ref{sub:fund_exact_sequence}
to the eigensystem $\lambda^{\ord}_\fs$. Let
\[
    \lambda_\fs\colon \TT(U^p,\eo)\to\TT^{\ord}(U^p,\eo)\to\I_\fs
\]
denote the composition with $\lambda^{\ord}_\fs$,
$\fm\subset \TT(U^p_\fs,\eo)$ and
$\fm_2\subset \TT^\ord(U^p_\fs,\eo)$
denote the pre-images of the maximal ideal $\fm_{\I_\fs}$ of $\I_\fs$,
and let $\bar{\delta_1}, \bar{\delta_2}$
denote $\epsilon^{-1}\hat{\chi}_\circ\bmod \fm_{\I_\fs}$ 
and $\epsilon^{-1}\hat{\chi}_\circ\Psi_\fs\bmod \fm_{\I_\fs}$ 
respectively. We then have
\begin{itemize}
\item $T(U^p_\fs)=\bar{\delta}_1+\bar{\delta}_2\bmod \fm$.
\item The maximal ideal $\fm$ satisfies \eqref{cond:red_gen}
by \eqref{cond:gen_psi}.
\item The map $\lambda_\fs\colon \TT(U^p_\fs,\eo)\to \I_\fs$
is surjective by Chebotarev's density
since $\lambda_\fs(T_w^{(2)})=q_w\chi_0^2(\epsilon)\Psi_\fs(\varpi_w)$
for $v=w\bw$ in \eqref{def:hecke_away_p},
which form a set of density one.
\end{itemize}

\begin{defn}
Let $M^{\ord}(U^p_\fs,\I_\fs)\cong\Hom_{\I_\fs}
(S^{\ord}(U^p_\fs,\I_\fs),\I_\fs)$.
be the isomorphism from Proposition \ref{prop:ord_to_dual}.
We let $F_\fs\in M^{\ord}(U^p_\fs,\I_\fs)$
denote the pre-image of
$B_{\fs}(*,U_\fs^{-1}\euF_{\fs})$
under the isomorphism and define
\[
    \Theta_\fs=ev(\euF_\fs)\colon 
    M^{\ord}(U^p_\fs,\I_\fs)\cong\Hom_{\I_\fs}
    (S^{\ord}(U^p_\fs,\I_\fs),\I_\fs)\to\I_\fs.
\]
In particular we have $\Theta_\fs(F_\fs)=
B_\fs(\euF_\fs,U_\fs^{-1}\euF_\fs)=L_\fs$.
\end{defn}

\begin{lem}
The choice of $\Theta_\fs$ and $F_\fs$ above
satisfies \ref{cond:C1} and \ref{cond:C3}.
\end{lem}
\begin{proof}
That $\Theta_\fs$ satisfies \ref{cond:C1} 
follows from that $\euF_\fs$ is an eigenform
with eigensystem $\lambda_\fs^{\ord}$.
Decompose $\fG_\fs^a=\Delta_\fs\times W$
into the finite part and the free part.
The image of $L_\fs=\Theta_\fs(F_\fs)$
under $\alpha\colon \I_\fs\to \eo\llbracket W\rrbracket$,
for $\alpha\in\hat{\Delta}_\fs$,
is a $p$-adic $L$-function 
for the character $\epsilon\psi^{-1}\alpha$.
It is shown in \cite{Hida10}
that the $p$-adic $L$-function for such characters,
with the conductor only divisible by split primes,
is nonzero.
From which we conclude that \ref{cond:C3}
is also satisfied.
\end{proof}




\subsubsection{Residually reducible pseudo-representations}

We briefly recall the process of constructing
cohomology classes from a generically irreducible
pseudo-representation form \cite[\S 2.1]{urban}.
Suppose $T\colon \mathcal{G}\to A$
is a two-dimensional pseudo-representation
into a Henselian local ring $A$
with maximal ideal $\fm_A$
and of odd residual characteristic.
We assume there exists distinct characters
$\bar{\chi}_i\colon \mathcal{G}\to A/\fm_A$ of $\mathcal{G}$
for $i=1,2$ such that  
$T\equiv \bar{\chi}_1+\bar{\chi}_2\bmod \fm_A$.
After fixing $z\in \mathcal{G}$
with $\bar{\chi}_1(z)\neq \bar{\chi}_2(z)$
we apply the Henselian property on
\begin{equation*}
    P(z,X)=
    X^2-T(z)X+\det(T)(z) \equiv 
    (X-\bar{\chi}_1(z))(X-\bar{\chi}_2(z))
    \mod \fm_A
\end{equation*}
and lift the distinct roots $\bar{\chi}_i(z)$
to roots $\alpha,\beta$ of $P(z,X)$
with $\alpha-\beta\in A^\times$.
We then define the functions
\begin{equation}\label{eq:presentation}
   A(\sigma)=
   \frac{T(\sigma z)-\beta T(\sigma)}{\alpha-\beta}\quad
   D(\sigma)=
   \frac{T(\sigma z)-\alpha T(\sigma)}{\beta-\alpha}\quad
   x(\sigma,\tau)=a(\sigma\tau)-a(\sigma)a(\tau).
\end{equation}
Then 
$A(\sigma)\equiv \bar{\chi}_1(\sigma)$,
$D(\sigma)\equiv \bar{\chi}_2(\sigma)\bmod\fm_A$,
and $x(\sigma,\tau)$
generate the reducibility ideal of $T$.

\begin{lem}\cite[Lem 2.1.1]{urban}
Let $R$ be an $A$-algebra with structure 
homomorphism $\phi\colon A\to R$.
Suppose the reducibility ideal 
$I$ of $T$ is contained $\ker(\phi)$,
so $\chi_1\coloneqq \phi\circ A(\sigma)$
and $\chi_2\coloneqq \phi\circ D(\sigma)$
are characters $\chi_i\colon \mathcal{G}\to R^\times$.
Write $\chi=\chi_1\chi_2^{-1}$,
then we have a canonical map
\[
    \Hom_A(I/I^2, R)\to 
    H^1(\mathcal{G}\times\mathcal{G}, 
    R(\chi)\boxtimes R(\chi^{-1}))\quad
    f\mapsto \chi_2(\sigma)^{-1}\chi_1(\tau)^{-1}
    f(x(\sigma,\tau)\bmod I^2).
\]
\end{lem}

Moreover, when $A$ is an integral domain
and there exists $\sigma_0,\tau_0$ such that
$x(\sigma,\tau)/x(\sigma_0,\tau_0)\in A$, then 
\[
    \sigma\mapsto 
    \begin{pmatrix}
        A(\sigma)& B(\sigma)\\
        C(\sigma) & D(\sigma)
    \end{pmatrix}\coloneqq
    \begin{pmatrix}
        A(\sigma)& x(\sigma,\tau_0)/x(\sigma_0,\tau_0)\\
        x(\sigma_0,\sigma) & D(\sigma)
    \end{pmatrix}
        \in \GL_2(\A)
\]
defines a group representation representation.
Let $B\subset A$ and $C\subset A$
be the ideals generated respectively by the 
upper-right and lower-left entries.
Then the collection $A, B, C$
forms a generalized matrix algebra 
and the following propostion is a restatement
of \cite[Thm 1.5.5]{BC} in this case.
\begin{prop}
Under the same assumptions in the previous lemma,
there exists injections 
\begin{align*}
    \Hom_A(B,R)&\hookrightarrow H^1(\mathcal{G},R(\chi))\quad
    f\mapsto \chi_2(\sigma)^{-1}f(B(\sigma))\\
    \Hom_A(C,R)&\hookrightarrow H^1(\mathcal{G},R(\chi^{-1}))\quad
    f\mapsto \chi_1(\tau)^{-1}f(C(\tau))
\end{align*}
\end{prop}

\begin{rem}
The idea of constructing nontrivial cohomology classes
from generically irreducible deformations
dates back to the proof of the converse of
Herbrand-Ribet theorem in \cite{Ribet1976}
and is further investigated in \cite{Urban1999}.
It is now commonly refered as Urban's lattice construction
in applications to Iwasawa theory.
\end{rem}

\subsubsection{Condition C3}

Identify $D_{w_0}$ with $\Gp$ and
let $\bar{\chi}_i$ denote
$\omega\bar{\delta}_i\vert_{\Gp}$ for $i=1,2$.
We let $R^{\zeta\epsilon}\to \TT(U^p_\fs,\eo)_\fm$
be the homomorphism in Proposition \ref{lem:twist}
where $R^{\zeta\epsilon}$ is the universal 
deformation of $\bar{\chi}_1+\bar{\chi_2}$
with determinant $\zeta\epsilon$,
for a fixed crystalline character 
$\zeta\colon \Gp\to\eo^\times$
such that $\zeta\epsilon\equiv\bar{\chi}_1\bar{\chi}_2$.

Since $\fm$ satisfies \eqref{cond:red_gen},
there exists $z\in\Gp$ such that 
$\bar{\chi}_1(z)\neq\bar{\chi}_2(z)$.
We then use the roots $\alpha_0,\beta_0$ of $P(z,X)$
and construct the $R^{\zeta\epsilon}$-valued functions
$A_0(\sigma),D_0(\sigma)$, and $x_0(\sigma,\tau)$ 
on $\Gp$ by \eqref{eq:presentation}.
Moreover, since $R^{\zeta\epsilon}$
is isomorphic to a power series ring of 3 variables
and the reducibility ideal is generated by a regular element,
there exists $\sigma_0,\tau_0\in\Gp$ such that
$\xx=x(\sigma_0,\tau_0)$ is a 
generator of the reducibility ideal.

\begin{defn}\label{def:fq_ideal}

Let $\alpha,\beta\in \TT(U^p_\fs,\eo)_\fm$
denote the images of the roots $\alpha_0,\beta_0$
under the homomorphism $R^{\zeta\epsilon}\to \TT(U^p_\fs,\eo)_\fm$.
We can define the $\TT(U^p_\fs,\eo)_\fm$-valued functions
$A(\sigma), D(\sigma)$, and $x(\sigma,\tau)$ on $\Gal_\K$
by \eqref{eq:presentation}.
Note that by definition the restriction of which to 
$D_{w_0}=\Gp$ coincides with the images of the functions
$A_0(\sigma), D_0(\sigma)$, and $x_0(\sigma,\tau)$.
Then for $\sigma_0,\tau_0\in\Gp$ such that 
$\xx=x_0(\sigma_0,\tau_0)$, we define the ideal
\[
    \fq_\fs=\{x(\sigma,\tau_0)\mid\sigma\in\TT(U^p_\fs,\eo)_\fm[\Gal_\K]\}
    \subset \TT(U^p_\fs,\eo)_\fm.
\]
\end{defn}

\begin{lem}
With notations as above we have the following results.
\begin{enumerate}
    \item If $\tau\in D_w$ for $w\in\Sigma_p\setminus\{w_0\}$,
    then $x(\tau,\sigma_0)=0$ for any $\sigma_0\in \Gal_\K$.
    \item If $\tau\in D_{\bw}$ for $w\in\Sigma_p\setminus\{w_0\}$,
    then $x(\sigma_0,\tau)=0$ for any $\sigma_0\in \Gal_\K$.
\end{enumerate}
\end{lem}

\begin{proof}

By the density result from Corollary \ref{cor:density},
it suffices to show that
the claimed results hold
when $T(U^p_\fs)_\fm$
is replaced by $\mtr(r_\fp)$ 
for the Galois representation $r_\fp$
associated to a minimal prime ideal
$\fp\subset \TT_{\wt{k}}(U^p_\fs\Iw^P(p^{0,1}),E)_\fm$
as in Definition \eqref{def:rep_prime}.
We let $A_\fp(\sigma), D_\fp(\sigma)$, and $x_\fp(\sigma,\tau)$
denote the images of the function
under the homomorphism $\lambda_\fp\colon \TT(U^p_\fs,\oo)\to E$.

Observe that since $r_\fp\vert_{D_w}$
is reducible by Lemma \ref{lem:galois_at_p},
we have $x_\fp(\sigma,\tau)=0$
for $\sigma,\tau\in D_w$.
The density result then implies that
$x(\sigma,\tau)=0$
for $\sigma,\tau\in D_w$.
In particular 
$A\vert_{D_w}$ and
$D\vert_{D_w}$ are 
$\TT(U^p_\fs,\oo)$-valued characters that satisfies the equation
\[
    A\vert_{D_w}+D\vert_{D_w}=T(U^p_\fs)\vert_{D_w}=
    \Psi_{w,1}+\Psi_{w,2}\epsilon^{-1}
\]
for the characters $\Psi_{w,i}$
in Definition \ref{prop:big_char_at_p}.
Since the big Hecke algebra $\TT(U^p_\fs,\eo)$ is reduced,
by passing to the total ring of fractions,
we see that $A\vert_{D_w}$ coincides with 
either $\Psi_{w,1}$ or $\Psi_{w,2}\epsilon^{-1}$.
It then follows from 
$ \lambda_\fs\circ \Psi_{w,1}=
\epsilon^{-1}\hat{\chi}_\circ\Psi=
\lambda_\fs\circ D\vert_{D_w}$ that we have
\begin{equation}\label{eq:id_char}
    A\vert_{D_w}=\Psi_{2,w}\epsilon^{-1} \text{ and }
    D\vert_{D_w}=\Psi_{1,w}
\end{equation}

Now, the choice of $z\in D_{w_0}$
determines a basis for $r_\fp$
that allows us to present the representation as
$r_\fp(\sigma)=\smat{a_\sigma & b_\sigma\\ c_\sigma & d_\sigma} 
\text{ for }\sigma\in\Gal_\K$
such that $r_\fp(z)=\smat{\alpha&\\&\beta}$.
Here we abuse the notation and 
let $\alpha,\beta$ denote the respective images in $\eo$
under $\lambda_\fp$.
Since $\lambda_\fp\circ T(U^p_\fs)_\fm=\mtr(r_\fp)$,
apply formulae \eqref{eq:presentation} and
we can identify
\[
A_{\fp}(\sigma)=a_\sigma,\quad
D_{\fp}(\sigma)=d_\sigma,\quad 
x_{\fp}(\sigma,\tau)=b_\sigma c_\tau.
\]
It then follows from Lemma \ref{lem:galois_at_p}
and the equalities in \eqref{eq:id_char} that 
$r_\fp(\tau)-D_{\fp}(\tau)\id=\smat{a_\tau-d_\tau&b_\tau\\c_\tau& 0}$
has a common nonzero kernel vector $\smat{x\\y}$
for $\tau\in D_w$.
We can separate into two cases.
\begin{itemize}
    \item If $x\neq 0$, then $xc_\tau=0$ implies that $c_\tau=0$.
    This implies that $\psi_2\epsilon^{-1}$
    in Lemma \ref{lem:galois_at_p}
    is also a subrepresentation.
    Therefore $r_\fp\vert_{D_w}$ is split and $b_\tau=0$ as well.
    \item If $x=0$ and $y\neq 0$, this implies that
    $yb_\tau=0$ and hence $b_\tau=0$.
\end{itemize}
We can now conclude that 
$b_\tau=0$ if $\tau\in D_w$
and therefore $x_\fp(\tau,\sigma_0)=b_\tau c_{\sigma_0}=0$
for all $\sigma_0\in\Gal_\K$ if $\tau\in D_w$.

The proof for the second result is similar.
It suffices to show that 
$x_\fp(\tau^c,\sigma_0)=0$
for any $\sigma_0\in\Gal_\K$
if $\tau\in D_w$.
Write 
$A^c(\sigma)=A(\sigma^c),D^c(\sigma)=D(\sigma^c)$
and similarly for $A_\fp^c$ and $D_\fp^c$.
We first note that 
\[
A^c\vert_{D_w}+D^c\vert_{D_w}=(T(U^p_\fs)_\fm)^c\vert_{D_w}
=\Psi_{w,1}^{-1}\epsilon^{-1}+\Psi_{w,2}^{-1}
\]
and a similar argument as above allows us to conclude that
\begin{equation}\label{eq:id_char'}
    A^c\vert_{D_w}=\Psi_{2,w}^{-1} \text{ and }
    D^c\vert_{D_w}=\Psi_{1,w}^{-1}\epsilon^{-1}.
\end{equation}
Now by Lemma \ref{lem:galois_at_p} again
we see that $r_\fp^c\vert_{D_w}\cong r_\fp^\vee\epsilon^{-1}\vert_{D_w}$
has $\psi_2^{-1}$ as a subrepresentation.
Therefore,  write 
$r_\fp(\sigma^c)=\smat{a^c_\sigma & b^c_\sigma\\ c^c_\sigma & d^c_\sigma}$,
we see that
$r_\fp(\tau^c)-A^c_\fp(\tau)\id=
\smat{0& b_\tau^c\\ c_\tau^c & d_\tau^c-a_\tau^c}$
has a common nonzero kernel vector for $\tau\in D_w$.
We then conclude similarly that
$c_\tau^c=0$ and 
$x_\fp(\sigma_0,\tau^c)=b_{\sigma_0}c_\tau^c=0$
for all $\sigma_0\in\Gal_\K$ if $\tau\in D_w$.

\end{proof}


\begin{prop}
The ideal  $q_{\fs}$
satisfies the condition \ref{cond:C2}
in \S\ref{sub:fund_exact_sequence}.
\end{prop}

\begin{proof}

By definition we have $\xx=x(\sigma_0,\tau_0)\in \fq_\fs$.
And since the pairing 
$B_\fs(\cdot,\cdot)$ satisfies
$B_\fs(T\cdot \euF_1,\euF_2)=B_\fs(\euF_1,T\cdot \euF_2)$
for $T\in \TT(U^p_\fs,\eo)$
and the action of $\TT(U^p_\fs,\eo)_\fm$
on $\euF_\fs$ factors through $\lambda_\fs$,
the same is true for 
$F_\fs\in M^{\ord}(U^p_\fs)_{\fm,2}=
M^{\ord}(U^p_\fs)_\fm\otimes_{\Lambda^+_\fs}
\eo\llbracket\fG_\fs^a\rrbracket$.
In particular $\fq_\fs F_\fs=0$
since $\lambda_\fs\circ T(U^p_\fs)_\fm$
is reducible.
Thus it remains to show that 
$\fq_\fs M^{\ord}(U^p_\fs)'_{\fm,1}=0$
which is the part on which the action of $\Qp^\times$
via $\langle\iota_{w_0}^{-1}\smat{*&\\&1}\rangle$
has all the irreducible subquotients
isomorphic to $\bar{\delta}_1$ instead of $\bar{\delta}_2$.
Applying the same method of argument
in previous lemma to $\TT^{\ord}(U^p_\fs,\eo)_{\fm,1}$
shows that the image of $x(\sigma_0,\tau)$
in which vanishes if $\tau\in D_{w_0}$.
In particular we have that $x(\sigma,\tau_0)$
acts by $0$ on $M^{\ord}(U^p_\fs)'_{\fm,1}$,
which gives the desired result.

\end{proof}


We can now apply Corollary \ref{cor:fund} 
and obtain the commutative diagram
\begin{equation}
    \begin{tikzcd}
    & (M_\fs/S_\fs)
    \arrow[r]\arrow[d,equal] &
    (M_\fs/S_\fs)\otimes_{\TT}\fq_\fs
    \arrow[r]\arrow[d,"(a)"] &
    (M_\fs/S_\fs)\otimes_{\TT}\fq_\fs^\red
    \arrow[r]\arrow[d] &0\\
    0\arrow[r] &
    (M_\fs/S_\fs)
    \arrow[r] &
    \fq_\fs M_\fs/\fq_\fs S_\fs
    \arrow[r,"(b)"] &
    \fq_\fs M^{\ord}_{\fs}/\fq_\fs S^{\ord}_{\fs}
    \arrow[r] &0
    \end{tikzcd}
\end{equation}
for $M^{\ord}_{\fs}=M^{\ord}(U^p_\fs,\I_\fs)_{\fm_2}$,
$S^{\ord}_{\fs}=\ker(\Theta_\fs)$,
$M_\fs=\Hom_{Q'}(\tilde{P}_{2,\fm},M(U^p_\fs)_{\fm}')
\otimes_{\Lambda_{\fs}^+}\I_\fs$,
and $S_\fs$ the pre-image of $S^{\ord}_\fs$
under $M_\fs\to M^{\ord}_\fs$.
Let $\tilde{F}_\fs\in M_\fs$
be any pre-image of $F_\fs\in M^{\ord}_{\fs}$
under the surjective map $M_\fs\to M_{2,\fs}$.
We let $y_\fs(\sigma)$ be the 
$\fq_\fs M_\fs/\fq_\fs S_\fs$-valued function 
which is the image under $(a)$ of
\[
\sigma\mapsto 
(\tilde{F}_\fs\bmod S_\fs)\otimes x(\sigma,\tau_0)\in 
(M_\fs/S_\fs)\otimes_\TT\fq_\fs
\]
Then the image of $y_\fs(\sigma)$ under $(b)$
is $x(\sigma,\tau_0)F_\fs\in \fq_\fs F_\fs=0$ by \eqref{cond:C2}.
By the exactness of the sequence,
we may thus view $y_\fs(\sigma)$
as a $M_\fs/S_\fs$-valued function.

\begin{thm}\label{thm:eu1}
The $\eo\llbracket \fG_\fs^a\rrbracket$-valued function
$\Theta_\fs(y_\fs(\sigma))$
is a 1-cocycle with coefficients in 
$\eo\llbracket \fG_\fs^a\rrbracket(\Psi^{-1})$.
The associated cohomology class
$z_\fs(\sigma)\in H^1(\K, \eo\llbracket \fG_\fs^a\rrbracket(\Psi^{-1}))$
then has the following properties.
\begin{enumerate}
    \item The class $z_\fs(\sigma)$ is unramified 
    at all but finitely many places.
    \item For $w\in \Sigma_p\setminus\{w_0\}$,
    the restriction $res_{w}(z_\fs)$ is trivial.
    \item For the special place $w_0$,
    the restriction $res_{w_0}(z_\fs)=(\mathcal{L}_{\fs})$.
\end{enumerate}
\end{thm}

\begin{proof}
That $\Theta_\fs(y_\fs(\sigma))$ forms a $1$-cocycle
follows from the relation
(see \cite[\S 2.1.4]{pan})
\[
    x(\sigma\tau,\tau_0)=
    A(\sigma)x(\tau,\tau_0)+
    x(\sigma,\tau_0)D(\tau).
\]
Now the first property 
follows from that the same is true 
for the pseudo-representation $T(U^p_\fs)_\fm$.
The second follows from the lemma above.
And the last follows from that
when we take $\tau=\tau_0\in D_{w_0}$,
we can see that $y_\fs(\sigma_0)$
is the image of $F_{\fs}$
and therefore $\Theta_\fs(y_\fs(\sigma))=\Theta_{\fs}(F_\fs)=\mathcal{L}_\fs$.


\end{proof}

The restriction of $z_\fs$
to $D_{w_0}$ is the image of 
\[
    x(\sigma,\tau_0)\otimes_{\TT}\mathcal{L}_\fs
    \in H^1(D_{w_0}, (\xx)\otimes_{\TT}\eo\llbracket\fG_\fs^a\rrbracket))
    \cong
    H^1(D_{w_0}, \eo\llbracket\fG_\fs^a\rrbracket))
\]
where the isomorphism
follows from that $(\xx)$ is $\TT$-free.
And the cohomology class is nontrivial
by \cite[Thm 1.5.5]{BC}
since the map 
$\Hom((\xx), (\xx)\otimes_{\TT}\I_\fs)$
is nontrivial
by Nakayama's lemma and that $\xx\neq 0$ in $\TT$.
In particular it is $\mathcal{L}_\fs$
times the nontrivial class
\[
    x(\sigma,\tau_0)\otimes_{\TT}1
    \in H^1(D_{w_0}, (\xx)\otimes_{\TT}\eo\llbracket\fG_\fs^a\rrbracket))
    \cong
    H^1(D_{w_0}, \eo\llbracket\fG_\fs^a\rrbracket))
\]


\subsection{Euler systems}

In this subsection,
between different tame levels $\fs$
we compare the cohomology classes 
$z_\fs(\sigma)\in H^1(\K,\eo\llbracket\fG_\fs^a\rrbracket(\Psi))$.
Let $\ell=\fl\fl^c$ be a prime ideal of $\F$
that is split in $\K$
and let $\TT(U^p_{\fs\ell},\eo)\to \TT(U^p_{\fs},\eo)$
and $\phi_{\fs\ell}^\ell\colon 
\eo\llbracket\fG_{\fs\ell}^a\rrbracket\to
\eo\llbracket\fG_\fs^a\rrbracket$
be the natural projections.
We have the commutative diagram
\[
\begin{tikzcd}
	& \TT(U^p_{\fs\ell},\eo)_\fm\arrow[d] \arrow[r,"\lambda_{\fs\ell}"]
    &\eo\llbracket\fG_\fs^a\rrbracket \arrow[d,"\phi_{\fn\ell}^\ell"]\\
	R_{\fm}^{\epsilon\zeta}\arrow[r]\arrow[ur]
	& \TT(U^p_\fs,\eo)_\fm \arrow[r,"\lambda_\fs"] &
    \eo\llbracket\fG_\fs^a\rrbracket
\end{tikzcd}
\]
and the functions $A(\sigma), D(\sigma)$
and $x(\sigma,\tau)$,
which only depends on the choice of $z\in D_{w_0}$
when considering the universal pseudo-deformation
to $R_\fm^{\epsilon\zeta}$,
are compatible between different tame levels.

On the other hand, let 
$V_\fl\colon S^{\ord}(U^p_\fs)\to S^{\ord}(U^p_{\fs\ell})$
be the map given by 
$(V_\fl f)(g)=f(g\iota_\fl^{-1}(\smat{1&\\&\varpi_\fl}))$,
then
\begin{equation}\label{eq:compare_level}
    (\id\otimes\phi^\ell_{\fs\ell})(\euF_{\fs\ell})=
	\big(1-V_\fl\otimes(\epsilon^{-1}\hat{\chi}_\circ\Psi)^{-1}(\Fr_\fl)\big)
	\euF_{\fs}
    \in S^{\ord}(U^p_\fs)\hat{\otimes}_\eo
        \eo\llbracket \fG_\fs^a\rrbracket.
\end{equation}


\begin{lem}\label{lem:compare_L_diff_level}
Define 
$P_\ell=(1-\epsilon^{-1}\Psi(\Fr_{\bar{\fl}}))
(1-\Psi(\Fr_{\bar{\fl}}))\in
\eo\llbracket\fG_\fs^a\rrbracket$.
Suppose $(\euF'_{\fs\ell}, \euF'_\fs)$ 
is another pair of Hida families in 
$S^{\ord}(U^p_{\fs\ell},\eo\llbracket\fG_{\fs\ell}^a\rrbracket$ and
$S^{\ord}(U^p_{\fs},\eo\llbracket\fG_{\fs}^a\rrbracket$ 
that satisfies \eqref{eq:compare_level}, then
\[
	\phi_{\fs\ell}^\ell
    \big(B_{\fs\ell}(\euF'_{\fs\ell}, U_{\fs\fl}^{-1}\euF_{\fs\ell})\big)=
	P_\ell\cdot B_{\fs}(\euF'_{\fs}, U_\fs^{-1}\euF_{\fs})
    \in \eo\llbracket\fG_\fs^a\rrbracket.
\]
In particular, 
the $p$-adic L-function $\mathcal{L}_\fs$ satisfies 
$\phi_{\fs\ell}^\ell(\mathcal{L}_{\fs\ell})=
P_\ell\cdot \mathcal{L}_\fs$.
\end{lem}

\begin{proof}
Let $\alpha$ and  $\beta$ denote 
$\epsilon^{-1}\hat{\chi}_\circ(\Fr_\fl)$ and 
$\epsilon^{-1}\hat{\chi}_\circ\Psi(\Fr_\fl)$
and apply \cite{lee}, we have
\begin{multline*}
\phi_{\fs\ell}^\ell
\big(B_{\fs\ell}(\euF'_{\fs\ell}, \euF_{\fs\ell})\big)=
B_\fs(\euF'_\fs, T_\fl^{(1)}\euF_\fs)
-2(q_\fl+1)\beta^{-1}B_\fs(\euF'_\fs, T_\fl^{(2)}\euF_\fs)
+\beta^{-2}B_\fs(T_\fl^{(1)}\euF'_\fs, T_\fl^{(2)}\euF_\fs)
\\=
[(\alpha+\beta)-2(q_\fl^{-1}+1)(\alpha)
+q_\fl^{-1}(\alpha+\beta)(\alpha\beta^{-1})]\cdot 
B_\fs(\euF_{\fs}, \euF^\circ_\fs)=
(\alpha-\beta)[q_\fl^{-1}(\alpha\beta^{-1})-1]\cdot 
B_\fs(\euF_{\fs}, \euF^\circ_\fs).
\end{multline*}
Now the lemma follows from
$(\alpha-\beta)(q_\fl^{-1}(\alpha\beta^{-1})-1)
=\beta(1-(\alpha/\beta))(1-(\alpha/\beta)q_\fl^{-1})
=\beta\cdot P_\ell$.
\end{proof}



\begin{thm}\label{thm:eu2}
    Between different tame levels,
    the Galois cohomology classes $z_\fs(\sigma)$ satisfies
	\[
		\phi_{\fs\ell}^{\ell}\colon
		H^1(\K,\eo\llbracket\fG_{\fs\ell}^a\rrbracket(\Psi^{-1}))\to 
		H^1(\K,\eo\llbracket\fG_\fs^a\rrbracket(\Psi^{-1}))\quad
		z_{\fs\ell}\mapsto
		P_\ell\cdot z_\fs
	\]
\end{thm}

\begin{proof}
Consider the following commutative diagram
where the vertical maps
are induced by $\phi_{\fs\ell}^\ell$
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
& M_{\fs\ell}/S_{\fs\ell}\arrow{dd} \arrow[rd,equal]\arrow[rr]
&& \fq_{\fs\ell}\otimes M_{\fs\ell}/S_{\fs\ell}
	\arrow[rd,twoheadrightarrow]\arrow[rr]\arrow[dd]
&& \fq_{\fs\ell}^{\red}\otimes M_{\fs\ell}/S_{\fs\ell}\arrow[dd]\arrow[rd]\\
0 \arrow[crossing over]{rr} 
&& M_{\fs\ell}/S_{\fs\ell}
	\arrow[crossing over]{dd} \arrow[crossing over]{rr} 
&& \fq_{\fs\ell}M_{\fs\ell}/\fq_{\fs\ell}S_{\fs\ell}
	\arrow[crossing over]{dd}\arrow[crossing over]{rr} 
&& \fq_{\fs\ell}M_{\fs\ell}^{\ord}/\fq_{\fs\ell}S^{\ord}_{\fs\ell}
	\arrow{dd} \arrow[rr] && 0\\
& M_{\fs}/S_{\fs}\arrow{rr}\arrow[rd,equal]
&& \fq_{\fs}\otimes M_{\fs}/S_{\fs}
	\arrow{rr} \arrow[rd,twoheadrightarrow]
&& \fq_{\fs}^{\red}\otimes M_{\fs}/S_{\fs} \arrow[rd]& & & \\
0 \arrow[crossing over]{rr} 
&& M_{\fs}/S_{\fs} \arrow[crossing over]{rr} 
&& \fq_{\fs}M_{\fs}/\fq_{\fs}S_{\fs}\arrow[crossing over]{rr} 
&& \fq_{\fs}M_{\fs}^{\ord}/\fq_{\fs}S_{\fs}^{\ord} \arrow[rr] && 0
\arrow[from=2-3,to=4-3,crossing over]
\arrow[from=2-5,to=4-5,crossing over]
\end{tikzcd}
\end{equation*}
Since the image of 
$F_{\fs\ell}\otimes x(\sigma,\tau_0)$
downstair is 
$\big(1-V_\fl\otimes(\epsilon^{-1}\hat{\chi}_\circ\Psi)^{-1}
(\Fr_\fl)\big)F_{\fs}\otimes x(\sigma,\tau_0)$,
a similar relation also holds
between $y_{\fs\ell}(\sigma)$ and $y_\fs(\sigma)$.
Therefore by Lemma \ref{lem:compare_L_diff_level} we have
$\phi_{\fs\ell}^\ell(z_{\fs\ell}(\sigma))=P_\ell\cdot z_{\fs}(\sigma)$.

	
\end{proof}


\section{Iwasawa main conjecture}


In last section,
when $\psi$ is a finite order Hecke character for $\K$
with prime-to-$p$ conductor that consists only of split primes,
under the assumption \ref{cond:K2}-\ref{cond:K4}
we have constructed a system of cohomology
classes $z_\fs(\sigma)\in H^1(\K,\eo\llbracket\fG_\fs^a\rrbracket(\Psi^{-1}))$
in Theorem \ref{thm:eu1}
that satisfies the Euler system-like relation
in Theorem \ref{thm:eu2}.
Here $\fG_\fs^a$ is the Galois group of the maximal pro-$p$
anticyclotomic abelian extension over $\K$
which is unramified outside $p$
and an ideal $\fs=\fs^c$ that consists only 
of split primes.
We write $\I_\fs=\eo\llbracket\fG_\fs^a\rrbracket$
and $\Psi\colon\Gal_\K\to\I_\fs^\times$
is the tautological character twisted by $\psi^{-1}$.
We summarize below the properties of
$z_\fs\in H^1(\K,\I_\fs(\Psi^{-1}))$.
\begin{enumerate}
    \item There existed a finite set $R$ of primes of $\K$
    such that each class $z_\fs(\sigma)$ is unramified 
    away $R$ and $p\fs$.
    \item For $w\in \Sigma_p\setminus\{w_0\}$,
    the restriction $res_{w}(z_\fs)$ is trivial.
    \item For $w_0$,
    the restriction $res_{w_0}(z_\fs)=(\mathcal{L}_{\fs})$
    for $\mathcal{L}_\fs$ in Proposition \ref{prop:L-function_at_s}.
    \item Define $P_\ell=(1-\epsilon^{-1}\Psi(\Fr_{\bar{\fl}}))
    (1-\Psi(\Fr_{\bar{\fl}}))\in\I_\fs$
    when $\ell=\fl\fl^c$ is a split prime
    and let $\phi_{\fs\ell}^\ell\colon \I_{\fs\ell}\to \I_\fs$
    be the natural projection, then 
    $\phi_{\fs\ell}^{\ell}\colon
	H^1(\K,\I_{\fs\ell}(\Psi^{-1}))\to H^1(\K,\I_\fs(\Psi^{-1}))$
    sends $z_{\fs\ell}$ to $P_\ell\cdot z_\fs$.
\end{enumerate}
Write $\mathcal{L}_\fs=\mathcal{L}$
when $\fs=\oo_\K$,
our goal in this section is
to give an upper bound of the Selmer group
associated to $\psi$ by the $p$-adic L-function $\mathcal{L}$
given the existence of the above Euler system.


Let $\iota\colon \I_\fs\to \I_\fs$
be the involution that sends $\langle g\rangle$
to $\langle g^{-1}\rangle$.
Then $\iota\colon \I_\fs(\Psi^{-1})\to \I_\fs(\Psi)$
is an isomorphism between Galois modules. 
Replace the above cohomology classes by their images
in $H^1(\K, \I_\fs(\Psi))$, they have the properties.
\begin{enumerate}
    \item There existed a finite set $R$ of primes of $\K$
    such that each class $z_\fs(\sigma)$ is unramified 
    away $R$ and $p\fs$.
    \item For $w\in \Sigma_p\setminus\{w_0\}$,
    the restriction $res_{w}(z_\fs)$ is trivial.
    \item For $w_0$,
    the restriction $res_{w_0}(z_\fs)=(\mathcal{L}_{\fs})$
    for $\mathcal{L}_\fs$ that satisfies
    \[
        \tilde{\alpha}(\mathcal{L}_\fs)
        \sim L(0, \lambda)
        \prod_{\Sigma_p}
        (1-\lambda(\varpi_{\bw}))(1-\lambda^*(\varpi_{\bw}))
        \sim L(0,(\psi\tilde{\alpha}))
        \prod_{\Sigma_p}
        (1-(\psi\tilde{\alpha})^*(\varpi_w))(1-(\psi\tilde{\alpha})(\varpi_{w}))
    \]
    for $\lambda=\epsilon(\psi\tilde{\alpha})^{-1}$
    and $\lambda^*=(\psi\tilde{\alpha})^{-1}$.
    If $\tilde{\alpha}$ has type $(-k,k)$ for $k>0$.
    \item Define $P_\ell=(1-\epsilon^{-1}\Psi(\Fr_\fl))
    (1-\Psi(\Fr_\fl))\in\I_\fs$
    when $\ell=\fl\fl^c$ is a split prime
    and let $\phi_{\fs\ell}^\ell\colon \I_{\fs\ell}\to \I_\fs$
    be the natural projection, then 
    $\phi_{\fs\ell}^{\ell}\colon
	H^1(\K,\I_{\fs\ell}(\Psi))\to H^1(\K,\I_\fs(\Psi))$
    sends $z_{\fs\ell}$ to $P_\ell\cdot z_\fs$.
\end{enumerate}

\begin{rem}
The above new $L$-function is $L_p(\psi, \Sigma^c)$
This should bound the Selmer group
$\Sel(\psi,\Sigma^c)$ that is strict at $\Sigma$
or by functional equation bound the Selmer group
$\Sel(\epsilon\psi^{-1},\Sigma)$
that is strict at $\Sigma^c$.
\end{rem}

\subsection{Anticyclotomic extensions}

We start by recalling some facts about 
anticyclotomic extensions and their Galois groups.
For a prime-to-$p$ ideal $\fs=\fs^c$ as above
let $V=V_\fs=(1+\fs\widehat{\oo}_\K)^\times$,
by class field theory
$\Cl(V)\coloneqq \K^\times\backslash\A_{\K,f}^\times/V$
is isomorphic to the ray class group of conductor $\fs$
and fits into the exact sequence
\[
	1\to \oo_\K^\times\backslash U/V
	\to \Cl(V)\to \Cl_\K\to 1
\]
for $U=\widehat{\oo}_\K^\times$.
Let $\tilde{V}\subset V$
be the open compact subgroup
such that $U/\tilde{V}$
is isomorphic to the maximal pro-$p$ quotient
$\Delta_\fs$ of $(\oo_\K/\fs)^\times$.
Then the maximal pro-$p$ quotient $G_\fs$ of 
$\Cl(\tilde{V})$ fits into an exact sequence
\[
	1\to \oo_\K^\times\backslash \Delta_\fs
	\to G_\fs\to C_\K\to 1
\]
where $C_\K$ is the maximal pro-$p$ quotient
of the class group $\Cl_\K$.
As $\fs=\fs^c$,
each group above admits the action 
of the complex conjugation.
Let the supscript $\pm$
denote the subgroups on which 
the complex conjugation 
takes a group element
to itself or the inverse,
and let the subscript $a$
(which stands for anticyclotomic)
denote the quotient by the $+$part.
As $p$ is odd,
we have $1-c\colon G_\fs^a\cong G_\fs^-$
and similary for $\oo_\K^\times\backslash \Delta_\fs$
and $C_\K$.
If particular,
if we fix a splitting $\fs=\ff\ff^c$
with $\ff+\ff^c=\oo_\K$,
then $(1-c)\Delta_\fs^-$ is isomorphic to $\Delta_\ff$,
the maximal pro-$p$ quotient of $(\oo_\K/\ff)^\times$,
and the $(1-c)\oo_\K^\times$-action on which 
factors through the usual action of $W_p$,
the group of $p$-power roots of unity in $\K$.
Therefore we have the exact sequence
\[
    1\to W_p\backslash \Delta_\ff\to G_\fs^a\to C_\K^a\to 1.
\]

Now, for any ideal 
$\fa=\prod_{w\in\Sigma_p}\fp_w^{n_w}$
divisible only by primes in $\Sigma_p$
and $\fs=\fs^c$ as above
we write $\tilde{V}_\fa=\tilde{V}^p\times U_\fa$
for $U_\fa=(1+\fa\fa^c\oo_{\K,p})^\times$.
Let $G_{\fs\fa}$
be the maximal pro-$p$ quotient of $\Cl(\tilde{V}_\fa)$,
then the same procedure as above gives
the exact sequence
\[
    1\to W_p\backslash(\Delta_\ff\times\Delta_\fa)\to 
    G_{\fs\fa}^a\to C_\K^a\to 1
\]
where $\Delta_\fa$ is the product over $w\in\Sigma_p$
of $(1+\varpi_w\oo_w)/(1+\varpi_w^{n'_w}\oo_w)$
for $n'_w=\max\{n_w,1\}$.
Then $\fG_\fs^a$ is isomorphic to $\varprojlim G_{\fs\fa}^a$,
where $\fa$ goes through all ideals as above,
and fits into the exact sequence
\[
    1\to W_p\backslash(\Delta_\ff\times U_1)\to 
    \fG_{\fs}^a\to C_\K^a\to 1
\]
where $U_1\coloneq\prod_{w\in\Sigma_p}(1+\varpi_w\oo_w)$.

\begin{defn}\label{def:anticyc_extn}

Let $\fl\neq \fl^c$
be a prime-to-$p$ split prime
and write $\ell=\fl\fl^c$.
We define $H(\ell)=W_p\backslash\Delta_\fl$ and 
$G(\ell)=G_\ell^a$.
Let $\K(\ell)/\K$
be the Galois extension associated to $G(\ell)$, then 
$Gal(\K(\ell)/\K(\id))\cong H(\ell)$,
where $\K(\id)/\K$
is the unramified extension associated to $C_\K^a$.
In general,
if $\fs=\ff\ff^c$
and $\ff=\prod_i^r\fl_i$
is a square-free product of prime-to-$p$ split primes,
we define $K(\fs)$
as the product of all $K(\ell_i)$,
note that 
\[
    Gal(\K(\fs)/\K(\id))\cong 
    H(\ell_1)\times\cdots\times H(\ell_r)
\]
is in general not isomorphic to 
$W_p\backslash \Delta_\ff$
but a quotient of which.
Similarly, if $w\in \Sigma_p$
we write $G(w^n)=G_{\fs\fp_w^n}^a$
for $\fs=\oo_\K$ and
define $H(w^n)$ and $K(w^n)$ similarly.
Then for $\fs$ as above
we put $\K(\fs w^n)=K(\fs)K(w^n)$.

\end{defn}

Let $E$ be the field of fraction
of the complete discrete valuation ring
$\eo$ and let 
$\ord_p\colon E^\times/\eo^\times\to \Q$
be the normalized order
such that $\ord_p(p)=1$.
Suppose $\fn=\fn^c$ is an ideal
consists only of split primes 
and $\gamma\colon \fG_\fn^a\to \eo^\times$
is associated to the $p$-adic
of an algebraic Hecke character.
The following lemma ensures 
a sufficient supply of split primes $\fl$ such that 
$\ord_p(\epsilon(\Fr_\fl)-1)=\ord_p(q_\fl^{-1}-1)$
is much greater than 
$\ord_p(\gamma(\Fr_\fl)-1)$.

\subsection{Galois cohomology and Selmer groups}

Let $\I=\eo\llbracket \fG^a\rrbracket$
and let $\Psi\colon \Gal_\K\to \I^\times$
be the character that sends
$g\in \Gal_\K$ to $\psi(g)\langle g\rangle$
We write 
$\I^*=\Hom^{\cts}(\I, \Qp/\Zp)$
with $\I$-module structure with 
$a\cdot f(x)=f(xa)$.
We follow the formulation in 
\cite{Hsieh2010} and define 
the Selmer groups 
\begin{align*}
\Sel(\Psi,\Sigma)&=
\ker\big\{
H^1(\K^{S_\psi}/\K,\Psi\otimes \I^*)\to 
\prod_{w\in S_\psi\sqcup \Sigma^c_p}
H^1(I_w,\Psi\otimes \I^*)
\big\}\\
\Sel^{str}(\Psi,\Sigma)&=
\ker\big\{
H^1(\K^{S_\psi}/\K,\Psi\otimes \I^*)\to 
\prod_{w\in S_\psi}
H^1(I_w,\Psi\otimes \I^*)\times
\prod_{w\in \Sigma^c_p}
H^1(D_w,\Psi\otimes \I^*)
\big\}
\end{align*}
In fact, 
by \cite[Lem 2.7]{Hsieh2010}
we have
$H^1(I_w,\Psi\otimes \I^*)=0$
for $w\in S_\psi$.

Also, it is shown in 
by \cite[Thm 2.8]{Hsieh2010}
that 
$\Sel^{str}(\Psi, \Sigma)\sim \Sel(\Psi,\Sigma)$.
(at least if $\F\neq \Q$)
since
$H^1(D_w/I_w, (\Psi\otimes\I^*)^{I_w})$
is pseudo-null.
Therefore we focus on 
$\Sel^{str}(\Psi,\Sigma)$.




\cite[Lem 5.8]{Schneider2016}.

\subsection{Selmer groups}

We recall Ochiai's specialization principal 
introduced in \cite{Och05}
for detecting the characteristic ideal 
of a finitely generated torsion
$\Lda{n}_{\eo}$-module for
$\Lda{n}_{\eo}=\eo\llbracket X_1,\cdots, X_n\rrbracket$.

\begin{defn}\label{def:lin_elt}
A polynomial 
$\ell=a_0+a_1X_1+\cdots a_nX_n$
of degree at most 1
is called a linear element 
it is neither a unit
nor an element in $\fp\Lda{n}_{\eo}$.
In other word $a_0\in\fp$
and $a_i\in\eo^\times$
for some $1\leq i\leq n$.
Then 
\[
    \lin{n}_{\eo}\coloneqq\{(\ell)\subset \Lda{n}_{\eo}\mid\ell
    \text{ is a linear element in }\Lda{n}_{\eo}
\]
Moreover, if $n\geq 2$
and $M$ is a finitely generated torsion 
$\Lda{n}_{\eo}$-module, then 
$\lin{n}_{\eo}(M)$ denotes the subset of
$(\ell)\in \lin{n}_{\eo}$ satisfying the following conditions.
\begin{enumerate}
    \item The quotient $M/\ell M$ is 
    torsion over $\Lambda^{(n)}/(\ell)$.
    \item The image of the characteristic ideal
    $\car_{\Lda{n}_{\eo}}(M)\subset \Lda{n}_{\eo}$ in $\Lambda^{(n)}/(\ell)$
    is equal to $\car_{\Lda{n}_{\eo}/(\ell)}(M/\ell M)$.
\end{enumerate}
\end{defn}

We refer to \cite[Lem 3.5]{Och05}
for a discussion on the size of the complement
$\lin{n}_{\eo}\setminus \lin{n}_{\eo}(M)$.
Most importantly,
we have the following results
from \cite[Prop 3.6]{Och05}
and \cite[Prop 3.11]{Och05}.

\begin{prop}
Let $M$ and $N$ be finitely generated torsion 
$\Lda{n}_{\eo}$-modules.
\begin{enumerate}
\item If $n\geq 2$, the following statements are equivalent.
\begin{itemize}
    \item We have 
    $\car_{\Lda{n}_{\eo}}(M)\supset\car_{\Lda{n}_{\eo}}(N)$.
    \item There exists a complete discrete valuation ring
    $\eo'$ which is finite flat over $\eo$ such that
    \[
    \car_{\Lda{n}_{\eo'}}(M_{\eo'}/(\ell)M_{\eo'})\supset
    \car_{\Lda{n}_{\eo'}}(N_{\eo'}/(\ell)N_{\eo'})
    \]
    for all but finitely many
    $(\ell)\in \lin{n}_{\eo'}(M_{\eo'})\cap\lin{n}_{\eo'}(N_{\eo'})$.
    Here $M_{\eo'}\coloneqq M\otimes_{\eo}\eo'$ 
    and $N_{\eo'}\coloneqq N\otimes_{\eo}\eo'$.
\end{itemize}
\item If $n=1$, the following statements are equivalent.
\begin{itemize}
    \item There exists an integer $h\geq 0$ such that
    $\car_{\Lda{n}_{\eo}}(M)\supset(\varpi^h)\car_{\Lda{n}_{\eo}}(N)$.
    \item Let $\eo'$ be an arbitrary complete discrete valuation
    ring which is finite flat over $\eo$. 
    Then there exists a constant $c$ depending only on 
    $M_{\eo'}$ and $N_{\eo'}$ such that 
    \[
        \ell_{\eo'}(M_{\eo'}/(\ell)M_{\eo'})\leq
        \ell_{\eo'}(N_{\eo'}/(\ell)N_{\eo'})+c
    \]
    for all but finitely many $(\ell)\in \lin{n}_{\eo'}$.
    Here  $\ell_{\eo}(M)$ denotes the length of an $\eo$-modules $M$.
\end{itemize}
\end{enumerate}
    
\end{prop}

\begin{rem}
It is assumed in \cite{Och05} that
$\eo$ is the ring of integers
of a finite field extension over $\Qp$.
But the proofs also works when
$\eo$ is a complete discrete valuation ring 
with the residue field $\bar{\fF}_p$.
In particular the propositions hold in our case,
when $\eo$ is the ring of integers
of a finite field extension over $\widehat{\Q}_p^{un}$.
\end{rem}

After fixing a set of topological generators
for $\fG^a$, we identify 
$\I=\eo\llbracket\fG^a\rrbracket$
with $\Lda{n}_{\eo}$ for $n=[\F:\Q]$.
We note that if $\eo'$ is finite flat over $\eo$,
then for all characters
$\tilde{\alpha}\colon \fG^a\to (\eo')^\times$,
the kernel of the associated homomorphism
$\I_{\eo'}=\eo'\llbracket\fG^a\rrbracket\cong \Lda{n}_{\eo'}\to \eo'$
belongs to $\lin{n}_{\eo'}$.
Let $\mathcal{A}$ be a quotient of $\I$
isomorphic to $\Lda{m}_{\eo}$ for some integer $0\leq m\leq n$,
we similarly write $\mathcal{A}^*=\Hom^{\cts}(\mathcal{A},\Qp/\Zp)$
and let $X(\mathcal{A})$ denote the Pontryagin dual 
of the Selmer group
\[
\Sel(\mathcal{A})=
\ker\big\{
H^1(\Gal,\Psi^D\otimes \mathcal{A}^*)\to 
\prod_{w\in S_\psi}
H^1(I_w,\Psi^D\otimes \mathcal{A}^*)\times
\prod_{w\in \Sigma^c_p}
H^1(D_w,\Psi^D\otimes \mathcal{A}^*)
\big\}.
\]

\begin{lem}
Fix  $\mathcal{A}\cong \Lda{m}_{\eo}$
for  $\mathcal{A}$ as above.
Then for all but finitely many $(\ell)\in \lin{m}_{\eo'}$
there exists a natural homomorphism
of $\mathcal{A}/(\ell)$-modules
\[
    X(\mathcal{A})/(\ell)X(\mathcal{A})\to 
    X(\mathcal{A}/(\ell))
\]
such that the kernel and the cokernel of which 
are torsion $\mathcal{A}/(\ell)$-modules.

\end{lem}


\begin{proof}
The standard argument as in \cite[Prop 2.6]{Hsieh2010}
shows that applying the snake lemma to 
\[
\begin{tikzcd}
0 & 0\\
H^1(\Gal,\Psi^D\otimes \mathcal{A}^*)[\ell] \arrow[u]\arrow[r] &
\prod_{w\in S_\psi}
H^1(I_w,\Psi^D\otimes \mathcal{A}^*)[\ell]\times
\prod_{w\in\Sigma_p^c}
H^1(D_w,\Psi^D\otimes \mathcal{A}^*)[\ell] \arrow[u]\\
H^1(\Gal,\Psi^D\otimes \mathcal{A}^*[\ell]) \arrow[u]\arrow[r] &
\prod_{w\in S_\psi}
H^1(I_w,\Psi^D\otimes \mathcal{A}^*[\ell])\times
\prod_{w\in\Sigma_p^c}
H^1(D_w,\Psi^D\otimes \mathcal{A}^*[\ell]) \arrow[u]\\
\frac{H^0(\Gal,\Psi^D\otimes\mathcal{A}^*)}
{(\ell)H^0(\Gal,\Psi^D\otimes\mathcal{A}^*)}
\arrow[u]\arrow[r,"\vartheta"] &
\prod_{w\in S_\psi}
\frac{H^0(I_w,\Psi^D\otimes\mathcal{A}^*)}
{(\ell)H^0(I_w,\Psi^D\otimes\mathcal{A}^*)}\times
\prod_{w\in\Sigma_p^c}
\frac{H^0(D_w,\Psi^D\otimes\mathcal{A}^*)}
{(\ell)H^0(D_w,\Psi^D\otimes\mathcal{A}^*)} \arrow[u]\\
0\arrow[u] & 
0\arrow[u]
\end{tikzcd}
\]
gives the exact sequence
$0\to \ker(\vartheta)\to \Sel(\mathcal{A}/(\ell))
\to \Sel(\mathcal{A})[\ell] \to \coker(\vartheta)\to 0$
in which the Pontryagin dual of the middle map
is the desired natural homomorphism.

Note that the Pontryagin dual of $H^0(\Gal,\Psi^D\otimes\mathcal{A}^*)$
is $\mathcal{A}/(\Psi^D(\Gal)-1)$.
Thus the Pontryagin dual of the left hand side of $\vartheta$
is the submodule of $(\ell)$-torsion elements,
which is torsion over $\mathcal{A}/(\ell)$
if $(\ell)$ differs from some
nonzero $(\Psi^D(\gamma)-1)$.
Since a similar analysis is also true 
for the right hand side of $\vartheta$,
the lemma now follows from that the groups
$\Gal$, $\I_w$ for $w\in S_\psi$, and $D_w$ for $w\in\Sigma_p$
all act notrivially on $\mathcal{A}$ via $\Psi^D$
as the character $\epsilon\psi^{-1}$ is nontrivial on them.
\end{proof}



\begin{prop}
Suppose for all but finitely many characters
$\alpha\colon \fG^a\to (\eo')^\times$,
the Selmer group is bounded by 
$\ell_{\eo'}\Sel(\psi_\alpha^*,(\eo'))$ 
is bounded by $\alpha\colon \alpha(\mathcal{L})$.
Then 
\begin{enumerate}
\item The Selmer group $\Sel(\I)$ is a finitely generated
torsion $\I$-module.
\item After inverting $p$, the $p$-adic L-function
$\mathcal{L}$ belongs to the characteristic ideal
$\car_{\I}(\Sel(\I))$.
\end{enumerate}
\end{prop}


Finish the following steps
\begin{enumerate}
\item Show $\Sel(\I)$ is torsion
\item Pick $h$ such that 
$\ord_{(\varpi)}(\Sel(\I))=h$
and compare
$M=\Sel(\I)$ and $N=(\varpi)^h(\mathcal{L})$.
\item If $n=1$, base case shows that
$\car(M)\supset (\varpi)^{h'}\car(N)$
but by assumption can take $h'=0$.
\item If $n=2$, take 
$\ell\in \lin{n}_{\eo}(M)\cap \lin{n}_{\eo}(N)$
and avoid kernel and cokernel.
\end{enumerate}
Use the above to reduce everything to show base case.


\subsection{Base case}

Recall that $\eo$ is a complete discrete valuation ring
with field of fraction $E$ which is finite over $\widehat{\Q}_p^{un}$.
We fix an uniformizer $\varpi\in\eo$
and let $e$ be the ramification index,
so that $(p)=(\varpi)^e\subset \eo$.
We normalize the valuation function
$\val\colon E^\times/\eo^\times\to \Q$
so that $\val(p)=1$.
We note that $\val(E)\subset e^{-1}\Z/\Z$.

Suppose $\psi\colon \Gal_\K\to \eo^\times$
is an anticyclotomic character and assume that
\begin{enumerate}[label=($\psi$\alph*)]
\item The character $\psi$ has infinite order.
\label{cond:psi1}
\item The restriction of $\psi\bmod (\varpi)$ to
the inertia group $I_w$ for some $w\mid p$ is nontrivial.
\label{cond:psi2}
\end{enumerate}
In this subsection,
we modify the arguments in \cite{Rubin}
and give an upper bound for the size
of the Selmer group associated to 
$\epsilon\psi^{-1}$
assuming the existence of an Euler system
$z_\fs\in H^1(\K(\fs), \eo(\psi))$ that satisfies
the following properties.
\begin{enumerate}
    \item There existed a finite set $R$ of primes of $\K$,
    containing all places at which $\psi$ is ramified,
    such that each class $z_\fs(\sigma)$ is unramified 
    away $R$ and $p\fs$.
    \item For $w\in \Sigma_p\setminus\{w_0\}$,
    the restriction $res_{w}(z_\fs)$ is trivial.
    \item When $\ell=\fl\fl^c$ is a split prime write 
    $P_\ell(X)=(1-\psi(\Fr_\fl)q_\fl X)(1-\psi(\Fr_\fl)X)$, then
    \[
        \Cor_{\fs\ell}^\ell\colon
        H^1(\K(\fs\ell),\eo(\psi))\to
        H^1(\K(\fs),\eo(\psi))\quad
        z_{\fs\ell}\mapsto P_\ell(\Fr_\fl)\cdot z_\fs
    \]
    Note that the action of $\Fr_\fl\in \Gal_\K$
    on $z_\fs\in H^1(\K(\fs),\eo(\psi))$
    factors through $G(\fs)$.
\end{enumerate}
To simplify notations,
let $T=\eo(\psi), W=(E/\eo)(\psi)$,
and $W^*=(E/\eo)(\epsilon\psi^{-1})$.
If $M\in\eo$
we identify $T_M\coloneqq T/MT$ and $W_M\coloneqq W[M]$
via $M\colon T_M\cong W_M$.
Similarly we write $W^*_M=W^*[M]$.
We also let $\K(W_M)/\K$
denote the extension such that
the $\Gal_\K$-representation on the finite group $W_M$
factors through $Gal(\K(W_M)/\K)$.
The following lemma 
is modified from \cite[Lem 4.1.3]{Rubin}.

\begin{lem}\label{lem:estimate}
Suppose $\tau\in \Gal_{\K(\id)}$ is such that 
$M\colon=\psi(\tau)-1$ is a nonzero element in $(\varpi)$.
Let $\bar{M}\in\Z^+$
denote the smallest power of $p$
which is divisible by $M$ in $\eo$.
Then there exists infinitely many 
prime-to-$p$ split primes $\fl\neq\fl^c$
at which $\psi$ is unramified
such that 
\begin{itemize}
\item $\bar{M}^2\mid n_\ell\coloneqq \#H(\ell)$ for $\ell=\fl\fl^c$,
\item $M\equiv (1-\psi(\Fr_\fl))\mod M^2$.
\item $\fl$ splits completely in $\K(\id)$.
\end{itemize}
\end{lem}
\begin{proof}
Write $w_p=\#W_p$,
we claim that $\bar{M}^2\mid n_\ell$
if $\fl$ splits completely in 
$\K(\mu_{\bar{M}^2\cdot w_p})$.
Indeed this implies that 
$\bar{M}^2\cdot w_p\mid (q_\fl-1)=\#(\oo_\K/\fl)^\times$,
hence $\bar{M}^2\cdot w_p\mid \#\Delta_\fl$,
the maximal pro-$p$ quotient of $(\oo_\K/\fl)^\times$.
Thus $W_p$ acts faifully on $\Delta_\fl$
and $\bar{M}^2\mid n_\ell=\#\Delta_\fl/\#W_p$.

We then claim that 
the rest two conditions holds if
$\Fr_\fl$ is conjugate to $\tau$
in $Gal(\K(\id)\K(T_{M^2}/\K)$.
This is straightforward, 
since such $\Fr_\fl$ satisfies
$(1-\psi(\Fr_\fl))\equiv (1-\psi(\tau))=M\bmod M^2$
and the image of $\Fr_\fl$
in $Gal(\K(\id)/\K)$ would be trivial.

Since $\psi$ is anticyclotomic,
the extension $\K(\id)\K(T_{\varpi M})$
is linearly disjoint from 
$\K(\mu_{\bar{M}^2\cdot w_p})$
and there exists some $\bar{\tau}\in 
Gal(\K(\id)\K(W_{M^2})\K(\mu_{\bar{M}^2\cdot w_p})/\K)$
that is conjugate to $\tau$ in 
$Gal(\K(\id)\K(T_{\varpi M})/\K)$
and trivial in 
$Gal(\K(\mu_{\bar{M}^2\cdot w_p})/\K)$.
By Chebotarev's density,
there exists infinitely many prime-to-$p$
split primes $\fl$ such that
$\Fr_\fl$ is conjugate to $\bar{\tau}$ in
$Gal(\K(\id)\K(T_{\varpi M})\K(\mu_{\bar{M}^2\cdot w_p})/\K)$.
And by above such $\fl$ satisfies the conditions.
    
\end{proof}

\begin{defn}\label{def:RM}
For $\tau\in\Gal_{\K(\id)}$
and $M=\psi(\tau)-1\neq 0$ 
as in previous lemma, 
we let $\mathcal{R}_M$
denote the set of ideals $\fs=\ff\ff^c$
such that $\ff$ is a
square-free product of
split primes $\fl$ that satisfies the conditions
in previous lemma
and $\ff+\ff^c=\oo_\K$.
\end{defn}

\begin{defn}
When $\ell=\fl\fl^c$ is a split prime,
let $\sigma_\ell$
be a generator of the cyclic group
$H(\ell)$ and put 
$D_\ell=\sum_{i=0}^{n_\ell-1}i\cdot \sigma_\ell^i
\in \Z[H(\ell)]$
where $n_\ell\coloneqq\#H(\ell)$.
In general, 
if $\fs=\ff\ff^c$
and $\ff=\prod_{i=1}^r\ell_i$, we put
\[
    D_\fs=\prod_{i=1}^r D_{\ell_i}\in 
    Gal(\K(\fs)/\K(\id))\cong 
    H(\ell_1)\times\cdots\times H(\ell_r).
\]
\end{defn}


\begin{lem}
For $M$ and $\mathcal{R}_M$ as in Defintion \ref{def:RM}
and $\fs=\ell_1\cdots\ell_r\in \mathcal{R}_M$, we have
$D_{\fs}z_{\fs}\bmod M^2\in 
H^1(\K(\fs),T_{M^2})^{\K(\id)}$.
Consequently
$\Nr_{\K(\id)/\K}D_\fs z_\fs\bmod M^2\in
H^1(\K(\fc),T_{M^2})^{\K}$.
\end{lem}
\begin{proof}
The claim is trivial when $r=0$
and $z_{\fs}=z_\id\in H^1(\K(\id),T)$.
Suppose inductively the claim holds for $z_\fs$.
For $z_{\fs\ell}$ with $\ell=\fl\fl^c$ and $\fl\in \mathcal{R}_M$
it follows from 
$(\sigma_\ell-1)D_\ell=n_\ell-\Nr_{\K(\ell)/\K(\id)}$
that
\[
	 (\sigma_\ell-1)D_{\fs\ell}z_{\fs\ell}\equiv
	 -\Cor_{\fs\ell}^{\ell}D_{\fs}z_{\fs\ell}=
	 -P_\ell(\Fr_{\fl})D_{\fs}z_{\fs} \equiv
	 -P_\ell(1)D_{\fs}z_{\fs}\mod M^2.
\]
Here the first equality follows from $M^2\mid n_\ell$,
the second follows by induction 
as $\Fr_\fl$ is trivial on $\K(\id)$,
and the last follows from 
$P_\ell(1)=(1-q_\fl\psi(\Fr_\fl))(1-\psi(\Fr_\fl))
\equiv (1-\psi(\Fr_\fl))^2 \equiv 0\mod M^2$.
\end{proof}

Observe that since $K(\fs)$ is 
unramified at all places above $p$,
the assumption \eqref{cond:psi2}
implies that $T_{M^2}^{K(\fs)}=0$.
Consequently it follows from the long exact sequence below
that $H^1(\K, T_{M^2})\cong H^1(\K(\fs), T_{M^2})^{\K}$.
\[
	0\to H^1(\K(\fs)/\K, T_{M^2}^{\K(\fs)})\to
	H^1(\K, T_{M^2})\to
	H^1(\K(\fs), T_{M^2})^{\K}\to
	H^2(\K(\fs)/\K, T_{M^2}^{\K(\fs)})
\]

\begin{defn}
For $M$ and $\fs\in\mathcal{R}_M$ as above
we identify $W_M$ and $T_M$ and
define the Kolyvagin derivative 
$\kappa_{\fc,M}\in H^1(\K,W_{M^2})\cong H^1(\K,T_{M^2})$
to be the preimage of 
$\Nr_{\K(\id)/\K}D_{\fs}z_{\fs} \bmod M^2\in 
H^1(\K(\fs), T_{M^2})^{\K}$
under 
$H^1(\K, T_{M^2})\cong H^1(\K(\fs), T_{M^2})^{\K}$.
\end{defn}

For a finite place $w$ that is prime to $p$,
let $H^1_f(\K_\fl,W_{M^2})$ and
$H^1_s(\K_\fl,W_{M^2})$ 
be the subquotients of 
$H^1(\K_w,W_{M^2})= H^1(D_w,W_{M^2})$
defined in \cite[Def 1.3.4]{Rubin}.
Here we only recall that there exists an exact sequence
\[
    0\to H^1_f(\K_w,W)\to H^1(\K_w,W)\to H^1_s(\K_w,W)\to 0
\]
and that $H^1_f(\K_\fl,W_{M^2})$ and
$H^1_s(\K_\fl,W_{M^2})$ 
coincides respectively with the kernel and image
of the natural restriction map
$H^1(D_w, W_{M^2})\to H^1(I_w, W_{M^2})$
when $\psi$ is unramified at $w$.



\begin{prop}
For $M$ and $\fs\in \mathcal{R}_M$ as above,
there exists an integer $m$
independent of $M$ such that 
$res_w(m\cdot z_{\fs,M})\in H^1_f(\K_w,W_{M^2})$
for any finite place $w$ that is prime to $p\fs$.
\end{prop}

\begin{proof}

Since $z_\fs\in H^1(\K(\fs),T)$
is unramified at $w\notin R$
we have $res_w(\kappa_{\fs,M})\in
H^1_{un}(\K_w,W_{M^2})=H^1_f(\K_w,W_{M^2})$
if $\psi$ is unramified at $w$
(see \cite[Lem 1.3.8(ii)]{Rubin}).
If $w\in R$ is a split place,
then the image of $D_w$ in $\fG_{\fs}^a$
is infinite and the existence of an $m_w$ such that
$res_w(m_w\cdot \kappa_{\fs,M})\in
H^1_f(\K_w,W_{M^2}))$
follows from the argument of 
\cite[Cor 4.6.5]{Rubin}.

If $w\in R$ is non-split,
then by assumption $\psi$ is unramified at $w$
and $H^1_s(\K_w,W_{M^2})\cong \Hom(I_w, W_{M^2})^{\Fr_w=1}$
by \cite[Lem 1.3.2(ii)]{Rubin}.
Since any such  homomorphism
factors through the maximal pro-$p$
quotient $\Delta_w$ of $(\oo_K/\fq_w)^\times$
we have $res_w(m_w\cdot \kappa_{\fs,M})\in
H^1_f(\K_w,W_{M^2}))$
if we take $m_w=\# \Delta_w$.
The  statement now follows if we take
$m$ to be the greatest common divisor of $m_w$
for the finitely many places $w$ in $R$.

\end{proof}

We now introduce the finite-singular comparison map
between 
$H^1_f(\K_\fl,W_{M^2})$ and
$H^1_s(\K_\fl,W_{M^2})$ 
when $\fl$ is a prime that satisfies the condition
in Lemma \ref{lem:estimate}.
Recall that by \cite[Lem 1.4.7]{Rubin}
there exists the isomorphisms
\begin{align}
\alpha_\fl&\colon
H^1_s(\K_\fl,T_{M^2})\to T_{M^2}^{\Fr_\fl=1}\quad
[\kappa]\mapsto \kappa(\sigma_\fl)
\label{eq:singular} \\
\beta_\fl&\colon 
H^1_f(\K_\fl,T_{M^2})\to T_{M^2}/(\Fr_\fl-1)T_{M^2}\quad
[\kappa]\mapsto \kappa(\Fr_\fl)
\label{eq:finite}
\end{align}
Note that the lemma applies 
as $\bar{M}^2\mid (\fq_\fl-1)=\#(\oo_K/\fl)^\times$
and hence $\mu_{\bar{M}^2}\subset \K_\fl^\times$.

\begin{defn}\label{def:finite_singular}
For $\fl$ satisfying Lemma \ref{lem:estimate} and $\ell=\fl\fl^c$
we define $Q_\ell(X)$ by
$P_\ell(X)=(1-X)Q_\ell(X)+P_\ell(1)$
and define the finite-singular comparison map
$\phi_\fl^{fs}$ by the commutative diagram
\[
	\begin{tikzcd}
		H^1_s(\K_\fl, T_{M^2}) \arrow[r,"\alpha_\fl"]&
		T_{M^2}^{\Fr_\fl=1} \arrow[r,"\sim"]&
        (M)/(M)^2\\
		H^1_{f}(\K_\fl, T_{M^2}) \arrow[r,"\beta_\fl"]
		\arrow[u,"\phi_\fl^{fs}"]&
		T_{M^2}/(\Fr_\fl-1)T_{M^2}
		\arrow[u,"Q_\ell(1)",swap]\arrow[r,"\sim"]&
        \eo/(M)
	\end{tikzcd}
\]
As $Q_\ell(X)=(\psi(\Fr_\fl)+q_\fl\psi(\Fr_\fl)-q_\fl\psi^2(\Fr_\fl))-
q_\fl\psi^2(\Fr_\fl)X$
and $M^2\mid q_\fl-1$, we have
$Q_\ell(1)\equiv 2\psi(\Fr_\fl)(1-\psi(\Fr_\fl))\bmod M^2$.
Therefore $Q_\ell(1)\in (M)\setminus (\varpi M)$
and $\phi_\fl^{\fs}$ is an isomorphism.
\end{defn}





\begin{prop}

For $\fl$ as above and $\ell=\fl\fl^c$
consider the Kolyvagin derivatives
$\kappa_{\fs,M}, \kappa_{\fs\ell,M}\in H^1(\K, W_{M^2})$.
Let $m$ be as in the previous proposition
so that $res_\fl(m\cdot \kappa_{\fs\ell,M})\in H^1_f(\K_\fl,W_{M^2})$
and we can apply $\phi_\fl^{fs}$ on which.
Then    
$\phi_\fl^{fs}(res_{\fl}(m\cdot \kappa_{\fs,M}))=
res_\fl(m\cdot \kappa_{\fs\ell,M})$.
\end{prop}

\begin{proof}

Let $\tilde{T}=\text{Map}^{\cts}(\Gal_\K,T)$
be the set of continuous map from $\Gal_\K$ to $T$
and let $g\in\Gal_\K$ acts on $f\in\tilde{T}$
by $(g\cdot f)(x)=f(xg)$.
Consider the long exact sequence 
of $\K(\fs)$-cohomologies
associated to the exact $\Gal_\K$-module
$0\to T\to \tilde{T}\to \tilde{T}/T\to 0$
where $T\to \tilde{T}$ is the map
$t\mapsto [x\mapsto x\cdot t]$.
Since $T^{\K(\fs)}=0$ by \ref{cond:psi2},
Shapiro's lemma implies that 
we have the short exact sequence of $G(\fs)$-modules
\[
	0\to\tilde{T}^{\K(\fs)}\to (\tilde{T}/T)^{\K(\fs)}\to 
	H^1(\K(\fs),T)\to 0
\]
Thus for each of the class $z_\fs\in H^1(\K(\fs),T)$
we can pick 
$\hat{z}_\fs\in \tilde{T}$,
unique up to $\tilde{T}^{\K(\fs)}$,
such that  $(\hat{z}_\fs\bmod T)\in (\tilde{T}/T)^{\K(\fs)}$,
and $z_\fs(g)=(g-1)\cdot \hat{z}_\fs$.
We claim that we can pick $\hat{z}_\fs$
and $\hat{z}_{\fs\ell}$ such that 
$\Nr_{\K(\ell)/\K(\id)}\hat{z}_{\fs\ell}-P_\ell(\Fr_\fl)
\hat{z}_{\fc}\in M^2\tilde{T}$.
The proposition would then follows from 
\begin{align*}
	&D_{\fs\ell}z_{\fs\ell}(\sigma_\ell)=
	(\sigma_\ell-1)D_{\fs\ell}\hat{z}_{\fs\ell}
	\equiv-P_\ell(\Fr_{\flw}) D_\fs \hat{z}_\fs \mod M^2\\
	Q_\ell(\Fr_\fl)\cdot
	&D_\fs z_\fs(\Fr_\fl)=
	Q_\ell(\Fr_{\flw})(\Fr_{\flw}-1)
	\cdot D_\fs \hat{z}_\fs
	\equiv-P_\ell(\Fr_{\flw}) D_\fs \hat{z}_\fs \mod M^2
\end{align*}

To prove the claim,
pick $k>0$ such that 
$\Fr_\fl^k$ acts trivially on $T_{M^2}$.
Since $\Fr_\fl$ has infinite order
in $\fG_{\fs}^a$,
there exists  $w\mid p$ and  $a>0$
such that $\bar{M}^2$ divides $N$,
the order of $\Fr_\fl^k$ in $H(w^a)$.
Pick any lift 
$\hat{z}_{\fs\ell w^a}$ and 
$\hat{z}_{\fs w^a}$  for
$z_{\fs\ell w^a}$ and 
$z_{\fs w^a}$.
And observe that 
\[
	\Nr_{\K(\ell)/\K(\id)}
	\hat{z}_{\fs\ell w^a}-P_\ell(\Fr_\fl)
	\hat{z}_{\fs w^a}\in T+\tilde{T}^{\K(\fs w^a)}.
\]
Moreover, since
$\Nr_{\K(\ell)/\K(\id)}\colon\tilde{T}^{\K(\fs\ell w^a)}\to
\tilde{T}^{\fs w^a}$  is surjective,
we can pick the lifts so that the difference
above actually lies in $T$.
Take
$\hat{z}_{\fc\ell}=\Nr_{\K(w^a)/\K(\id)}
\hat{z}_{\fs\ell w^a}$ and
$\hat{z}_{\fs}=\Nr_{\K(w^a)/\K(\id)}\hat{z}_{\fs w^a}$
as the lifts of $z_{\fs\ell}$ and $z_{\fs}$.
Since
\[
	\Nr_{\K(w^a)/\K(\id)}t=
	\sum_{H(w^a)/\langle \Fr_\ell^k\rangle}g\,
	\sum_{i=1}^{N}(\Fr_\fl^k)^i\cdot  t \equiv
	\sum_{H(w^a)/\langle \Fr_\ell^k\rangle}g\cdot
    Nt\equiv 0
	\mod M^2T\quad
	\text{ for } t\in T
\]
we have 
$\Nr_{\K(\ell)/\K(\id)}\hat{z}_{\fs\ell}-P_\ell(\Fr_\fl)
\hat{z}_{\fs}\in \Nr_{\K(w^a)/\K(\id)}T\subset M^2\tilde{T}$.
\end{proof}

\begin{rem}
The author learned the above argument 
from Gyujin Oh's notes on 
Skinner's lecture on Euler systems in 2022.
\end{rem}

\begin{lem}\label{lem:vanish}
    Let $\Omega/\K$ be the infinite abelian extension
    which is the product of the fields
    $\K(\id), \K(W)$, and $\K(\mu_{p^\infty})$.
    Then under the assumption \ref{cond:psi2} both 
    $H^1(\Omega/\K, W)$ and $H^1(\Omega/\K, W^*)$ 
	are trivial.
\end{lem}
\begin{proof}
    Write $L=\K(W_{\varpi})$ and let $\Delta=Gal(L/\K)$.
    Then $\Delta$ acts faifully on $W_{\varpi}$
    by the units in the residue field of $\eo$
    and hence $p\neq \#\Delta$.
    Thus $H^i(\Delta, W_\varpi^L)=0$ and we have
	\[
		H^1(\Omega/\K,W_{\varpi})\cong
		H^1(\Omega/L,W_{\varpi})=
		\Hom(Gal(\Omega/L),W_{\varpi})^\Delta=
		\Hom(Gal(\Omega/L),W_{\varpi}^\Delta)=0
	\]
    where the second equality follows from that
    the conjugation action of $\Delta$ 
    is trivial on the abelian group $Gal(\Omega/L)$
    and the last comes from 
    $W_{\varpi}^\K=0$ by \ref{cond:psi2}.
    This implies that the cohomology group 
    $H^1(\Omega,W)$
	has no nontrivial $\varpi$-torsion
    by considering the long exact sequence associated to
	$0\to W_\varpi\to W\xrightarrow{\varpi}W\to 0$,
    which implies that $H^1(\Omega,W)=0$.
	The same argument also works for $H^1(\Omega,W^*)$.
\end{proof}


\begin{lem}
Fix $M$ and $\mathcal{R}_M$ as in Definition \ref{def:RM}.
Let  $C=\{\eta_1,\cdots,\eta_k\}$
be a finite subset of elements in $H^1(\K,W_{M^2}^*)$.
Then there exists a finite set of primes
$\{\fl_1,\cdots,\fl_k\}$ satisfying the condition in 
Lemma \ref{lem:estimate}
such that if we write $\ell_i=\fl_i\fl_i^c$
and $\fs_i=\prod_{j=1}^i\ell_i\in \mathcal{R}_M$
(with $\fs_0=\oo_\K$), then we have
\begin{itemize}
\item For $1\leq i\leq k$,
$\textnormal{ord}( res_{\fl_i}(m\cdot \kappa_{\fs_{i-1},M},
H^1_f(\K_{\fl_i}, W_{M^2}))\geq
\textnormal{ord}( m\cdot \kappa_{\fs_{i-1},M}, H^1(\Omega,W_{M^2}))$
\item For any $\eta\in C$ and $\fl_i$
we have $(\eta)_{\fl_i}\in H^1_f(\K_{\fl_i},W_{M^2}^*)$
\item For any $\eta\in C$,
if $(\eta)_{\fl_i}=0$ for all $1\leq i\leq k$ then $\eta=0$.
\end{itemize}

\end{lem}

\begin{proof}
Let $L=\K(\id)\K(W_{M^2})\K(\mu_{\bar{M}^2\cdot w_p})$
and $\bar{\tau}\in Gal(L/\K)$ be as in the proof of Lemma \ref{lem:estimate}.
Then $\Gal_L$ acts trivially on $W_{M^2}$ and $W_{M^2}^*$.
To find $\fl_1$, we apply \cite[Lem 5.2.1]{Rubin}
to $\kappa_1\coloneqq m\cdot \kappa_{\id,M}\in H^1(\K,W_{M^2})$ and
$\eta_{1}\in H^1(\K,W_{M^2}^*)$, which gives 
an element $\gamma\in \Gal_L$ such that 
\begin{align*}
	\ord(\kappa_1(\gamma\bar{\tau}),W_{M^2}/(\bar{\tau}-1)W_{M^2})&\geq
	\ord( (\kappa_1)_L, H^1(L,W_{M^2}) )\\
	\ord(\eta_1(\gamma\bar{\tau}),W_{M^2}^*/(\bar{\tau}-1)W_{M^2}^*)&\geq
	\ord( (\eta_1)_L, H^1(L,W_{M^2}^*) ) 
\end{align*}
Let $L'=\ker(\kappa_1)_L\cap \ker(\eta_1)_L$
and pick $\fl_1$ such that 
$\eta_1\in H^1_f(\K_{\fl_1}, W_{M^2}^*)$ and
$\Fr_{\fl_i}$ is conjugate to 
$\gamma\bar{\tau}$ in $Gal(L'/\K)$.
Then  $\Fr_{\fl_i}$ is conjugate to 
$\bar{\tau}$ in $Gal(L/\K)$,
and hence $\ell_1\coloneqq \fl_1\fl_1^c\in \mathcal{R}_M$ 
by Lemma \ref{lem:estimate}
and moreover applying the map $\beta_{\fl_1}$ in \eqref{eq:finite} gives
\begin{align*}
	\ord( (\kappa_1)_{\fl_1}, H^1_f(\K_{\fl_1},W_{M^2}))=
	\ord(\kappa_1(\gamma\bar{\tau}),W_{M^2}/(\bar{\tau}-1)W_{M^2})&\geq
	\ord( (\kappa_1)_L, H^1(L,W_{M^2}) )\\
	\ord( (\eta_1)_{\fl_1}, H^1_f(\K_{\fl_1},W_{M^2}^*))=
	\ord(\eta_1(\gamma\bar{\tau}),W_{M^2}^*/(\bar{\tau}-1)W_{M^2}^*)&\geq
	\ord( (\eta_1)_L, H^1(L,W_{M^2}^*) ) 
\end{align*}
We now set $\kappa_2=m\cdot \kappa_{\fs_1,M}$
and apply the same procedure on $\kappa_2$ and $\eta_2$
to find $\fl_2$ with
$\ell_2\coloneqq \fl_2\fl_2^c\in \mathcal{R}_M$ 
such that similar inequalities as above hold
and iterate the process to find 
the set $\{\fl_1,\cdots,\fl_k\}$.

Now the first claim is clear since $L\subset \Omega$
the second follows by construction,
and suppose $\eta=\eta_i$ satisfies
the assumption in the last claim,
then in particular $(\eta_i)_{\fl_i}=0$.
By the above inequalities this implies that
$\eta\in H^1(L/\K, W_{M^2}^*)\subset H^1(\Omega/\K, W_{M^2}^*)$,
which vanish be Lemma \ref{lem:vanish}.

\end{proof}


Now, for any $M\in \eo$ we consider the exact sequence
\[
    0\to \Sel^{p}(\K, W_M)\to
    \Sel^{p\cup \Sigma}(\K, W_M)\xrightarrow{\loc_{\Sigma,M}}
    \oplus_{w\in \Sigma}
    H^1_s(\K_w, W_M)
\]
The following lemma can be proved 
in the same way as \cite[Lem 5.2.5]{Rubin}.
\begin{lem}
For $\Sigma=\{\fl_1,\fl_1^c,\cdots, \fl_k,\fl_k^c\}$
as in previous lemma
and suppose $\fm=\varpi^n\in \eo$
is such that $\ord_p(M)\geq n+\ind_{\eo}(z_{\id})$
for the base class $z_{\id}\in H^1(\K,T)$, then 
\[
    \ell_{\eo}(\coker(\loc_{\Sigma,\fm}))\leq 
    \ind_{\eo}(z_\id).
\]
\end{lem}


The following is 
\cite[Thm 2,2,2]{Rubin} and
\cite[Thm 2,2,10]{Rubin}
\begin{thm}
$\ell_{\eo}(\Sel_{\Sigma_p}(\K, W^*))\leq \ind_{\eo}(z_{\id})$.
and $\ell_{\eo}(\Sel(\K, W^*))\leq \ell_{\eo}(H^1(\Qp,T)/(z_{\id}))$
\end{thm}


\begin{lem}
    $H^1_s(\K_{w_0},T)=H^1(\Qp,T)\cong \Lambda$
\end{lem}




\subsection{machinery}

Let $\mathscr{V}\colon \Lambda^a\to \Lambda$
be as in \cite{HT94}.
Our $L$-function is
\[
L(1,\chi^{-2}\tilde{\eta})\prod_{w\in\Sigma}
(1-\chi^{-2}\tilde{\eta}(\bw))
(1-\chi^{-2}\tilde{\eta}(\bw)q_w^{-1})
\]
Let $\psi=\epsilon\hat{\chi}_0^{-2}$ be associated to 
$\chi^{-2}$, which is of type $\Sigma-\Sigma^c$
Then above is 
\[
	L(0,\epsilon\psi)\prod_{w\in \Sigma}
	(1-(\epsilon\psi)^*(\Fr_{\bw}q_w^{-1})
	(1-\epsilon\psi(\Fr_{\bw})
\]
Here  $\lambda^*\coloneqq \lambda^{-c}\epsilon$ 
and $(\epsilon\psi)^*=\psi$ since  $\psi$
is anticyclotomic.
In fact, should view above as
\[
	L(0,\epsilon\psi^{-1})\prod_{w\in\Sigma^c}
	(1-(\epsilon\psi^{-1})^*(\Fr_{\bw}q_w^{-1})
	(1-\epsilon\psi^{-1}(\Fr_{\bw})
\]
Let $\Psi=\psi\langle\rangle$
then this  $L$-function
should be $L(\Psi^D,\Sigma^c)=L(\Psi,\Sigma)$
by functional equation.
The Euler system we constructed vanishes at  $\Sigma^c$,
thus the Selmer group of  $X(\Psi^D,\Sigma^c)$
is bounded. 


\cite{Och05}
\cite{Och08}
\cite{Hsieh2010}
\cite{HT93}
\cite{Hida06}
\cite{Hida06b}
\cite{Rubin}


\appendix

\begin{equation*}
    (\id\otimes\phi^\ell_{\fs\ell})(\euF_{\fs\ell})=
	(1-\hat{\chi}_\circ(\Fr_\fl)\cdot 
	\langle \Fr_\fl\rangle^{-1} V_\fl)
	\euF_{\fs}.
\end{equation*}


\begin{prop}\label{prop:pair_at_deff_level}
	With notations above we have the following
	relation between $B_{\fn}$
	and $B_{\fn\ell}^\ell$.
	\begin{align*}
	%&B_{\fn}(T_{w}^{(1)}\cdot\euF_1,\euF_2)=
	%B_{\fn}(\euF_1,T_{w}^{(1)}\cdot\euF_2)\\
	&B_{\fn\ell}^{\ell}(\euF_1,\euF_2)=
	B_{\fn}(\euF_1,T_{\fl}^{(1)}\cdot \euF_2)\\
	&B_{\fn\ell}^{\ell}(\euF_1,V_{\fl}\cdot\euF_2)=
	(q_\ell+1) B_{\fn}(\euF_1,
	T_{\fl}^{(2)}\cdot\euF_2)\\
	&B_{\fn\ell}^\ell
	(V_{\fl}\cdot \euF_1,V_{\fl}\cdot\euF_2)=
	B_{\fn} (T_{\fl}^{(1)}\cdot\euF_1,
	T_{\fl}^{(2)}\cdot \euF_2)
	\end{align*}
\end{prop}
\begin{proof}
	By definition,
	the pairing $B_{\fn\ell}^\ell$
	and $B_{\fn}$ are defined by 
	interpolating the pairings 
	on modular forms
	$f_1,f_2\in S^{\ord}(K_0(\fn p^n),\oo)$
	given by 
	\[
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn\ell p^n)}
	f_1(g)f_2(\bar{g}\tau_{\fs\ell}^n)\text{ and }\quad
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)}
	f_1(g)f_2(\bar{g}\tau_{\fs}^n)
	\]
	Here $\tau_{\fs}$ is the product 
	$\tau_\fl\coloneqq
	\iota_{\fl}^{-1}(\smat{\varpi_\fl&\\&1})$
	for $\fl\mid \fs$
	and  $\tau_{\fs}^n$ is the product
	of $\tau_{\fs}$ and 
	$\iota_{w}^{-1}(\smat{\varpi_w^n&\\&1})$
	for all $w\in \Sigma_p$.
	Identify $G(\F_\ell)$ with  $\GL_2(\K_\fl)$
	via  $\iota_\fl$, and 
	write $K_\ell=\GL_2(\oo_\fl)$, we see that 
	\begin{multline*}
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn\ell p^n)}
	f_1(g)f_2(\bar{g}\tau_{\fs\ell}^n)=
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)}
	\sum_{k\in K_\ell/K_0(\ell)}
	f_1(gk)f_2(\bar{g}\bar{k}\tau_{\fs\ell}^n)\\=
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)} f_1(g)
	\sum_{k\in K_\ell/K_0(\ell)}
	f_2(\bar{g}\bar{k}\smat{1&\\&\varpi_\fl}
	\tau_{\fs}^n)=
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)} f_1(g)
	(T_\fl^{(1)}f_2)(\bar{g}\tau_{\fs}^n).
	\end{multline*}
	%That the pairing is symmetric 
	%follows from that 
	%$g\mapsto \bar{g}\smat{\varpi_\fl&\\&1}$
	%is an involution on 
	%$G(\F)\backslash G(\A_f)/K^n_0(\fn)$.
	%Now, we identify
	%$G(\F_\ell)$ and  $\GL_2(\oo_\fl)$
	%via  $\iota_{\fl}$, then
	%\begin{multline*}
	%B_{\fn}(T_{\fl}^{(1)}f_1, f_2)=
	%\sum_{G(\F)\backslash G(\A_f)/K^n_0(\fn)}
	%\left[\sum_b f_1(g\smat{\varpi_\fl&b\\&1})
	%+f_1(g\smat{1&\\&\varpi_\fl}) \right]
	%f_2(\bar{g}\tau_{\fs}(n))\\=
	%\sum_{G(\F)\backslash G(\A_f)/K^n_0(\fn)K^0(\ell)}
	%f_1(g\smat{\varpi_\fl&\\&1})
	%f_2(\bar{g}\tau_{\fs}(n))=
	%\sum_{G(\F)\backslash G(\A_f)/K^n_0(\fn)K^0(\ell)}
	%f_1(\bar{g}\tau_{\fs}(n))
	%f_2(g\smat{\varpi_\fl&\\&1})\\=
	%B_{\fn}(T_\fl^{(1)}\cdot f_2, f_1)=
	%B_{\fn}(f_1, T_\fl^{(1)}\cdot f_2)
	%\end{multline*}
	%The third equality follow from 
	%that $g\mapsto 
	%\bar{g}\smat{\varpi_\fl^{-1}&\\&1}\tau_\fs(n)$
	%is an involution on the underlying set.
	And the first equality follows.
	For the second equality, we have
	\begin{multline*}
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn\ell p^n)}
	f_1(g)(V_\fl f_2)(\bar{g}\tau_{\ell\fs}^n)=
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)}
	\sum_{k\in K_\ell/K_0(\ell)}
	f_1(gk)(V_\fl f_2)(\bar{g}\bar{k}\tau_{\ell\fs}^n)\\=
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)}
	f_1(g)\sum_{k\in K_\ell/K_0(\ell)}
	f_2(\bar{g}\bar{k}\smat{\varpi_\fl&\\&\varpi_\fl}
	\tau_{\fs}^n)=
	(q_\fl+1)
	\sum_{G(\F)\backslash G(\A_f)/K_0(\fn p^n)} f_1(g)
	(T_\fl^{(2)}f_2)(\bar{g}\tau_{\fs}^n)
	\end{multline*}
	The last equation follows similarly
	from the above computaiton.
\end{proof}



\bibliographystyle{amsalpha}
\bibliography{biblio}
\end{document}
